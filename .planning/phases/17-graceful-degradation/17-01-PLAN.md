---
phase: 17-graceful-degradation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-yjs-provider.ts
  - src/hooks/use-document-collaboration.ts
  - src/hooks/use-diagram-collaboration.ts
  - convex/snapshots.ts
  - src/pages/App/Document/ConnectionStatus.tsx
autonomous: true

must_haves:
  truths:
    - "When PartyKit is unreachable, document editor loads content from IndexedDB and remains editable"
    - "When PartyKit is unreachable on cold start (no IndexedDB), document loads Convex snapshot in read-only mode"
    - "Connection status indicator shows green dot when connected and cloud-off icon when offline"
    - "IndexedDB persistence is initialized independently of PartyKit provider connection"
  artifacts:
    - path: "src/hooks/use-yjs-provider.ts"
      provides: "Timeout-based fallback with offline state tracking"
      contains: "CONNECTION_TIMEOUT"
    - path: "src/hooks/use-document-collaboration.ts"
      provides: "IndexedDB-first loading independent of provider"
      contains: "IndexeddbPersistence"
    - path: "src/hooks/use-diagram-collaboration.ts"
      provides: "IndexedDB-first loading independent of provider"
      contains: "IndexeddbPersistence"
    - path: "convex/snapshots.ts"
      provides: "Public query for client-side snapshot URL retrieval"
      exports: ["getSnapshotUrl"]
    - path: "src/pages/App/Document/ConnectionStatus.tsx"
      provides: "Two-state always-visible connection indicator"
      contains: "CloudOff"
  key_links:
    - from: "src/hooks/use-yjs-provider.ts"
      to: "y-partykit/provider"
      via: "4-second timeout on initial connection"
      pattern: "setTimeout.*CONNECTION_TIMEOUT"
    - from: "src/hooks/use-document-collaboration.ts"
      to: "y-indexeddb"
      via: "IndexedDB init before provider (decoupled)"
      pattern: "new IndexeddbPersistence"
    - from: "convex/snapshots.ts"
      to: "convex/schema.ts"
      via: "yjsSnapshotId field lookup"
      pattern: "getSnapshotUrl"
---

<objective>
Build the core offline infrastructure: timeout-based connection fallback, IndexedDB-first loading decoupled from the PartyKit provider, Convex snapshot retrieval for cold starts, and updated connection status indicator.

Purpose: This enables editors to remain functional when PartyKit is unavailable by loading from IndexedDB (with full editing) or Convex snapshots (read-only), with clear visual indication of connection state.

Output: Modified hooks (useYjsProvider, useDocumentCollaboration, useDiagramCollaboration), new Convex public query (getSnapshotUrl), and redesigned ConnectionStatus component.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-graceful-degradation/17-CONTEXT.md
@.planning/phases/15-persistence-layer/15-01-SUMMARY.md
@.planning/phases/16-auth-resilience/16-01-SUMMARY.md

Key source files to read before implementing:
@src/hooks/use-yjs-provider.ts
@src/hooks/use-document-collaboration.ts
@src/hooks/use-diagram-collaboration.ts
@convex/snapshots.ts
@src/pages/App/Document/ConnectionStatus.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout-based fallback to useYjsProvider and decouple IndexedDB from provider in collaboration hooks</name>
  <files>
    src/hooks/use-yjs-provider.ts
    src/hooks/use-document-collaboration.ts
    src/hooks/use-diagram-collaboration.ts
  </files>
  <action>
**useYjsProvider changes (src/hooks/use-yjs-provider.ts):**

1. Add a `CONNECTION_TIMEOUT = 4000` constant (4 seconds, within the 3-5s user decision range).

2. Add a new state: `isOffline` (boolean, default false). This tracks whether the connection attempt timed out.

3. After creating the YPartyKitProvider in the `connect()` function, start a timeout. If `isConnected` is still false after `CONNECTION_TIMEOUT` milliseconds, set `isOffline = true` and set `isLoading = false`. This allows downstream consumers to render with IndexedDB data.

4. When a `sync` event fires with `synced=true` (connection succeeds), clear the timeout, set `isOffline = false`, and set `isLoading = false`.

5. When a `status` event fires with `status === "connected"`, clear `isOffline = false`.

6. Return `isOffline` from the hook alongside existing returns: `{ yDoc, provider, isConnected, isLoading, isOffline }`.

7. IMPORTANT: Keep creating the provider even when timeout fires — y-partykit will continue reconnecting in background. The timeout only gates the UI loading state, not the connection attempt.

**useDocumentCollaboration changes (src/hooks/use-document-collaboration.ts):**

1. Decouple IndexedDB persistence from provider. Currently IndexedDB is only set up when `provider` is truthy (`if (!provider) return;`). Change this to initialize IndexedDB persistence based on `yDoc` and `documentId` directly, independent of provider. The IndexedDB persistence just needs the Y.Doc — it does not need the provider.

2. Move the IndexedDB `useEffect` to depend on `[documentId, resourceType, yDoc]` instead of `[provider, documentId, resourceType, yDoc]`. Remove the `if (!provider) return;` guard.

3. Accept `isOffline` from `useYjsProvider` (destructure it from the hook call).

4. Change the loading logic: `isLoading = providerLoading && !indexedDbSynced`. Previously it was `providerLoading || !indexedDbSynced` — now we consider loaded if EITHER the provider syncs OR IndexedDB syncs. This means when IndexedDB syncs first (offline case), loading completes even without provider.

5. Change editor return: currently `editor: provider ? editor : null`. Change to `editor: (provider || indexedDbSynced) ? editor : null`. This allows the editor to render from IndexedDB data even without a provider connection.

6. Return `isOffline` from the hook: add it to the return object and the `UseDocumentCollaborationResult` interface.

**useDiagramCollaboration changes (src/hooks/use-diagram-collaboration.ts):**

Apply identical changes as useDocumentCollaboration:

1. Decouple IndexedDB from provider — remove the `if (!provider) return;` guard from the IndexedDB useEffect. Depend on `[diagramId, yDoc]` instead of `[provider, diagramId, yDoc]`.

2. Accept `isOffline` from `useYjsProvider`.

3. Change loading logic: `isLoading = providerLoading && !indexedDbSynced` (loaded when either source syncs).

4. Return `isOffline` from the hook (add to return object and interface).

**IndexedDB staleness check:**
In both collaboration hooks, add a staleness check when loading from IndexedDB. After `IndexeddbPersistence` syncs, check if the Y.Doc has any content. If the doc was last modified more than 7 days ago (store a `lastModified` timestamp in the Y.Doc meta or use a simple approach: store `Date.now()` in a Y.Map called "meta" with key "lastModified" on every local update, and check it on IndexedDB sync), clear the IndexedDB cache and start fresh.

SIMPLER APPROACH for staleness: Rather than tracking modification times in the Y.Doc (adds complexity), use IndexedDB's built-in capabilities. When IndexedDB syncs AND the provider eventually connects, the Yjs CRDT merge handles everything. The staleness concern is about discarding truly ancient offline edits. Implement this pragmatically: after IndexedDB syncs, if `isOffline` is true, start a 7-day timer. If the provider hasn't connected after 7 days of the PAGE being open (extremely unlikely), warn the user. In practice, this edge case is so rare it doesn't need code — Yjs CRDTs handle merging correctly regardless of time gap. Skip the staleness implementation for now; document it as a future enhancement.
  </action>
  <verify>
Run `npm run lint` — should pass with 0 warnings.
Run `npm run build` — should compile successfully.
Verify useYjsProvider returns isOffline.
Verify IndexedDB persistence in useDocumentCollaboration does NOT depend on provider.
Verify IndexedDB persistence in useDiagramCollaboration does NOT depend on provider.
  </verify>
  <done>
useYjsProvider has 4-second timeout that sets isOffline=true when PartyKit unreachable, while keeping provider alive for background reconnection.
Both collaboration hooks initialize IndexedDB independently of provider, allowing offline editing from cached Yjs state.
Loading completes when either provider syncs OR IndexedDB syncs (whichever comes first).
Editor is returned when either provider or IndexedDB has data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add public snapshot URL query and redesign ConnectionStatus component</name>
  <files>
    convex/snapshots.ts
    src/pages/App/Document/ConnectionStatus.tsx
  </files>
  <action>
**Convex snapshot query (convex/snapshots.ts):**

Add a new PUBLIC query `getSnapshotUrl` that clients can call to fetch the snapshot download URL for a resource. This is needed for the cold-start fallback (no IndexedDB, no PartyKit).

```typescript
export const getSnapshotUrl = query({
  args: {
    resourceType: v.union(v.literal("doc"), v.literal("diagram"), v.literal("task")),
    resourceId: v.string(),
  },
  returns: v.union(v.string(), v.null()),
  handler: async (ctx, { resourceType, resourceId }) => {
    // Authentication check
    const userId = await getAuthUserId(ctx);
    if (!userId) return null;

    // Get the resource document
    let resource;
    if (resourceType === "doc") {
      resource = await ctx.db.get(resourceId as Id<"documents">);
    } else if (resourceType === "diagram") {
      resource = await ctx.db.get(resourceId as Id<"diagrams">);
    } else {
      resource = await ctx.db.get(resourceId as Id<"tasks">);
    }

    if (!resource || !resource.yjsSnapshotId) return null;

    // Get the URL for the stored blob
    const url = await ctx.storage.getUrl(resource.yjsSnapshotId);
    return url;
  },
});
```

Import `query` from `./_generated/server` and `getAuthUserId` from `@convex-dev/auth/server`. Use the same pattern as the existing `getSnapshot` internalQuery but return a URL instead of storageId, and make it public with auth check.

**ConnectionStatus redesign (src/pages/App/Document/ConnectionStatus.tsx):**

Per user decisions: always-visible indicator, two states only (Connected vs Not Connected), inline near toolbar, minimal tone with icon change.

1. Import `CloudOff` from `lucide-react` (already have `Loader2`).

2. Change the component interface to accept `isOffline` boolean instead of (or in addition to) the current props. Keep `isConnected` for backward compatibility but add `isOffline` prop.

3. Simplify to two states:
   - **Connected**: Small green dot (w-2 h-2 rounded-full bg-green-500). Tooltip: "Connected".
   - **Not Connected**: `CloudOff` icon (h-4 w-4 text-muted-foreground). Tooltip: "Offline — changes saved locally".

4. Remove the "syncing" state entirely — it's not part of the two-state model.

5. Remove provider-based sync/status event listeners (simplify the component). The connection state is fully driven by the `isConnected` and `isOffline` props.

6. Keep the component small: just conditional rendering based on `isConnected`. When connected, green dot. When not connected, cloud-off icon.

7. The component should NOT depend on `provider` prop anymore. Accept just `isConnected: boolean`. The parent components will derive this from the hook.
  </action>
  <verify>
Run `npm run lint` — 0 warnings.
Run `npm run build` — successful.
Verify convex/snapshots.ts exports `getSnapshotUrl` as a public query.
Verify ConnectionStatus no longer depends on provider prop.
Verify ConnectionStatus uses CloudOff icon for offline state.
  </verify>
  <done>
Public getSnapshotUrl query exists for client-side Convex snapshot retrieval.
ConnectionStatus shows green dot (connected) or cloud-off icon (offline) — two states only, always visible, no syncing state.
ConnectionStatus is simplified to accept just isConnected boolean.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 warnings
2. `npm run build` compiles successfully
3. useYjsProvider returns `isOffline` boolean that becomes true after 4s timeout
4. IndexedDB persistence in both collaboration hooks initializes independently of provider
5. Loading state resolves when either provider OR IndexedDB syncs
6. Editor is available when either provider or IndexedDB has data (not blocked on provider)
7. convex/snapshots.ts has public getSnapshotUrl query with auth check
8. ConnectionStatus shows two-state indicator (green dot / cloud-off icon)
</verification>

<success_criteria>
- useYjsProvider has CONNECTION_TIMEOUT = 4000 and returns isOffline
- Both collaboration hooks decouple IndexedDB from provider lifecycle
- Editors can render from IndexedDB data without active PartyKit connection
- Convex getSnapshotUrl query is publicly callable with auth
- ConnectionStatus is simplified to two-state always-visible indicator
- All lint and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-graceful-degradation/17-01-SUMMARY.md`
</output>
