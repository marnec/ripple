---
phase: 17-graceful-degradation
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/pages/App/Document/DocumentEditor.tsx
  - src/pages/App/Diagram/DiagramPage.tsx
  - src/pages/App/Diagram/ExcalidrawEditor.tsx
  - src/pages/App/Project/useTaskDetail.ts
autonomous: true

must_haves:
  truths:
    - "When PartyKit is unreachable and IndexedDB has cached data, document editor is fully editable with offline indicator"
    - "When PartyKit is unreachable and IndexedDB has cached data, diagram editor is fully editable with offline indicator"
    - "When PartyKit is unreachable and IndexedDB has cached data, task description is fully editable with offline indicator"
    - "When PartyKit is unreachable on cold start, editors show read-only Convex snapshot with offline indicator"
    - "Active users panel is hidden when offline"
    - "When PartyKit reconnects, editors auto-transition to live collaboration mode"
  artifacts:
    - path: "src/pages/App/Document/DocumentEditor.tsx"
      provides: "Document editor with offline mode (hides ActiveUsers, shows ConnectionStatus)"
      contains: "isOffline"
    - path: "src/pages/App/Diagram/DiagramPage.tsx"
      provides: "Diagram page with offline mode (hides ActiveUsers, shows ConnectionStatus)"
      contains: "isOffline"
    - path: "src/pages/App/Diagram/ExcalidrawEditor.tsx"
      provides: "Excalidraw editor with optional read-only mode for snapshot fallback"
      contains: "viewModeEnabled"
    - path: "src/pages/App/Project/useTaskDetail.ts"
      provides: "Task detail hook exposing offline state"
      contains: "isOffline"
  key_links:
    - from: "src/pages/App/Document/DocumentEditor.tsx"
      to: "src/hooks/use-document-collaboration.ts"
      via: "isOffline prop from collaboration hook"
      pattern: "isOffline"
    - from: "src/pages/App/Diagram/DiagramPage.tsx"
      to: "src/hooks/use-diagram-collaboration.ts"
      via: "isOffline prop from collaboration hook"
      pattern: "isOffline"
    - from: "src/pages/App/Diagram/ExcalidrawEditor.tsx"
      to: "Excalidraw component"
      via: "viewModeEnabled prop for read-only snapshot mode"
      pattern: "viewModeEnabled"
---

<objective>
Wire offline mode into all three editor types: documents, diagrams, and task descriptions. When offline with IndexedDB, editors remain fully editable with collab-only features (active users, cursors) hidden. On cold start without IndexedDB, load Convex snapshot in read-only mode. Auto-recover when PartyKit reconnects.

Purpose: Completes the graceful degradation feature by connecting the offline infrastructure (Plan 01) to every editor UI, fulfilling all four success criteria for Phase 17.

Output: Updated editor components for documents, diagrams, and task descriptions with offline-aware rendering and recovery.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-graceful-degradation/17-CONTEXT.md
@.planning/phases/17-graceful-degradation/17-01-SUMMARY.md

Key source files to read before implementing:
@src/pages/App/Document/DocumentEditor.tsx
@src/pages/App/Diagram/DiagramPage.tsx
@src/pages/App/Diagram/ExcalidrawEditor.tsx
@src/pages/App/Project/useTaskDetail.ts
@src/pages/App/Document/ConnectionStatus.tsx
@src/pages/App/Document/ActiveUsers.tsx
@src/hooks/use-document-collaboration.ts
@src/hooks/use-diagram-collaboration.ts
@convex/snapshots.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire offline mode into DocumentEditor and DiagramPage with snapshot fallback</name>
  <files>
    src/pages/App/Document/DocumentEditor.tsx
    src/pages/App/Diagram/DiagramPage.tsx
    src/pages/App/Diagram/ExcalidrawEditor.tsx
  </files>
  <action>
**DocumentEditor changes (src/pages/App/Document/DocumentEditor.tsx):**

1. Destructure `isOffline` from `useDocumentCollaboration` hook (added in Plan 01).

2. **Hide ActiveUsers when offline.** Conditionally render the `ActiveUsers` component only when `isConnected` is true (when offline, there are no remote users to show and the panel adds confusion).

3. **Update ConnectionStatus props.** Pass only `isConnected` to the simplified ConnectionStatus component (Plan 01 removed the provider dependency). ConnectionStatus is always rendered (always visible per user decision).

4. **Convex snapshot fallback for cold start.** Detect cold start condition: `isOffline === true` AND `editor === null` (IndexedDB had no data — no prior visit). When this condition is met, load and display the Convex snapshot in read-only mode via these steps:

   **Step 4a: Detect cold start.** In DocumentEditor, check `isOffline && !editor` (the collaboration hook returns `editor: null` when neither provider nor IndexedDB has synced content). This distinguishes cold start from the warm offline case where IndexedDB provides the editor.

   **Step 4b: Fetch snapshot URL.** Use `useQuery(api.snapshots.getSnapshotUrl, { resourceType: "doc", resourceId: documentId })` to get the Convex storage URL. This query is conditionally enabled (pass `"skip"` as args when not in cold-start mode to avoid unnecessary queries).

   **Step 4c: Fetch binary and apply to Y.Doc.** In a useEffect triggered by `snapshotUrl`, fetch the binary data from the URL, then create a local Y.Doc and apply the snapshot: `const tempDoc = new Y.Doc(); Y.applyUpdate(tempDoc, new Uint8Array(arrayBuffer))`.

   **Step 4d: Render read-only BlockNote from snapshot.** Create a separate `SnapshotFallback` component (defined inside DocumentEditor.tsx) that is rendered when `isOffline && !editor && snapshotUrl`. This component:
   - Takes the snapshot Y.Doc as prop
   - Gets the XML fragment: `snapshotDoc.getXmlFragment("document-store")`
   - Creates a fake provider for BlockNote's collaboration config: `{ awareness: new Awareness(snapshotDoc) } as any` (BlockNote only reads `provider.awareness` for cursor state, irrelevant in read-only)
   - Calls `useCreateBlockNote({ schema, collaboration: { fragment, provider: fakeProvider, user: { name: "", color: "" } } })`
   - Renders `<BlockNoteView editor={snapshotEditor} editable={false} />`
   - Shows a subtle "Viewing saved version" label in muted text below ConnectionStatus

   **Step 4e: Conditionally set editable=false.** The `SnapshotFallback` component always renders with `editable={false}` — this is the read-only mode for cold start per user decision (Claude's discretion: choosing read-only since there's no IndexedDB to persist offline edits against).

   Using a separate component avoids conditional hook calls (`useCreateBlockNote` must always be called) and keeps the main editor code clean.

5. **Auto-recovery.** When `isConnected` transitions from false to true and we were in snapshot mode, the collaboration hook will have already loaded the live editor. Simply remove the snapshot fallback UI. The hook's `editor` becoming non-null (from provider sync) will naturally replace the snapshot view — the `isOffline && !editor` condition will become false, unmounting SnapshotFallback and mounting the live editor.

**DiagramPage changes (src/pages/App/Diagram/DiagramPage.tsx):**

1. Destructure `isOffline` from `useDiagramCollaboration` hook.

2. **Hide ActiveUsers when offline.** Conditionally render ActiveUsers only when `isConnected`.

3. **Update ConnectionStatus props.** Pass only `isConnected`.

4. **Snapshot fallback for diagrams (cold start).** When `isOffline && isLoading` (no IndexedDB data), similar approach but for Excalidraw:
   - Fetch snapshot URL from `useQuery(api.snapshots.getSnapshotUrl, { resourceType: "diagram", resourceId: diagramId })`
   - Fetch binary, create Y.Doc, apply update
   - Read yElements array: `tempDoc.getArray("elements")`
   - Convert to Excalidraw elements via `yjsToExcalidraw(yElements)`
   - Render Excalidraw in `viewModeEnabled` mode with these elements

5. **ExcalidrawEditor modification** for read-only support: The existing Excalidraw component already supports `viewModeEnabled` prop. No changes needed to ExcalidrawEditor.tsx for this — the snapshot fallback will render Excalidraw directly in DiagramPage without the full ExcalidrawEditor (which requires yElements/awareness/provider).

For the diagram snapshot fallback, render a simpler inline component:
```tsx
<Excalidraw
  initialData={{ elements: snapshotElements }}
  viewModeEnabled={true}
  theme={resolvedTheme as Theme}
  zenModeEnabled={true}
/>
```

6. **Auto-recovery.** When provider connects, the regular editor replaces the snapshot view naturally.

**ExcalidrawEditor changes (src/pages/App/Diagram/ExcalidrawEditor.tsx):**

1. **Add `viewModeEnabled?: boolean` prop to the ExcalidrawEditor component interface.** Add it to the component's props type definition alongside existing props like `yElements`, `awareness`, etc.

2. **Pass `viewModeEnabled` through to the Excalidraw component.** In the JSX where `<Excalidraw ...>` is rendered, add `viewModeEnabled={viewModeEnabled}`. This enables the parent (DiagramPage) to put the editor into read-only mode for offline snapshot viewing.

3. **For the snapshot fallback in DiagramPage**, the snapshot approach renders Excalidraw directly in DiagramPage (not through ExcalidrawEditor) since snapshot viewing doesn't need yElements/awareness bindings. However, adding `viewModeEnabled` to ExcalidrawEditor provides a general-purpose read-only mechanism for any future use and makes the component's interface complete.
  </action>
  <verify>
Run `npm run lint` — 0 warnings.
Run `npm run build` — successful.
Verify DocumentEditor hides ActiveUsers when isOffline/not connected.
Verify DocumentEditor shows ConnectionStatus always.
Verify DiagramPage hides ActiveUsers when isOffline/not connected.
Verify DiagramPage has snapshot fallback rendering.
  </verify>
  <done>
DocumentEditor hides ActiveUsers when offline, always shows ConnectionStatus with green dot or cloud-off icon.
DocumentEditor renders read-only snapshot fallback on cold start without IndexedDB.
DiagramPage hides ActiveUsers when offline, shows snapshot fallback with viewModeEnabled Excalidraw.
Auto-recovery works: when provider connects, live editor replaces snapshot view.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire offline mode into task description editor</name>
  <files>
    src/pages/App/Project/useTaskDetail.ts
  </files>
  <action>
**useTaskDetail changes (src/pages/App/Project/useTaskDetail.ts):**

1. Destructure `isOffline` from `useDocumentCollaboration` hook call (it now returns `isOffline` from Plan 01).

2. Add `isOffline` to the return object so consuming components (TaskDetailSheet, TaskDetailPage) can use it.

3. The consuming components already use `isConnected`, `provider`, and `remoteUsers` from this hook. They render `ConnectionStatus` and `ActiveUsers` similarly to DocumentEditor.

Find the consuming components that render the task description editor UI and verify they:
- Render ConnectionStatus — update to pass just `isConnected` (matching Plan 01 simplification)
- Render ActiveUsers — conditionally render only when `isConnected`

To find consumers, search for imports of `useTaskDetail`:
- Look in `src/pages/App/Project/` for TaskDetailSheet.tsx or similar
- Look for components that render `<ConnectionStatus` and `<ActiveUsers` in the task context

For each consumer found:
- Update ConnectionStatus to use simplified props: `<ConnectionStatus isConnected={isConnected} />`
- Conditionally render ActiveUsers: `{isConnected && <ActiveUsers ... />}`

The task description offline behavior is identical to documents (per user decision: "Same offline behavior across documents, diagrams, and task descriptions"). The useDocumentCollaboration hook handles all the IndexedDB and timeout logic already — useTaskDetail just needs to expose `isOffline` and consumers need to adjust their UI.

For snapshot fallback in task descriptions (cold start): Follow the same pattern as DocumentEditor. When `isOffline && !editor`, show the snapshot fallback component or placeholder.
  </action>
  <verify>
Run `npm run lint` — 0 warnings.
Run `npm run build` — successful.
Verify useTaskDetail returns isOffline.
Verify task description consumers hide ActiveUsers when offline.
Verify task description consumers show simplified ConnectionStatus.
  </verify>
  <done>
useTaskDetail exposes isOffline from the collaboration hook.
Task description UI hides ActiveUsers when offline.
Task description ConnectionStatus uses simplified two-state indicator.
Offline task description editing works identically to documents.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 warnings
2. `npm run build` compiles successfully
3. DocumentEditor: hides ActiveUsers when offline, shows ConnectionStatus always, renders snapshot fallback on cold start
4. DiagramPage: hides ActiveUsers when offline, shows ConnectionStatus always, renders read-only Excalidraw on cold start
5. Task description: hides ActiveUsers when offline, shows ConnectionStatus, same behavior as documents
6. All three editors auto-recover when PartyKit reconnects (live editor replaces fallback)
7. ConnectionStatus shows green dot (connected) or cloud-off icon (offline) across all editors
</verification>

<success_criteria>
- All three resource types (documents, diagrams, tasks) show offline-capable editors when PartyKit unavailable
- ActiveUsers hidden in all editors when offline
- ConnectionStatus visible in all editors in both states
- Cold-start snapshot fallback renders content in read-only mode
- Auto-recovery from offline to live collaboration when provider connects
- All lint and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-graceful-degradation/17-02-SUMMARY.md`
</output>
