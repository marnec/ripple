---
phase: 17-graceful-degradation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - partykit/server.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "onAlarm periodic save (30s) successfully writes Yjs snapshot to Convex"
    - "onAlarm disconnect-debounce save (7s) successfully writes Yjs snapshot to Convex"
    - "Cold-start document loading from Convex snapshot works (Test 6)"
    - "Cold-start diagram loading from Convex snapshot works (Test 8)"
  artifacts:
    - path: "partykit/server.ts"
      provides: "roomId caching in PartyKit storage, alarm handler reads cached roomId"
      contains: "room.storage.put.*roomId"
  key_links:
    - from: "onConnect"
      to: "room.storage"
      via: "stores roomId in durable storage on first connection"
      pattern: "room\\.storage\\.put.*roomId"
    - from: "onAlarm"
      to: "room.storage"
      via: "reads cached roomId instead of accessing this.room.id"
      pattern: "room\\.storage\\.get.*roomId"
    - from: "saveSnapshotToConvex"
      to: "Convex HTTP endpoint"
      via: "uses roomId parameter instead of this.room.id"
      pattern: "saveSnapshotToConvex\\(roomId"
---

<objective>
Fix PartyKit onAlarm crash caused by accessing `this.room.id` (Party.id) in alarm handlers — a known PartyKit platform limitation. Without this fix, periodic saves (30s) and disconnect-debounce saves (7s) never succeed, meaning no Yjs snapshots reach Convex, breaking cold-start fallback (UAT Tests 6 and 8).

Purpose: Unblock the entire snapshot persistence pipeline so Convex has snapshots for cold-start fallback when IndexedDB is empty.
Output: Working onAlarm handler that saves snapshots to Convex using cached roomId.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-graceful-degradation/17-01-SUMMARY.md
@.planning/phases/17-graceful-degradation/17-02-SUMMARY.md
@partykit/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cache roomId in PartyKit storage and refactor alarm handler to use it</name>
  <files>partykit/server.ts</files>
  <action>
The root cause: `this.room.id` (Party.id) is inaccessible in PartyKit alarm handlers. Every call to `onAlarm` crashes because `saveSnapshotToConvex`, `checkPermissions`, and log statements all reference `this.room.id`.

Fix approach — cache the roomId in durable storage during `onConnect` (where `this.room.id` IS accessible), then read it from storage in `onAlarm`:

1. In `onConnect`, after successful auth verification, store the roomId:
   ```typescript
   await this.room.storage.put("roomId", this.room.id);
   ```
   Place this BEFORE the existing `storage.put("alarmType", ...)` call. Only needs to happen once but is idempotent so doing it every connect is safe and simple.

2. Refactor `saveSnapshotToConvex` to accept a `roomId: string` parameter instead of reading `this.room.id`:
   - Change signature: `private async saveSnapshotToConvex(roomId: string): Promise<void>`
   - Replace ALL occurrences of `this.room.id` inside the method with the `roomId` parameter
   - There are 4 occurrences: the skip-save log, the URL construction, the error log, and the success log

3. Refactor `checkPermissions` to accept a `roomId: string` parameter:
   - Change signature: `private async checkPermissions(roomId: string): Promise<void>`
   - Replace ALL occurrences of `this.room.id` inside the method with the `roomId` parameter
   - There are 2 occurrences: the URL construction and the permission-revoked log

4. In `onAlarm`, read the cached roomId at the top of the method:
   ```typescript
   const roomId = (await this.room.storage.get("roomId")) as string | undefined;
   if (!roomId) {
     console.error("No cached roomId in storage — cannot process alarm");
     return;
   }
   ```
   Then pass `roomId` to all calls: `this.saveSnapshotToConvex(roomId)`, `this.checkPermissions(roomId)`.
   Also replace all `this.room.id` references in onAlarm log statements with the `roomId` variable.

5. In `onClose`, also read roomId from storage for the log statement:
   ```typescript
   const roomId = (await this.room.storage.get("roomId")) as string | undefined;
   console.log(`Last user disconnected from room ${roomId ?? "unknown"}, scheduling debounced save`);
   ```
   NOTE: `onClose` may also have the same Party.id restriction. To be safe, use cached roomId here too.

6. In `loadSnapshotFromConvex`, this is called from `getYjsOptions().load()` which runs during `onConnect` (via `y-partykit`'s `onConnect`), so `this.room.id` IS accessible there. Leave it as-is since it only runs in connection context.

Do NOT change `onConnect` usage of `this.room.id` — it is accessible in that context and works fine.
  </action>
  <verify>
Run `npm run lint` — must pass with 0 warnings.
Run `npm run build` — must compile successfully.
Grep partykit/server.ts for `this.room.id` — should ONLY appear in `onConnect` and `loadSnapshotFromConvex` (both safe contexts). Should NOT appear in `onAlarm`, `onClose`, `saveSnapshotToConvex`, or `checkPermissions`.
  </verify>
  <done>
onAlarm handler reads roomId from PartyKit durable storage instead of accessing this.room.id. saveSnapshotToConvex and checkPermissions accept roomId as parameter. All this.room.id usage restricted to onConnect and loadSnapshotFromConvex (safe contexts). Lint and build pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 warnings
2. `npm run build` compiles successfully
3. `this.room.id` only appears in `onConnect` and `loadSnapshotFromConvex` methods (grep verification)
4. `roomId` parameter is passed to `saveSnapshotToConvex` and `checkPermissions` in all call sites within `onAlarm`
5. `room.storage.put("roomId", ...)` is called during `onConnect`
6. `room.storage.get("roomId")` is called at the top of `onAlarm`
</verification>

<success_criteria>
PartyKit onAlarm handler no longer crashes. The roomId is cached in durable storage during onConnect and read back in onAlarm. Periodic saves (30s) and disconnect-debounce saves (7s) can now write Yjs snapshots to Convex, enabling cold-start fallback for documents and diagrams (UAT Tests 6 and 8).
</success_criteria>

<output>
After completion, create `.planning/phases/17-graceful-degradation/17-03-SUMMARY.md`
</output>
