---
phase: 12-document-multiplayer-cursors-yjs-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/prosemirror.ts
  - convex/convex.config.ts
  - convex/schema.ts
  - convex/documents.ts
  - package.json
  - src/lib/user-colors.ts
  - src/hooks/use-document-collaboration.ts
  - src/pages/App/Document/DocumentEditor.tsx
autonomous: true

must_haves:
  truths:
    - "BlockNote documents sync content via Yjs CRDTs (not ProseMirror Sync)"
    - "Document content persists across page refresh via y-indexeddb offline cache"
    - "Custom inline content types (mention, diagram) work with Yjs sync"
    - "User colors are deterministic per userId (same user always gets same color)"
    - "ProseMirror Sync code is fully removed (clean break)"
  artifacts:
    - path: "src/hooks/use-document-collaboration.ts"
      provides: "BlockNote + Yjs integration hook"
      min_lines: 40
    - path: "src/lib/user-colors.ts"
      provides: "Deterministic user color assignment"
      exports: ["getUserColor", "getUserColorWithAlpha"]
    - path: "src/pages/App/Document/DocumentEditor.tsx"
      provides: "Yjs-powered document editor (no ProseMirror Sync)"
      min_lines: 80
  key_links:
    - from: "src/pages/App/Document/DocumentEditor.tsx"
      to: "src/hooks/use-document-collaboration.ts"
      via: "useDocumentCollaboration hook"
      pattern: "useDocumentCollaboration"
    - from: "src/hooks/use-document-collaboration.ts"
      to: "src/hooks/use-yjs-provider.ts"
      via: "useYjsProvider hook from Phase 11"
      pattern: "useYjsProvider"
    - from: "src/hooks/use-document-collaboration.ts"
      to: "y-indexeddb"
      via: "IndexeddbPersistence for offline cache"
      pattern: "IndexeddbPersistence"
    - from: "src/lib/user-colors.ts"
      to: "color-hash"
      via: "deterministic color generation"
      pattern: "ColorHash"
---

<objective>
Remove ProseMirror Sync collaboration and replace with Yjs-based BlockNote collaboration. Install new dependencies, create user color utility, and rewrite DocumentEditor to use Yjs CRDTs via the existing useYjsProvider hook from Phase 11.

Purpose: This is the foundation for Phase 12 — documents must work with Yjs before cursor/presence UI can be layered on top.
Output: Working document editor with Yjs sync, offline persistence via y-indexeddb, and user color assignment.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-CONTEXT.md
@.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-RESEARCH.md
@.planning/phases/11-partykit-infrastructure-persistence/11-01-SUMMARY.md
@.planning/phases/11-partykit-infrastructure-persistence/11-02-SUMMARY.md
@src/hooks/use-yjs-provider.ts
@src/pages/App/Document/DocumentEditor.tsx
@convex/prosemirror.ts
@convex/convex.config.ts
@convex/schema.ts
@convex/documents.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ProseMirror Sync and install Yjs dependencies</name>
  <files>
    convex/prosemirror.ts
    convex/convex.config.ts
    convex/schema.ts
    convex/documents.ts
    package.json
    src/lib/user-colors.ts
  </files>
  <action>
    **Step 1: Remove ProseMirror Sync backend**
    - DELETE `convex/prosemirror.ts` entirely
    - In `convex/convex.config.ts`: Remove the `import prosemirrorSync` line and the `app.use(prosemirrorSync)` line. Keep migrations and presence.
    - In `convex/schema.ts`: The documents table currently has NO content field (it was already removed or never had one for Yjs). Verify this — if there IS a content field on documents, remove it. The schema already looks clean based on current state.

    **Step 2: Clean up documents.ts**
    - In `convex/documents.ts`: Check for any references to content field or prosemirror. The `documentValidator` object currently does not include a content field, which is correct. No changes needed unless content references exist.

    **Step 3: Install new dependencies**
    - Run: `npm install y-indexeddb color-hash`
    - Run: `npm install --save-dev @types/color-hash`

    **Step 4: Uninstall ProseMirror Sync**
    - Run: `npm uninstall @convex-dev/prosemirror-sync`
    - Verify no remaining imports of `@convex-dev/prosemirror-sync` in src/ or convex/ (excluding _generated/)

    **Step 5: Create user colors utility**
    - Create `src/lib/user-colors.ts`:
      - Import ColorHash from 'color-hash'
      - Create singleton colorHash instance with `lightness: [0.5, 0.6, 0.7]` and `saturation: [0.6, 0.7, 0.8]` for vibrant readable colors
      - Export `getUserColor(userId: string): string` — returns hex color via `colorHash.hex(userId)`
      - Export `getUserColorWithAlpha(userId: string, alpha: number): string` — converts hex to rgba string for translucent selection highlights
      - Both functions are deterministic: same userId always returns same color (per AWARE-03)
      - This utility will be reused in Phase 13 for diagram cursors

    **Step 6: Deploy schema changes**
    - Run `npx convex dev --once` or ensure convex dev is running to push schema changes (removing prosemirrorSync component)
  </action>
  <verify>
    - `npm run lint` passes (no TypeScript errors from removed prosemirror imports)
    - `npm ls y-indexeddb color-hash` shows both installed
    - `grep -r "prosemirror-sync" src/ convex/ --include="*.ts" --include="*.tsx" | grep -v _generated | grep -v node_modules` returns empty (no remaining references)
    - `convex/prosemirror.ts` does not exist
    - `src/lib/user-colors.ts` exists and exports getUserColor, getUserColorWithAlpha
  </verify>
  <done>
    ProseMirror Sync fully removed from backend and dependencies. y-indexeddb and color-hash installed. User color utility created with deterministic color generation. Schema deploys without prosemirrorSync component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite DocumentEditor with Yjs collaboration</name>
  <files>
    src/hooks/use-document-collaboration.ts
    src/pages/App/Document/DocumentEditor.tsx
  </files>
  <action>
    **Step 1: Create use-document-collaboration hook**
    Create `src/hooks/use-document-collaboration.ts` that orchestrates BlockNote + Yjs:

    ```typescript
    // Accepts: documentId (string), userName (string), userId (string)
    // Returns: { editor, isLoading, isConnected, provider }
    ```

    Implementation:
    - Call `useYjsProvider({ resourceType: "doc", resourceId: documentId })` from Phase 11
    - Create IndexeddbPersistence for offline cache: `new IndexeddbPersistence(\`doc-${documentId}\`, yDoc)` — only when provider is ready
    - Get user color via `getUserColor(userId)` from `src/lib/user-colors.ts`
    - Create BlockNote editor via `useCreateBlockNote` with the `collaboration` option:
      ```typescript
      const editor = useCreateBlockNote({
        schema,  // Pass the schema with custom blocks (diagram, mention)
        collaboration: {
          provider,
          fragment: yDoc.getXmlFragment("document-store"),
          user: {
            name: userName,
            color: userColor,
          },
        },
      });
      ```
    - The schema object must be passed into this hook OR the hook must accept it as a parameter. Since the schema includes custom block types (DiagramBlock, User mention), pass the schema as a parameter to the hook.
    - Clean up IndexeddbPersistence on unmount: call `indexeddbProvider.destroy()`
    - Track IndexedDB sync status for loading state
    - Return `{ editor, isLoading, isConnected, provider, yDoc }` — provider needed for Plan 02 cursor awareness

    IMPORTANT: Do NOT pass `initialContent` when using `collaboration` option — BlockNote docs say these are mutually exclusive. The Yjs document IS the content source.

    **Step 2: Rewrite DocumentEditor.tsx**
    Replace the current ProseMirror Sync-based editor:

    - Remove: `import { useBlockNoteSync } from "@convex-dev/prosemirror-sync/blocknote"`
    - Remove: The `useBlockNoteSync` call and its `sync.isLoading`, `sync.editor`, `sync.create` logic
    - Remove: The `useEffect` that calls `sync.create` for new documents
    - Remove: The `useState<Editor | null>` for editor state (the hook now manages this)

    - Add: Import and call `useDocumentCollaboration` hook with documentId, current user name, and current user ID
    - Add: Import `useQuery(api.users.viewer)` for current user info (may already exist via enhancedPresence)
    - Keep: The schema definition (DiagramBlock, User mention) — pass it to the collaboration hook
    - Keep: FacePile/enhancedPresence (will be replaced in Plan 02, but keep working for now)
    - Keep: SuggestionMenuController for # (diagrams) and @ (mentions) — these work independently of sync method
    - Keep: Theme handling, document query, diagrams query, workspaceMembers query

    The editor rendering should now be:
    ```tsx
    const { editor, isLoading, isConnected } = useDocumentCollaboration({
      documentId,
      userName: viewer?.name ?? "Anonymous",
      userId: viewer?._id ?? "anonymous",
      schema,
    });

    // Show loading state while Yjs syncs
    if (isLoading || !editor) {
      return <div className="p-20 animate-pulse">Loading document...</div>;
    }

    // Render BlockNoteView with the collaboration editor
    return (
      <div className="px-20 max-w-full flex-1 animate-fade-in relative">
        {/* FacePile stays for now, replaced in Plan 02 */}
        <div className="absolute top-5 right-10 z-10">
          <FacePile users={enhancedPresence} hideInactive={true} />
        </div>
        <h2 className="text-3xl py-12 font-semibold">{document?.name}</h2>
        <BlockNoteView editor={editor} theme={resolvedTheme === "dark" ? "dark" : "light"}>
          {/* Keep both SuggestionMenuControllers exactly as-is */}
        </BlockNoteView>
      </div>
    );
    ```

    Note: The editor type changes from the manually-created `BlockNoteEditor<...>` to what `useCreateBlockNote` returns. The schema typing should still work since we pass the same schema object.

    **Step 3: Verify custom inline content compatibility**
    After implementing, verify that:
    - The `mention` inline content (UserBlock) uses `createReactInlineContentSpec` — this pattern is compatible with Yjs per research
    - The `diagram` block (DiagramBlock) uses `createReactBlockSpec` — also compatible
    - Both custom types define their propSchema with `default` values — Yjs serialization should handle this automatically
    - If custom content doesn't serialize correctly with Yjs, add a comment noting this for debugging but do NOT add workarounds yet — test first
  </action>
  <verify>
    - `npm run lint` passes with zero warnings
    - `npm run build` succeeds
    - `src/hooks/use-document-collaboration.ts` exists and imports useYjsProvider, IndexeddbPersistence, getUserColor
    - `src/pages/App/Document/DocumentEditor.tsx` has NO imports from `@convex-dev/prosemirror-sync`
    - `src/pages/App/Document/DocumentEditor.tsx` imports and uses `useDocumentCollaboration`
    - The schema object with DiagramBlock and User mention is still defined and passed to the editor
  </verify>
  <done>
    DocumentEditor uses Yjs-based collaboration via BlockNote's `collaboration` option. Documents sync via PartyKit WebSocket (Phase 11 infrastructure). Offline persistence via y-indexeddb caches opened documents in browser. Custom inline content types (mention, diagram) included in schema. ProseMirror Sync fully removed from frontend.
  </done>
</task>

</tasks>

<verification>
- `npm run lint` passes with zero warnings
- `npm run build` succeeds
- No references to `prosemirror-sync` remain in src/ or convex/ (excluding _generated/)
- `convex/prosemirror.ts` deleted
- `convex/convex.config.ts` no longer references prosemirrorSync
- DocumentEditor.tsx uses useDocumentCollaboration hook (Yjs-based)
- y-indexeddb and color-hash are in package.json dependencies
- user-colors.ts exports deterministic color functions
</verification>

<success_criteria>
1. Documents load and sync via Yjs CRDTs through PartyKit (replacing ProseMirror Sync)
2. Offline persistence works: opening a document caches it in IndexedDB
3. Custom inline content (mentions, diagram embeds) renders correctly in the Yjs-backed editor
4. User colors are deterministic per userId
5. ProseMirror Sync code completely removed (no stale imports, no unused backend files)
6. Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-01-SUMMARY.md`
</output>
