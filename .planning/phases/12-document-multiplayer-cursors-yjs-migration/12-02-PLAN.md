---
phase: 12-document-multiplayer-cursors-yjs-migration
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/hooks/use-cursor-awareness.ts
  - src/pages/App/Document/ActiveUsers.tsx
  - src/pages/App/Document/ConnectionStatus.tsx
  - src/pages/App/Document/DocumentEditor.tsx
autonomous: true

must_haves:
  truths:
    - "User can see other users' cursor positions in real-time in BlockNote documents"
    - "User can see other users' text selection ranges highlighted with user-specific colors"
    - "Each user's cursor displays a colored label with their display name"
    - "Cursors fade after 30s of idle"
    - "Stale cursors (unclean disconnect) are removed after 10s"
    - "User can see active users as overlapping avatar stack in document header"
    - "Connection status icon shows green/yellow/red in document header"
    - "Sync icon visible when local changes are pending"
  artifacts:
    - path: "src/hooks/use-cursor-awareness.ts"
      provides: "Awareness state management for remote cursors"
      min_lines: 40
    - path: "src/pages/App/Document/ActiveUsers.tsx"
      provides: "Figma-style overlapping avatar stack"
      min_lines: 30
    - path: "src/pages/App/Document/ConnectionStatus.tsx"
      provides: "Connection status + sync indicator"
      min_lines: 30
  key_links:
    - from: "src/hooks/use-cursor-awareness.ts"
      to: "y-partykit/provider"
      via: "provider.awareness for cursor state"
      pattern: "awareness\\.getStates|awareness\\.on"
    - from: "src/pages/App/Document/ActiveUsers.tsx"
      to: "src/hooks/use-cursor-awareness.ts"
      via: "useCursorAwareness hook"
      pattern: "useCursorAwareness"
    - from: "src/pages/App/Document/DocumentEditor.tsx"
      to: "src/pages/App/Document/ActiveUsers.tsx"
      via: "ActiveUsers component in header"
      pattern: "ActiveUsers"
    - from: "src/pages/App/Document/DocumentEditor.tsx"
      to: "src/pages/App/Document/ConnectionStatus.tsx"
      via: "ConnectionStatus component in header"
      pattern: "ConnectionStatus"
---

<objective>
Add real-time cursor awareness UI, active users avatar stack, and connection status indicators to the document editor. Leverage Yjs Awareness API for cursor tracking — BlockNote's collaboration mode already broadcasts cursor positions, so this plan focuses on rendering the UI and managing awareness state.

Purpose: Complete the multiplayer experience by making other users visible in the document (cursors, selections, presence, connection state).
Output: Full cursor awareness UI with avatar stack, connection indicators, and proper stale cursor handling.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-CONTEXT.md
@.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-RESEARCH.md
@.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-01-SUMMARY.md
@src/hooks/use-yjs-provider.ts
@src/hooks/use-document-collaboration.ts
@src/lib/user-colors.ts
@src/pages/App/Document/DocumentEditor.tsx
@src/components/ui/facepile.tsx
@src/components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cursor awareness hook and active users avatar stack</name>
  <files>
    src/hooks/use-cursor-awareness.ts
    src/pages/App/Document/ActiveUsers.tsx
  </files>
  <action>
    **Step 1: Create useCursorAwareness hook**
    Create `src/hooks/use-cursor-awareness.ts`:

    This hook observes Yjs Awareness state from the provider and returns a list of remote users with their cursor positions and metadata.

    Interface:
    ```typescript
    interface RemoteUser {
      clientId: number;
      name: string;
      color: string;
      // cursor may be null if user is present but not actively editing
      cursor: { anchor: number; head: number } | null;
      lastUpdate: number; // timestamp of last awareness change for this client
      isIdle: boolean; // true if cursor hasn't moved in 30s
    }
    ```

    Implementation:
    - Accept `awareness: Awareness | null` as parameter (from provider.awareness)
    - Listen to `awareness.on('change', ...)` events
    - On each change, iterate `awareness.getStates()`, skip local clientID
    - For each remote state: extract `state.user` (name, color) and `state.cursor` (anchor, head)
    - Track `lastUpdate` timestamp per clientId — update timestamp whenever that client's state changes
    - **Stale cursor removal (10s):** Filter out clients whose `lastUpdate` is >10s old. This handles unclean disconnects. Use a 1-second interval timer to re-evaluate staleness.
    - **Idle detection (30s):** Track each cursor's last position change. If position hasn't changed in 30s, set `isIdle: true`. UI will use this for fade effect.
    - Return `{ remoteUsers: RemoteUser[] }` — only active (non-stale) users

    IMPORTANT: BlockNote's collaboration mode already sets awareness state (user name, color, cursor position) automatically via y-prosemirror integration. We do NOT need to manually set cursor positions — we only need to READ remote cursors. BlockNote also renders remote cursors in the editor automatically via the collaboration option (colored carets with name labels). This hook is primarily for the ActiveUsers avatar stack and connection status.

    Research note: BlockNote + Yjs collaboration likely renders cursors automatically (colored carets + name labels) because it uses y-prosemirror under the hood which includes cursor rendering. If this is the case, we do NOT need a custom CursorOverlay component. The hook still provides data for the ActiveUsers component.

    **Step 2: Create ActiveUsers avatar stack**
    Create `src/pages/App/Document/ActiveUsers.tsx`:

    Per locked decision: "Active users displayed as top-right overlapping avatar stack in document header (Figma style)"

    Implementation:
    - Accept `remoteUsers: RemoteUser[]` and optionally current user info as props
    - Display overlapping avatar circles (similar to existing FacePile component but Awareness-based)
    - Each avatar shows user's color as a ring/border (using the color from Awareness state)
    - Show current user as the first avatar (always present, slightly different styling — e.g., no color ring since it's you)
    - Tooltip on hover showing user name and "Editing" / "Viewing" / "Idle" status
    - Use the existing Avatar/AvatarFallback/AvatarImage components from shadcn/ui
    - For remote users without an image (Awareness only provides name + color), show colored initials in AvatarFallback with background matching their user color
    - Max display: 5 avatars, then "+N" overflow (similar to existing FacePile pattern)
    - Style: `flex -space-x-2` for overlapping effect, each avatar has `border-2 border-background` to create separation

    Note: Awareness state only provides name and color (set by BlockNote collaboration). We do NOT have user avatar images from Awareness. To get images, we'd need to query Convex for user details. For simplicity, use colored initials from Awareness state. If the existing FacePile/enhancedPresence can coexist alongside Awareness data, we can keep it temporarily and layer Awareness data on top. However, per the migration decision, prefer Awareness-based presence since it's more accurate (directly from WebSocket connection state).
  </action>
  <verify>
    - `npm run lint` passes
    - `src/hooks/use-cursor-awareness.ts` exists and exports useCursorAwareness
    - `src/pages/App/Document/ActiveUsers.tsx` exists and renders avatar stack
    - useCursorAwareness filters stale clients (>10s) and tracks idle state (>30s)
  </verify>
  <done>
    Cursor awareness hook reads remote user positions from Yjs Awareness API with 10s stale removal and 30s idle detection. ActiveUsers component renders Figma-style overlapping avatar stack with user colors and tooltips.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connection status indicator and DocumentEditor integration</name>
  <files>
    src/pages/App/Document/ConnectionStatus.tsx
    src/pages/App/Document/DocumentEditor.tsx
  </files>
  <action>
    **Step 1: Create ConnectionStatus component**
    Create `src/pages/App/Document/ConnectionStatus.tsx`:

    Per locked decisions:
    - "Subtle connection status icon in document header (green/yellow/red)"
    - "Small sync icon visible when local changes are pending sync to server"

    Implementation:
    - Accept props: `isConnected: boolean`, `isSynced: boolean` (or derive from provider)
    - Three states:
      - **Connected + Synced** (green): Small green dot (w-2 h-2 rounded-full bg-green-500). Tooltip: "Connected"
      - **Connected + Syncing** (yellow): Small yellow dot with subtle pulse animation. Tooltip: "Syncing changes..." Show a small sync icon (lucide-react `RefreshCw` or `Loader2` with spin animation) next to the dot when syncing.
      - **Disconnected** (red): Small red dot. Tooltip: "Offline — changes saved locally". This reassures user that y-indexeddb is caching their edits.
    - Keep it subtle — this sits in the document header area, should not be distracting
    - Use Tailwind classes for the dot and `@radix-ui/react-tooltip` (already available via shadcn/ui) for hover tooltip

    To determine sync state, use provider events:
    - `provider.on('status', ...)` for connection status
    - `provider.on('sync', ...)` for initial sync completion
    - Track whether there are pending local changes: listen for `yDoc.on('update', ...)` to detect local changes, and provider sync events to detect when they're sent. Alternatively, use a simpler heuristic: after any local edit, show "syncing" for 500ms then revert to "connected" (since Yjs syncs are near-instant over WebSocket).

    **Step 2: Integrate everything into DocumentEditor**
    Update `src/pages/App/Document/DocumentEditor.tsx`:

    - Import ActiveUsers and ConnectionStatus components
    - Import useCursorAwareness hook
    - Remove the old FacePile/enhancedPresence usage:
      - Remove `import { FacePile } from "../../../components/ui/facepile"`
      - Remove `import { useEnhancedPresence } from "../../../hooks/use-enhanced-presence"`
      - Remove `const enhancedPresence = useEnhancedPresence(documentId)`
      - Remove the `<FacePile ... />` JSX
    - Add cursor awareness:
      ```tsx
      const { remoteUsers } = useCursorAwareness(provider?.awareness ?? null);
      ```
    - Add the new header area (top-right of document):
      ```tsx
      <div className="absolute top-5 right-10 z-10 flex items-center gap-3">
        <ConnectionStatus isConnected={isConnected} provider={provider} />
        <ActiveUsers remoteUsers={remoteUsers} currentUser={viewer} />
      </div>
      ```
    - The `provider` and `isConnected` come from the `useDocumentCollaboration` hook (Plan 01). If the hook doesn't currently return `provider`, update it to do so. The hook should already return `{ editor, isLoading, isConnected, provider, yDoc }` per Plan 01.

    **Step 3: Verify cursor rendering**
    BlockNote's collaboration mode (using y-prosemirror internally) should automatically render:
    - Colored carets at remote users' cursor positions
    - Name labels floating above carets
    - Translucent color overlays for text selections

    Per locked decisions:
    - "Colored caret + floating name label (Google Docs style)" — this should be automatic from BlockNote collaboration
    - "Translucent color overlay for other users' text selections" — also automatic from y-prosemirror cursor plugin

    If BlockNote does NOT automatically render cursors (i.e., no visible carets/labels in the editor when multiple users edit):
    - Check if `@blocknote/core` includes y-prosemirror's cursor plugin. It should, since `collaboration` option is documented to handle this.
    - If cursors are NOT rendered, we may need to add CSS for the cursor styles. y-prosemirror uses CSS classes like `.yRemoteSelection`, `.yRemoteSelectionHead`, `.yRemoteCaretUser`. Add these styles to the document editor's CSS or a global stylesheet:
      ```css
      .yRemoteSelection { background-color: var(--user-color); opacity: 0.3; }
      .yRemoteSelectionHead { position: absolute; border-left: 2px solid var(--user-color); }
      /* Name label positioned above caret */
      .yRemoteSelectionHead::after {
        content: attr(data-user);
        position: absolute;
        bottom: 100%;
        left: 0;
        padding: 2px 6px;
        font-size: 12px;
        background: var(--user-color);
        color: white;
        border-radius: 4px 4px 4px 0;
        white-space: nowrap;
      }
      ```
    - Add these CSS styles in a `src/pages/App/Document/cursor-styles.css` file and import it in DocumentEditor if needed.

    **Step 4: Cursor fade behavior**
    Per locked decisions: "Cursors fade after 30s of idle, removed instantly on leave"
    - The `isIdle` flag from useCursorAwareness provides this data
    - If BlockNote renders cursors automatically, we need CSS to fade idle cursors. Use a CSS class approach:
      - When a remote user becomes idle (30s no cursor movement), add a data attribute or CSS class to their cursor elements
      - Apply `opacity: 0.3; transition: opacity 1s ease` for fade effect
    - Since BlockNote's internal cursor rendering may not expose per-user idle state, a simpler approach: add a global CSS rule that uses the Awareness update timestamps. If this is too complex, document the limitation and note that BlockNote auto-manages cursor visibility.
    - For "removed instantly on leave": Yjs Awareness automatically removes clients when they disconnect, which removes their cursors immediately. This is built-in behavior.
    - For "stale cursors removed after 10s": The useCursorAwareness hook already handles this by filtering clients with >10s since last update. This affects the ActiveUsers avatar stack. For in-editor cursor rendering, Yjs Awareness timeout (default 30s) handles removal. To get 10s removal in the editor, we could set `awareness.setLocalStateField` timeout, but this is a provider-level setting. Add a comment noting the 10s filtering applies to the avatar stack, while in-editor cursors use Yjs's default 30s timeout (acceptable tradeoff — the cursor fades at 30s which is the same locked decision for idle fade).
  </action>
  <verify>
    - `npm run lint` passes with zero warnings
    - `npm run build` succeeds
    - `src/pages/App/Document/ConnectionStatus.tsx` exists with green/yellow/red states
    - `src/pages/App/Document/ActiveUsers.tsx` renders overlapping avatar stack
    - DocumentEditor.tsx imports and renders ActiveUsers and ConnectionStatus
    - DocumentEditor.tsx no longer references FacePile or useEnhancedPresence
    - No references to `use-enhanced-presence` remain in the Document directory
  </verify>
  <done>
    Connection status shows green/yellow/red with sync indicator. ActiveUsers avatar stack shows who's in the document via Yjs Awareness. Remote cursors visible in editor (colored carets + name labels via BlockNote collaboration). Stale cursors filtered after 10s in avatar stack. Old Convex presence system removed from document editor.
  </done>
</task>

</tasks>

<verification>
- `npm run lint` passes with zero warnings
- `npm run build` succeeds
- DocumentEditor shows active users as overlapping avatar stack (top-right)
- DocumentEditor shows connection status indicator (green/yellow/red dot)
- Cursor awareness hook reads from Yjs Awareness API
- Old FacePile/enhancedPresence removed from DocumentEditor
- No remaining references to ProseMirror Sync anywhere in the codebase
</verification>

<success_criteria>
1. Remote users' cursors visible as colored carets with name labels in BlockNote editor
2. Text selections show as translucent color overlays
3. Active users displayed as overlapping avatar stack in document header
4. Connection status shows green (connected), yellow (syncing), red (offline)
5. Stale cursors removed from avatar stack after 10s
6. Old Convex presence system (FacePile, useEnhancedPresence) removed from document editor
7. Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/12-document-multiplayer-cursors-yjs-migration/12-02-SUMMARY.md`
</output>
