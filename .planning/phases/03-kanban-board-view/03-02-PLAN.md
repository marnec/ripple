---
phase: 03-kanban-board-view
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/pages/App/Project/KanbanBoard.tsx
  - src/pages/App/Project/KanbanColumn.tsx
  - src/pages/App/Project/KanbanCard.tsx
  - src/pages/App/Project/KanbanCardPresenter.tsx
  - src/pages/App/Project/ProjectDetails.tsx
  - src/pages/App/Project/Tasks.tsx
autonomous: true

must_haves:
  truths:
    - "User can view project tasks organized in columns by status on a Kanban board"
    - "User can drag and drop tasks between columns to change status"
    - "User can drag and drop tasks within a column to reorder them"
    - "Drag operations feel instant via optimistic updates"
    - "User can switch between list view and board view"
    - "Clicking a card opens the task detail sheet"
    - "Multiple users see board updates in real-time"
  artifacts:
    - path: "src/pages/App/Project/KanbanBoard.tsx"
      provides: "Main board with DndContext, drag handlers, optimistic updates"
      min_lines: 100
    - path: "src/pages/App/Project/KanbanColumn.tsx"
      provides: "Droppable status column with SortableContext"
      min_lines: 30
    - path: "src/pages/App/Project/KanbanCard.tsx"
      provides: "Draggable card wrapper with useSortable"
      min_lines: 20
    - path: "src/pages/App/Project/KanbanCardPresenter.tsx"
      provides: "Presentational card used in column and DragOverlay"
      min_lines: 20
    - path: "src/pages/App/Project/ProjectDetails.tsx"
      provides: "View toggle between list and board"
      contains: "KanbanBoard"
  key_links:
    - from: "KanbanBoard.tsx"
      to: "convex/tasks.ts (updatePosition)"
      via: "useMutation with .withOptimisticUpdate()"
      pattern: "withOptimisticUpdate"
    - from: "KanbanBoard.tsx"
      to: "convex/tasks.ts (listByProject)"
      via: "useQuery for task data"
      pattern: "api\\.tasks\\.listByProject"
    - from: "KanbanCard.tsx"
      to: "KanbanCardPresenter.tsx"
      via: "renders presenter inside sortable wrapper"
      pattern: "KanbanCardPresenter"
    - from: "KanbanBoard.tsx"
      to: "@dnd-kit/core"
      via: "DndContext, DragOverlay, sensors"
      pattern: "DndContext"
    - from: "ProjectDetails.tsx"
      to: "KanbanBoard.tsx"
      via: "conditional render based on view toggle"
      pattern: "KanbanBoard"
---

<objective>
Build the Kanban board UI with drag-and-drop task management.

Purpose: This is the core deliverable of Phase 3 -- a visual board where tasks are organized in status columns, draggable between columns (status change) and within columns (reorder). Uses dnd-kit for drag-drop, fractional-indexing for position calculation, and Convex optimistic updates for instant feedback.

Output: Four new components (KanbanBoard, KanbanColumn, KanbanCard, KanbanCardPresenter) and a list/board view toggle on the project page.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-kanban-board-view/03-RESEARCH.md
@.planning/phases/03-kanban-board-view/03-01-SUMMARY.md
@convex/schema.ts
@convex/tasks.ts
@convex/taskStatuses.ts
@src/pages/App/Project/ProjectDetails.tsx
@src/pages/App/Project/Tasks.tsx
@src/pages/App/Project/TaskRow.tsx
@src/pages/App/Project/TaskDetailSheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KanbanCardPresenter, KanbanCard, KanbanColumn, and KanbanBoard components</name>
  <files>
    src/pages/App/Project/KanbanCardPresenter.tsx
    src/pages/App/Project/KanbanCard.tsx
    src/pages/App/Project/KanbanColumn.tsx
    src/pages/App/Project/KanbanBoard.tsx
  </files>
  <action>
**KanbanCardPresenter.tsx** -- Pure presentational component (no drag hooks). Used both inside KanbanCard and in DragOverlay.

Props: `task` object (enriched with status + assignee), `onClick` callback.

Display:
- shadcn Card component with `cursor-grab active:cursor-grabbing` classes
- CardHeader: task title (text-sm font-medium, truncated)
- CardContent: row with priority icon (same icons as TaskRow -- AlertCircle/ArrowUp/Minus/ArrowDown with same colors) on the left, assignee Avatar on the right
- If task has labels, show them as small Badge components below priority row
- Compact design -- padding should be tight (py-2 px-3) for efficient board space
- When used in DragOverlay, add a subtle shadow (shadow-lg) and slight rotation (rotate-2) for "picked up" feel. Accept an optional `isDragging` prop that adds these styles.

**KanbanCard.tsx** -- Draggable wrapper using `useSortable` from @dnd-kit/sortable.

Props: `task` object, `onClick` callback.

Implementation:
- Call `useSortable({ id: task._id })` to get `attributes`, `listeners`, `setNodeRef`, `transform`, `transition`, `isDragging`
- Use `CSS.Transform.toString(transform)` from @dnd-kit/utilities for style
- Render a div with ref, style, attributes, listeners wrapping `<KanbanCardPresenter>`
- When `isDragging` is true, render a placeholder (same size div with dashed border and bg-muted/50) instead of the card content -- this shows where the card came from
- onClick should be passed to the KanbanCardPresenter (dnd-kit's PointerSensor with distance:8 distinguishes clicks from drags)

**KanbanColumn.tsx** -- Droppable column container using SortableContext.

Props: `status` object (id, name, color, order), `tasks` array (sorted by position), `onTaskClick` callback.

Implementation:
- Use `useDroppable({ id: status._id })` from @dnd-kit/core for the column to be a drop target even when empty
- Wrap task list in `SortableContext` with `verticalListSortingStrategy`, items = `tasks.map(t => t._id)`
- Header: colored dot (status.color class) + status name (font-semibold text-sm) + task count badge
- Scrollable task area: flex flex-col gap-2, with `overflow-y-auto` and a reasonable max-height (calc(100vh - 200px) or similar)
- Min-width of the column: `w-72` (288px) -- standard Kanban column width
- Background: bg-muted/30 rounded-lg, with p-2 for the task area
- When column is empty, show a subtle drop zone hint ("Drop tasks here" text, dashed border area) so users know they can drop

**KanbanBoard.tsx** -- Main board orchestrator with DndContext.

Props: `projectId`, `workspaceId`.

State and queries:
- `useQuery(api.tasks.listByProject, { projectId, hideCompleted })` for tasks
- `useQuery(api.taskStatuses.listByWorkspace, { workspaceId })` for columns
- `useState` for hideCompleted (default true, matching list view behavior)
- `useState<Id<"tasks"> | null>` for selectedTaskId (for TaskDetailSheet)
- `useState` for activeDragId (the task being dragged)

Sensors:
```typescript
const sensors = useSensors(
  useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),
  useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
);
```

Drag handlers:

`handleDragStart`: Set activeDragId to the dragged task's _id.

`handleDragOver`: When a task crosses into a different column during drag, we need to track the container change. Use the `over` element's data to determine which column it's in. This is handled by dnd-kit automatically since each column is a SortableContext -- just let the library manage the visual during drag.

`handleDragEnd`:
1. Get the active task and the over target
2. Determine the destination column (statusId): look at `over.data.current?.sortable?.containerId` or if over target is a column droppable ID directly, use that
3. Get tasks currently in the destination column, sorted by position
4. Calculate the insertion index from `over.data.current?.sortable?.index`
5. Calculate new position using `generateKeyBetween()`:
   - Get the task before the insertion point: `columnTasks[insertIndex - 1]?.position ?? null`
   - Get the task after the insertion point: `columnTasks[insertIndex]?.position ?? null`
   - But EXCLUDE the dragged task itself from the column tasks when calculating (it may already be in this column)
   - `const newPosition = generateKeyBetween(before, after)`
6. Call `updatePosition({ taskId: active.id, statusId: destinationStatusId, position: newPosition })`
7. Clear activeDragId

Optimistic update on the `updatePosition` mutation:
```typescript
const updatePosition = useMutation(api.tasks.updatePosition)
  .withOptimisticUpdate((localStore, { taskId, statusId, position }) => {
    const currentTasks = localStore.getQuery(api.tasks.listByProject, {
      projectId,
      hideCompleted,
    });
    if (currentTasks === undefined) return;

    const updatedTasks = currentTasks.map((task) =>
      task._id === taskId
        ? { ...task, statusId, position }
        : task
    );
    localStore.setQuery(api.tasks.listByProject, { projectId, hideCompleted }, updatedTasks);
  });
```

**Important optimistic update note:** The args passed to `withOptimisticUpdate` must exactly match the args passed to the query being updated. Make sure `hideCompleted` matches what was passed to the `useQuery` call. Since hideCompleted is state, capture it in the closure.

Layout:
- Horizontal scrolling container: `flex gap-4 overflow-x-auto pb-4` with `min-h-[calc(100vh-200px)]`
- Each KanbanColumn rendered in order (sorted by status.order)
- Hide-completed checkbox in a toolbar above the board
- DragOverlay renders `<KanbanCardPresenter isDragging />` for the active task

Group tasks by statusId for each column:
```typescript
const tasksByStatus = useMemo(() => {
  const grouped: Record<string, typeof tasks> = {};
  for (const status of statuses) {
    grouped[status._id] = [];
  }
  for (const task of tasks) {
    if (grouped[task.statusId]) {
      grouped[task.statusId].push(task);
    }
    // If task's status not in columns (shouldn't happen), skip
  }
  // Sort each group by position
  for (const key of Object.keys(grouped)) {
    grouped[key].sort((a, b) =>
      (a.position ?? '').localeCompare(b.position ?? '') || a._creationTime - b._creationTime
    );
  }
  return grouped;
}, [tasks, statuses]);
```

Render TaskDetailSheet at the bottom of KanbanBoard (same pattern as Tasks.tsx), passing selectedTaskId.

Collision detection: Use `closestCorners` from @dnd-kit/core (better than closestCenter for multi-container Kanban layouts -- it detects column boundaries more reliably when dragging between columns).
  </action>
  <verify>
1. `npm run lint` passes
2. All four component files exist and export their components
3. `npm run build` succeeds (TypeScript compilation passes)
  </verify>
  <done>
- KanbanCardPresenter renders task card with priority icon, assignee avatar, labels
- KanbanCard wraps presenter with useSortable hook, shows placeholder when dragging
- KanbanColumn renders droppable area with SortableContext, shows tasks sorted by position
- KanbanBoard orchestrates DndContext with sensors, drag handlers, optimistic updates, and TaskDetailSheet
- DragOverlay shows lifted card during drag
- Tasks grouped by statusId and sorted by position within each column
  </done>
</task>

<task type="auto">
  <name>Task 2: Add list/board view toggle to ProjectDetails page</name>
  <files>
    src/pages/App/Project/ProjectDetails.tsx
    src/pages/App/Project/Tasks.tsx
  </files>
  <action>
**ProjectDetails.tsx changes:**

1. Import `KanbanBoard` from `./KanbanBoard`
2. Import `Tabs, TabsList, TabsTrigger, TabsContent` from `@/components/ui/tabs` (shadcn tabs component -- check if already in the project; if not, the Tabs component should already be available as a radix primitive is in deps)
3. Import `LayoutList, Kanban` icons from `lucide-react`

4. Add view state: `const [view, setView] = useState<"list" | "board">("board")` -- default to board view since this is the Kanban phase

5. Replace the current `<Tasks ... />` render with a tabbed view:
```tsx
<Tabs value={view} onValueChange={(v) => setView(v as "list" | "board")}>
  <div className="flex items-center justify-between mb-4">
    <TabsList>
      <TabsTrigger value="board" className="flex items-center gap-2">
        <Kanban className="h-4 w-4" />
        Board
      </TabsTrigger>
      <TabsTrigger value="list" className="flex items-center gap-2">
        <LayoutList className="h-4 w-4" />
        List
      </TabsTrigger>
    </TabsList>
  </div>

  <TabsContent value="board" className="mt-0">
    <KanbanBoard projectId={projectId} workspaceId={workspaceId} />
  </TabsContent>

  <TabsContent value="list" className="mt-0">
    <Tasks projectId={projectId} workspaceId={workspaceId} />
  </TabsContent>
</Tabs>
```

6. For the board view, the container needs to allow horizontal overflow. Update the outer container's max-width: when in board view, use `max-w-full` instead of `max-w-5xl` to give the board room. You can conditionally apply: `className={cn("container mx-auto p-6", view === "board" ? "max-w-full" : "max-w-5xl")}`

**Tasks.tsx** -- No changes needed to the existing list view. It continues to work exactly as before. The only integration point is that it's now rendered inside a TabsContent.

**Check for Tabs component:** Verify `@radix-ui/react-tabs` is in dependencies (it is -- "1.1.13"). Check if `src/components/ui/tabs.tsx` exists. If it does NOT exist, generate it using `npx shadcn@latest add tabs` or create it manually following the shadcn pattern.
  </action>
  <verify>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Navigate to a project page -- should see Board/List toggle tabs
4. Board tab shows Kanban columns, List tab shows the existing task list
5. Dragging a task between columns changes its status
6. Clicking a card on the board opens the TaskDetailSheet
  </verify>
  <done>
- ProjectDetails shows Board/List view toggle with Kanban and LayoutList icons
- Board view renders KanbanBoard component with full drag-drop functionality
- List view renders existing Tasks component unchanged
- Board view defaults to active (board tab selected by default)
- Container width adjusts for board view (full width) vs list view (max-w-5xl)
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors
2. `npm run build` succeeds
3. Project page shows Board/List toggle -- Board is default
4. Board view shows columns for each status (To Do, In Progress, Done)
5. Tasks appear as cards in their status columns
6. Dragging a card between columns changes the task's status
7. Dragging a card within a column reorders it
8. Drag feels instant (optimistic update, no flicker)
9. Clicking a card opens TaskDetailSheet
10. Switching to List view shows the existing task list UI
11. Real-time: changes from other clients reflect automatically (Convex reactive queries)
</verification>

<success_criteria>
- Kanban board renders with status columns and task cards
- Drag-drop works between columns (status change) and within columns (reorder)
- Optimistic updates make drag operations feel instant
- TaskDetailSheet opens on card click
- List/Board toggle works on project page
- No regressions to existing list view functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-kanban-board-view/03-02-SUMMARY.md`
</output>
