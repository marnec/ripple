---
phase: 03-kanban-board-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/tasks.ts
  - convex/taskStatuses.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Tasks have a position field for ordering within status columns"
    - "Creating a task assigns it a position at the end of the default status column"
    - "Updating a task can change both statusId and position in one call"
    - "dnd-kit and fractional-indexing libraries are installed and importable"
  artifacts:
    - path: "convex/schema.ts"
      provides: "position field on tasks table, by_project_status_position index"
      contains: "position"
    - path: "convex/tasks.ts"
      provides: "Updated create (with position), update (with position), listByProject (sorted by position)"
      exports: ["create", "update", "listByProject"]
    - path: "convex/taskStatuses.ts"
      provides: "reorderColumns mutation for bulk column reorder"
      exports: ["reorderColumns"]
    - path: "package.json"
      provides: "dnd-kit and fractional-indexing deps"
      contains: "@dnd-kit/core"
  key_links:
    - from: "convex/tasks.ts (create)"
      to: "fractional-indexing"
      via: "generateKeyBetween for initial position"
      pattern: "generateKeyBetween"
    - from: "convex/tasks.ts (update)"
      to: "convex/schema.ts"
      via: "position field in patch"
      pattern: "position"
---

<objective>
Add task ordering infrastructure (position field, indexes) and install drag-drop dependencies.

Purpose: The Kanban board needs tasks to have a position within each status column. This plan adds the `position` field with fractional indexing support, updates backend mutations, and installs the dnd-kit libraries that Plan 02 will use for the UI.

Output: Updated schema with position field, updated task mutations that handle position, installed npm packages.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-kanban-board-view/03-RESEARCH.md
@convex/schema.ts
@convex/tasks.ts
@convex/taskStatuses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and fractional-indexing dependencies</name>
  <files>package.json</files>
  <action>
Install the required npm packages:

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities fractional-indexing
```

Verify the packages are in `dependencies` in package.json after install.
  </action>
  <verify>Run `npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities fractional-indexing` and confirm all four resolve without errors.</verify>
  <done>All four packages (@dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities, fractional-indexing) appear in package.json dependencies and resolve correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add position field to schema and update backend mutations</name>
  <files>convex/schema.ts, convex/tasks.ts, convex/taskStatuses.ts</files>
  <action>
**convex/schema.ts changes:**
1. Add `position: v.optional(v.string())` to the tasks table definition. Use `v.optional()` because existing tasks won't have position values yet -- the board will handle null positions gracefully.
2. Add a new index: `.index("by_project_status_position", ["projectId", "statusId", "position"])` to the tasks table. Keep all existing indexes.

**convex/tasks.ts changes:**

1. **Import fractional-indexing** at the top: `import { generateKeyBetween } from "fractional-indexing";`

2. **Update `create` mutation:**
   - Add `position: v.optional(v.string())` to args
   - After determining the statusId (existing logic), calculate position if not provided:
     - Query tasks in the same project+status using the new `by_project_status_position` index, collect all, find the last one's position
     - Call `generateKeyBetween(lastTask?.position ?? null, null)` to get a position at the end
     - If position IS provided in args, use that directly
   - Include `position` in the `ctx.db.insert()` call

3. **Update `update` mutation:**
   - Add `position: v.optional(v.string())` to the args validator
   - Add position to the patch building logic: `if (position !== undefined) patch.position = position;`
   - Destructure `position` from args alongside other fields

4. **Update `listByProject` query:**
   - After enriching tasks, change the sort to: sort all tasks by position within each status group. Tasks with no position should sort after tasks with positions (fallback to `_creationTime` for legacy tasks without position).
   - Sorting logic: `enrichedTasks.sort((a, b) => { const posA = a.position ?? ''; const posB = b.position ?? ''; return posA.localeCompare(posB) || a._creationTime - b._creationTime; })`

5. **Add `updatePosition` mutation** (a lightweight mutation for drag-drop that only updates statusId + position, keeping the update fast):
   ```typescript
   export const updatePosition = mutation({
     args: {
       taskId: v.id("tasks"),
       statusId: v.id("taskStatuses"),
       position: v.string(),
     },
     returns: v.null(),
     handler: async (ctx, { taskId, statusId, position }) => {
       const userId = await getAuthUserId(ctx);
       if (!userId) throw new ConvexError("Not authenticated");

       const task = await ctx.db.get(taskId);
       if (!task) throw new ConvexError("Task not found");

       // Auth: validate membership
       const membership = await ctx.db
         .query("projectMembers")
         .withIndex("by_project_user", (q) =>
           q.eq("projectId", task.projectId).eq("userId", userId)
         )
         .first();
       if (!membership) throw new ConvexError("Not a member of this project");

       // Look up status to update completed field
       const newStatus = await ctx.db.get(statusId);
       if (!newStatus) throw new ConvexError("Status not found");

       await ctx.db.patch(taskId, {
         statusId,
         position,
         completed: newStatus.isCompleted,
       });

       return null;
     },
   });
   ```

**convex/taskStatuses.ts changes:**

Add a `reorderColumns` mutation for bulk column reorder (reassigns sequential integer `order` values):

```typescript
export const reorderColumns = mutation({
  args: {
    statusIds: v.array(v.id("taskStatuses")),
  },
  returns: v.null(),
  handler: async (ctx, { statusIds }) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new ConvexError("Not authenticated");

    // Validate all statuses exist and belong to same workspace
    if (statusIds.length === 0) return null;

    const firstStatus = await ctx.db.get(statusIds[0]);
    if (!firstStatus) throw new ConvexError("Status not found");

    // Permission check
    const membership = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_user", (q) =>
        q.eq("workspaceId", firstStatus.workspaceId).eq("userId", userId)
      )
      .first();
    if (!membership) throw new ConvexError("Not a member of this workspace");

    // Reassign order values sequentially
    for (let i = 0; i < statusIds.length; i++) {
      await ctx.db.patch(statusIds[i], { order: i });
    }

    return null;
  },
});
```

**Important:** After making schema changes, run `npx convex dev` or let the dev server pick up the changes. The `position` field being `v.optional()` means existing tasks are unaffected -- they will have `undefined` position which sorts correctly via the fallback.
  </action>
  <verify>
1. Run `npm run lint` -- should pass with 0 errors
2. Run `npx convex dev --once` (or confirm the dev server syncs) to push schema changes
3. Verify the tasks table has the new `by_project_status_position` index in the Convex dashboard or by checking schema pushes without errors
  </verify>
  <done>
- tasks table has `position: v.optional(v.string())` field and `by_project_status_position` index
- `tasks.create` assigns fractional position at end of status column when position not provided
- `tasks.update` accepts and patches position field
- `tasks.updatePosition` mutation exists for lightweight drag-drop updates (statusId + position + completed)
- `taskStatuses.reorderColumns` mutation exists for bulk column reorder
- `tasks.listByProject` sorts tasks by position within status groups
- All existing functionality (list view, task detail, etc.) continues to work
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. Schema deploys without errors (new position field + index)
3. Existing task list view still works (position is optional, so backward compatible)
4. Creating a new task via the existing UI assigns a position value
</verification>

<success_criteria>
- position field exists on tasks with by_project_status_position index
- tasks.create assigns fractional position automatically
- tasks.updatePosition mutation available for drag-drop
- taskStatuses.reorderColumns mutation available for column management
- dnd-kit and fractional-indexing packages installed
- No regressions in existing task list functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-kanban-board-view/03-01-SUMMARY.md`
</output>
