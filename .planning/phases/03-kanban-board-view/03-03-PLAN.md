---
phase: 03-kanban-board-view
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/pages/App/Project/KanbanBoard.tsx
  - src/pages/App/Project/KanbanColumn.tsx
  - src/pages/App/Project/AddColumnDialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can add a new status column to the board"
    - "User can rename an existing status column"
    - "User can reorder status columns on the board"
    - "User can delete an empty status column (that has no tasks)"
    - "Column changes persist and sync in real-time"
  artifacts:
    - path: "src/pages/App/Project/AddColumnDialog.tsx"
      provides: "Dialog for creating new status columns"
      min_lines: 40
    - path: "src/pages/App/Project/KanbanColumn.tsx"
      provides: "Column header with rename, delete, and reorder actions"
      contains: "DropdownMenu"
    - path: "src/pages/App/Project/KanbanBoard.tsx"
      provides: "Add column button, column reorder handlers"
      contains: "AddColumnDialog"
  key_links:
    - from: "AddColumnDialog.tsx"
      to: "convex/taskStatuses.ts (create)"
      via: "useMutation for creating new status"
      pattern: "api\\.taskStatuses\\.create"
    - from: "KanbanColumn.tsx"
      to: "convex/taskStatuses.ts (update)"
      via: "useMutation for renaming column"
      pattern: "api\\.taskStatuses\\.update"
    - from: "KanbanBoard.tsx"
      to: "convex/taskStatuses.ts (reorderColumns)"
      via: "useMutation for column reorder"
      pattern: "api\\.taskStatuses\\.reorderColumns"
---

<objective>
Add column management features: create, rename, reorder, and delete status columns.

Purpose: Requirement KANBAN-04 asks users to customize columns beyond the default three. This plan adds the UI for managing status columns directly from the Kanban board -- adding new columns, renaming headers inline, reordering via arrow buttons, and deleting empty columns.

Output: AddColumnDialog component, enhanced KanbanColumn with management actions, updated KanbanBoard with column controls.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-kanban-board-view/03-RESEARCH.md
@.planning/phases/03-kanban-board-view/03-02-SUMMARY.md
@convex/taskStatuses.ts
@src/pages/App/Project/KanbanBoard.tsx
@src/pages/App/Project/KanbanColumn.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add column management UI (create, rename, reorder, delete)</name>
  <files>
    src/pages/App/Project/AddColumnDialog.tsx
    src/pages/App/Project/KanbanColumn.tsx
    src/pages/App/Project/KanbanBoard.tsx
  </files>
  <action>
**AddColumnDialog.tsx** -- Dialog for creating a new status column.

Props: `workspaceId`, `open`, `onOpenChange`.

Implementation:
- Use shadcn Dialog with form fields:
  - Name: text input (required, placeholder "e.g. Review, QA, Blocked")
  - Color: color picker with the same 8 Tailwind colors used for projects (bg-blue-500, bg-green-500, bg-yellow-500, bg-red-500, bg-purple-500, bg-pink-500, bg-orange-500, bg-teal-500). Display as clickable color circles with ring-2 for selection (same pattern as CreateProjectDialog).
  - "Marks tasks as completed" toggle: a Checkbox. When checked, tasks moved to this column will be marked as completed. Default: unchecked.
- Submit calls `useMutation(api.taskStatuses.create)` with `{ workspaceId, name, color, isCompleted }`.
- After successful creation, close the dialog and clear form.
- Validate: name must be non-empty, trim whitespace.

**KanbanColumn.tsx changes** -- Add column header actions.

Add to the column header area (next to the column name and count badge):
1. **Three-dot dropdown menu** (DropdownMenu from shadcn) with actions:
   - "Rename" -- opens inline edit mode
   - "Move Left" -- reorders column left (disabled if first column)
   - "Move Right" -- reorders column right (disabled if last column)
   - Separator
   - "Delete Column" -- removes column (disabled if column has tasks, shows "Has tasks" tooltip; also disabled if column isDefault)

2. **Inline rename mode:**
   - When "Rename" is clicked, replace the column name text with an Input
   - On blur or Enter, call `useMutation(api.taskStatuses.update)` with new name
   - On Escape, cancel edit and restore original name
   - Track rename state with `const [isRenaming, setIsRenaming] = useState(false)` and `const [renameValue, setRenameValue] = useState("")`

3. **Move Left/Right:**
   - Accept `onMoveLeft` and `onMoveRight` callbacks from KanbanBoard
   - Also accept `isFirst` and `isLast` booleans to disable buttons appropriately

4. **Delete:**
   - Accept `onDelete` callback from KanbanBoard
   - Accept `canDelete` boolean (false if column has tasks or is default)
   - Show confirmation dialog before delete: "Delete '[name]' column? This cannot be undone."

New props for KanbanColumn:
```typescript
type KanbanColumnProps = {
  status: { _id: Id<"taskStatuses">; name: string; color: string; order: number; isDefault: boolean };
  tasks: EnrichedTask[];
  onTaskClick: (taskId: Id<"tasks">) => void;
  onMoveLeft?: () => void;
  onMoveRight?: () => void;
  onDelete?: () => void;
  isFirst: boolean;
  isLast: boolean;
  canDelete: boolean;
};
```

**KanbanBoard.tsx changes** -- Wire column management.

1. **Add "+" column button** at the end of the columns row:
   - A `w-72` placeholder column with dashed border, centered "+" icon and "Add Column" text
   - Clicking opens AddColumnDialog
   - `const [showAddColumn, setShowAddColumn] = useState(false)`

2. **Column reorder handlers:**
   ```typescript
   const handleMoveColumn = async (statusId: Id<"taskStatuses">, direction: "left" | "right") => {
     const sortedStatuses = [...statuses].sort((a, b) => a.order - b.order);
     const currentIndex = sortedStatuses.findIndex(s => s._id === statusId);
     const targetIndex = direction === "left" ? currentIndex - 1 : currentIndex + 1;

     if (targetIndex < 0 || targetIndex >= sortedStatuses.length) return;

     // Swap positions in the array
     const reordered = [...sortedStatuses];
     [reordered[currentIndex], reordered[targetIndex]] = [reordered[targetIndex], reordered[currentIndex]];

     // Call reorderColumns with new order
     await reorderColumns({ statusIds: reordered.map(s => s._id) });
   };
   ```

3. **Column delete handler:**
   ```typescript
   const handleDeleteColumn = async (statusId: Id<"taskStatuses">) => {
     await removeStatus({ statusId });
   };
   ```
   Wire `useMutation(api.taskStatuses.remove)` as `removeStatus`.

4. **Pass props to each KanbanColumn:**
   - `onMoveLeft={() => handleMoveColumn(status._id, "left")}`
   - `onMoveRight={() => handleMoveColumn(status._id, "right")}`
   - `onDelete={() => handleDeleteColumn(status._id)}`
   - `isFirst={index === 0}`
   - `isLast={index === sortedStatuses.length - 1}`
   - `canDelete={!status.isDefault && (tasksByStatus[status._id]?.length ?? 0) === 0}`

5. Wire `useMutation(api.taskStatuses.reorderColumns)` as `reorderColumns`.
6. Render `<AddColumnDialog workspaceId={workspaceId} open={showAddColumn} onOpenChange={setShowAddColumn} />`.

**Component imports needed:**
- DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator from shadcn
- Dialog components for delete confirmation
- MoreHorizontal icon from lucide-react for the three-dot menu
- ChevronLeft, ChevronRight, Pencil, Trash2, Plus icons from lucide-react
  </action>
  <verify>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Click the "Add Column" button at end of board -- dialog opens, create a new column
4. New column appears on the board
5. Click three-dot menu on a column header -- Rename, Move Left, Move Right, Delete options visible
6. Rename a column -- name updates
7. Move a column left/right -- column moves
8. Delete an empty column -- column removed (disabled for columns with tasks)
  </verify>
  <done>
- AddColumnDialog lets users create new status columns with name, color, and completion flag
- Column headers have three-dot menu with Rename, Move Left, Move Right, Delete
- Inline rename works with Enter to confirm, Escape to cancel
- Column reorder uses arrow actions (Move Left / Move Right)
- Delete is disabled for default column and columns with tasks
- Add Column button appears at end of column row
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete Kanban board</name>
  <what-built>
Complete Kanban board with:
- Status columns displaying task cards
- Drag-and-drop between columns (status change) and within columns (reorder)
- Optimistic updates for instant drag feedback
- List/Board view toggle on project page
- Column management: add, rename, reorder, delete columns
- Task detail sheet opens on card click
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and navigate to a project page
2. **View toggle:** Verify Board/List tabs appear. Board should be default. Switch between them -- both should work.
3. **Board layout:** Verify columns appear for each status (To Do, In Progress, Done by default). Each column shows its task count.
4. **Task cards:** Verify cards show title, priority icon, assignee avatar, and labels.
5. **Drag between columns:** Drag a task from "To Do" to "In Progress". It should move instantly (optimistic update). The task's status should update.
6. **Drag within column:** Drag a task up or down within a column. Order should persist after refresh.
7. **Card click:** Click a task card. TaskDetailSheet should slide open from the right.
8. **Add column:** Click "Add Column" at end of board. Create a new column (e.g., "Review"). It should appear on the board.
9. **Rename column:** Click three-dot menu on "Review" column, click Rename, type new name, press Enter.
10. **Reorder column:** Click three-dot menu, click Move Left/Right. Column should move.
11. **Delete column:** Click three-dot menu on the empty column, click Delete, confirm. Column removed.
12. **Real-time:** Open a second browser tab with the same project. Make changes in one tab, verify they appear in the other.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors
2. `npm run build` succeeds
3. All KANBAN requirements met:
   - KANBAN-01: Board view with status columns (verified visually)
   - KANBAN-02: Drag-drop between columns changes status (verified by dragging)
   - KANBAN-03: Real-time updates (verified with two browser tabs)
   - KANBAN-04: Add, rename, reorder columns (verified via column management UI)
   - KANBAN-05: Drag-drop within column reorders tasks (verified by dragging)
</verification>

<success_criteria>
- Column management UI complete: add, rename, reorder, delete
- All five KANBAN requirements satisfied
- Visual checkpoint passed by user
- No regressions in existing task functionality (list view, task detail, My Tasks)
</success_criteria>

<output>
After completion, create `.planning/phases/03-kanban-board-view/03-03-SUMMARY.md`
</output>
