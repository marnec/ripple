---
phase: 09-user-mentions-in-chat
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/chatNotifications.ts
  - convex/messages.ts
autonomous: true

must_haves:
  truths:
    - "Mentioned users receive push notification when message is sent"
    - "Notification says 'Alice mentioned you in #general' with channel name"
    - "Self-mentions do not create notifications"
    - "Editing a message does NOT re-notify mentioned users"
  artifacts:
    - path: "convex/chatNotifications.ts"
      provides: "Chat-specific mention notification action"
      contains: "notifyMessageMentions"
    - path: "convex/messages.ts"
      provides: "Mention extraction and notification scheduling in send mutation"
      contains: "extractMentionedUserIds"
  key_links:
    - from: "convex/messages.ts"
      to: "convex/utils/blocknote.ts"
      via: "import extractMentionedUserIds"
      pattern: "extractMentionedUserIds"
    - from: "convex/messages.ts"
      to: "convex/chatNotifications.ts"
      via: "ctx.scheduler.runAfter for mention notifications"
      pattern: "internal\\.chatNotifications\\.notifyMessageMentions"
    - from: "convex/chatNotifications.ts"
      to: "convex/pushNotifications.ts"
      via: "same webpush pattern"
      pattern: "webpush\\.sendNotification"
---

<objective>
Create chat-specific notification action and wire messages.send to extract @mentions and schedule push notifications.

Purpose: Enables MENT-04 and MENT-05 -- mentioned users receive push notifications ("Alice mentioned you in #general") and self-mentions are filtered. Only new messages trigger notifications (not edits).

Output: New chatNotifications.ts action, updated messages.send mutation with mention extraction.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-user-mentions-in-chat/09-RESEARCH.md

# Key source files to read before implementing
@convex/messages.ts
@convex/taskNotifications.ts
@convex/pushNotifications.ts
@convex/utils/blocknote.ts
@convex/channels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chatNotifications.ts action</name>
  <files>convex/chatNotifications.ts</files>
  <action>
Create `convex/chatNotifications.ts` -- a chat-specific notification action adapted from `convex/taskNotifications.ts`.

The file must start with `"use node";` (required for web-push in Convex actions).

Create an `internalAction` named `notifyMessageMentions` with these args:
- `messageId`: `v.id("messages")` -- the message that contains mentions
- `mentionedUserIds`: `v.array(v.string())` -- user IDs extracted from BlockNote JSON
- `channelId`: `v.id("channels")` -- for building notification text and URL
- `mentionedBy`: `v.object({ name: v.string(), id: v.id("users") })` -- the message author

Handler logic (follow the exact pattern from taskNotifications.ts):
1. Query the channel: `await ctx.runQuery(api.channels.get, { id: channelId })`. If not found, log error and return null.
2. Query the message: `await ctx.runQuery(api.messages.getById, { id: messageId })`. Use the message's `plainText` field for notification body preview. If not found, use "New mention in chat" as fallback body.

   NOTE: There is no `messages.getById` query currently. Instead of creating one, just use a fallback body text "New mention in chat". This keeps the change minimal.

   Actually, simpler approach: pass the `plainText` as an arg to avoid needing a query. Add `plainText: v.string()` to args.

3. Build notification JSON:
   ```
   title: `${mentionedBy.name} mentioned you in #${channel.name}`
   body: plainText (truncated to 100 chars if longer)
   data.url: `/workspaces/${channel.workspaceId}/channels/${channelId}`
   ```

4. Get push subscriptions: `await ctx.runQuery(api.pushSubscription.usersSubscriptions, { usersIds: mentionedUserIds as any })`

5. Setup VAPID credentials from env vars (VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY). If any missing, log error and return null.

6. Send notifications via `webpush.sendNotification()` with `Promise.allSettled()` (same pattern as taskNotifications.ts).

7. Return `v.null()`.

IMPORTANT: This must be an `internalAction` (not `action`) since it's called via `ctx.scheduler.runAfter` from a mutation, not from the client.
  </action>
  <verify>Run `npm run lint` -- no TypeScript errors. Verify the file uses `internalAction`, has `"use node"` directive, and follows the webpush notification pattern from taskNotifications.ts.</verify>
  <done>chatNotifications.ts exists with notifyMessageMentions internalAction that sends push notifications with "mentioned you in #channelName" format.</done>
</task>

<task type="auto">
  <name>Task 2: Wire messages.send to extract mentions and schedule notifications</name>
  <files>convex/messages.ts</files>
  <action>
Update the `messages.send` mutation to extract @mentions from the message body and schedule chat notifications.

1. Add imports at the top of the file:
   ```
   import { internal } from "./_generated/api";
   import { extractMentionedUserIds } from "./utils/blocknote";
   ```

2. In the `send` mutation handler, AFTER the `ctx.db.insert("messages", ...)` call (which returns the new message ID -- capture it as `const messageId = await ctx.db.insert(...)`) and BEFORE the existing `ctx.scheduler.runAfter(0, api.pushNotifications.sendPushNotification, ...)` call:

   ```typescript
   // Extract @mentions and schedule chat mention notifications
   const mentionedUserIds = extractMentionedUserIds(body);
   const filteredMentions = mentionedUserIds.filter(id => id !== userId);

   if (filteredMentions.length > 0) {
     await ctx.scheduler.runAfter(0, internal.chatNotifications.notifyMessageMentions, {
       messageId,
       mentionedUserIds: filteredMentions,
       channelId,
       plainText,
       mentionedBy: {
         name: user.name || user.email || "Someone",
         id: userId,
       },
     });
   }
   ```

3. The existing `ctx.db.insert` on line ~104 currently doesn't capture the return value. Change it to:
   ```
   const messageId = await ctx.db.insert("messages", { ... });
   ```

IMPORTANT: Do NOT add mention extraction to the `update` mutation. Per research recommendation, v1 only notifies on message creation, not edits. This avoids re-notification spam.

IMPORTANT: The existing `ctx.scheduler.runAfter(0, api.pushNotifications.sendPushNotification, ...)` call (channel-level notification) MUST remain. The mention notification is ADDITIONAL, not a replacement. Both fire: one notifies all channel members about the new message, the other notifies specifically mentioned users.
  </action>
  <verify>Run `npm run lint` -- no TypeScript errors. Verify messages.send captures messageId from insert, imports extractMentionedUserIds and internal, filters out self-mentions, and schedules chatNotifications.notifyMessageMentions only when mentions exist.</verify>
  <done>messages.send mutation extracts @mentions from body, filters self-mentions, and schedules chat notification action. messages.update remains unchanged (no edit notifications).</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. chatNotifications.ts exists with notifyMessageMentions internalAction
4. messages.send extracts mentions, filters self, schedules notifications
5. messages.update does NOT extract mentions or send notifications
6. Notification title format: "Alice mentioned you in #general"
7. Self-mentions filtered: mentionedUserIds.filter(id => id !== userId)
</verification>

<success_criteria>
- Sending a message with @mentions triggers push notification to mentioned users
- Notification shows "AuthorName mentioned you in #channelName"
- Mentioning yourself does not send you a notification
- Editing a message with @mentions does NOT re-trigger notifications
- Existing channel-level push notification still fires alongside mention notifications
- No TypeScript errors, lint passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-mentions-in-chat/09-02-SUMMARY.md`
</output>
