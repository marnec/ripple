---
phase: 09-user-mentions-in-chat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/App/Chat/MessageComposer.tsx
  - src/pages/App/Chat/MessageRenderer.tsx
  - src/pages/App/Chat/UserMentionRenderer.tsx
autonomous: true

must_haves:
  truths:
    - "User can type @ in chat composer and see autocomplete dropdown of workspace members"
    - "User can select a member from autocomplete to insert styled @mention chip"
    - "@mention chips render with user name in both composer and sent messages"
  artifacts:
    - path: "src/pages/App/Chat/MessageComposer.tsx"
      provides: "BlockNote schema with userMention + @ SuggestionMenuController"
      contains: "userMention"
    - path: "src/pages/App/Chat/MessageRenderer.tsx"
      provides: "Rendering userMention inline content in message display"
      contains: "userMention"
    - path: "src/pages/App/Chat/UserMentionRenderer.tsx"
      provides: "Lightweight @mention rendering for message lists"
      contains: "UserMentionRenderer"
  key_links:
    - from: "src/pages/App/Chat/MessageComposer.tsx"
      to: "src/pages/App/Project/CustomInlineContent/UserMention.tsx"
      via: "import for BlockNote schema"
      pattern: "import.*UserMention.*from.*CustomInlineContent"
    - from: "src/pages/App/Chat/MessageComposer.tsx"
      to: "convex/workspaceMembers.ts"
      via: "useQuery for autocomplete data"
      pattern: "api\\.workspaceMembers\\.membersByWorkspace"
    - from: "src/pages/App/Chat/MessageRenderer.tsx"
      to: "src/pages/App/Chat/UserMentionRenderer.tsx"
      via: "import for rendering mentions in messages"
      pattern: "import.*UserMentionRenderer"
---

<objective>
Add @user mention autocomplete to the chat composer and render @mention chips in sent messages.

Purpose: Enables MENT-01, MENT-02, MENT-03 -- the core @mention UX in chat. Users type @, see workspace members, select one, and the mention renders as a styled chip in both the composer and message display.

Output: Updated MessageComposer with @ trigger, updated MessageRenderer with userMention case, new UserMentionRenderer component.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-user-mentions-in-chat/09-RESEARCH.md

# Key source files to read before implementing
@src/pages/App/Chat/MessageComposer.tsx
@src/pages/App/Chat/MessageRenderer.tsx
@src/pages/App/Project/CustomInlineContent/UserMention.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add userMention to MessageComposer schema and @ autocomplete</name>
  <files>src/pages/App/Chat/MessageComposer.tsx</files>
  <action>
Extend the existing chat BlockNote schema and add a second SuggestionMenuController for @ mentions.

1. Import `UserMention` from `../Project/CustomInlineContent/UserMention` (this component already exists from Phase 06.1).

2. Add `userMention: UserMention` to the `inlineContentSpecs` object in the schema (line ~40-47), alongside existing `taskMention` and `projectReference`.

3. Add workspace members query for autocomplete data:
   ```
   const workspaceMembers = useQuery(api.workspaceMembers.membersByWorkspace, { workspaceId });
   const currentUser = useQuery(api.users.viewer);
   ```

4. Add a SECOND `SuggestionMenuController` inside `BlockNoteView` (after the existing `#` trigger one, around line 310), with `triggerCharacter={"@"}`. The `getItems` callback should:
   - Return empty array if workspaceMembers or currentUser is undefined
   - Filter members by query string (case-insensitive match on name)
   - Filter OUT current user (self-mentions still insertable but won't appear in autocomplete)
   - Limit to 10 results
   - Each item: `title` = member name, `onItemClick` inserts `{ type: "userMention", props: { userId: member._id } }` followed by a space, `group` = "Members"
   - For the icon, use a simple User icon from lucide-react (`<User className="h-4 w-4" />`)

5. Import `User` from `lucide-react` (already a project dependency).

IMPORTANT: Do NOT remove the existing `#` SuggestionMenuController. Both must coexist inside BlockNoteView. BlockNote supports multiple SuggestionMenuController instances with different trigger characters.
  </action>
  <verify>Run `npm run lint` -- no TypeScript errors. Verify the schema includes `userMention` and there are two SuggestionMenuController instances (one for `#`, one for `@`).</verify>
  <done>MessageComposer schema includes userMention inline content. Typing @ in chat composer triggers autocomplete dropdown showing workspace members. Selecting a member inserts a styled @mention chip in the editor.</done>
</task>

<task type="auto">
  <name>Task 2: Add userMention rendering to MessageRenderer</name>
  <files>src/pages/App/Chat/MessageRenderer.tsx, src/pages/App/Chat/UserMentionRenderer.tsx</files>
  <action>
Create a lightweight UserMentionRenderer component and wire it into the existing MessageRenderer switch statement.

**Step 1: Create UserMentionRenderer.tsx**

Create `src/pages/App/Chat/UserMentionRenderer.tsx`:
```tsx
import { useQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api";
import { Id } from "../../../../convex/_generated/dataModel";
import { Skeleton } from "@/components/ui/skeleton";

export const UserMentionRenderer = ({ userId }: { userId: string }) => {
  const user = useQuery(api.users.get, { id: userId as Id<"users"> });

  if (user === undefined) {
    return <Skeleton className="h-5 w-16 rounded inline-block align-middle" />;
  }

  if (user === null) {
    return (
      <span className="text-muted-foreground align-middle">@unknown-user</span>
    );
  }

  return (
    <span className="font-bold text-foreground align-middle">
      @{user.name || "Unknown"}
    </span>
  );
};
```

This is separate from the `UserMention` BlockNote inline content spec (which is used inside the editor). This lightweight component is for the message list renderer where we parse JSON manually without BlockNote overhead.

**Step 2: Update MessageRenderer.tsx**

1. Add `UserMentionContent` type to the type definitions:
   ```
   type UserMentionContent = {
     type: "userMention";
     props: { userId: string };
   };
   ```

2. Add `UserMentionContent` to the `InlineContent` union type.

3. Import `UserMentionRenderer` from `./UserMentionRenderer`.

4. Add a case to the `InlineRenderer` switch statement (after `projectReference`):
   ```
   case "userMention":
     return <UserMentionRenderer userId={content.props.userId} />;
   ```

IMPORTANT: The `content.props` access will work because the InlineContent union now includes UserMentionContent. TypeScript will narrow the type correctly in the switch case.
  </action>
  <verify>Run `npm run lint` -- no TypeScript errors. Verify MessageRenderer.tsx has `userMention` case in InlineRenderer and imports UserMentionRenderer.</verify>
  <done>Messages containing @mention inline content render the mentioned user's name as a bold @Name chip. Loading state shows skeleton, missing users show @unknown-user.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. MessageComposer schema includes `userMention` alongside `taskMention` and `projectReference`
4. Two SuggestionMenuController instances exist: `#` trigger and `@` trigger
5. MessageRenderer handles `userMention` type in its switch statement
6. UserMentionRenderer.tsx exists and handles loading/null/success states
</verification>

<success_criteria>
- Typing @ in chat composer shows autocomplete dropdown of workspace members
- Selecting a member inserts @mention chip into editor
- Sent messages with @mentions display the user's name as bold @Name text
- Current user is filtered from autocomplete suggestions
- No TypeScript errors, lint passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-mentions-in-chat/09-01-SUMMARY.md`
</output>
