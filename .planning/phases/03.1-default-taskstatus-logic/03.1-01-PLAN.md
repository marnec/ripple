---
phase: 03.1-default-taskstatus-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/projects.ts
  - convex/tasks.ts
autonomous: true

must_haves:
  truths:
    - "Default statuses (Todo, In Progress, Done) are seeded when a project is created"
    - "Every new task automatically gets the default status (Todo) when no statusId is provided"
    - "No lazy seeding happens in task creation — statuses must already exist"
    - "Setting status to Done automatically sets completed=true"
    - "Moving a task OUT of Done does NOT auto-reset completed to false"
  artifacts:
    - path: "convex/projects.ts"
      provides: "Inline status seeding at project creation"
      contains: "taskStatuses"
    - path: "convex/tasks.ts"
      provides: "Simplified default status fetch + one-way completed sync"
      contains: "isDefault"
  key_links:
    - from: "convex/projects.ts"
      to: "taskStatuses table"
      via: "ctx.db.insert in projects.create"
      pattern: 'ctx\.db\.insert\("taskStatuses"'
    - from: "convex/tasks.ts"
      to: "taskStatuses table"
      via: "default status fetch in tasks.create"
      pattern: 'isDefault.*true'
    - from: "convex/tasks.ts"
      to: "tasks table"
      via: "one-way completed sync in tasks.update and updatePosition"
      pattern: 'newStatus\.isCompleted.*true'
---

<objective>
Wire default task status logic into the backend: seed statuses at project creation, auto-assign default status to new tasks, and enforce one-way completed field sync.

Purpose: Guarantee every workspace has statuses before any task is created, enforce "no task without a status" invariant, and fix the completed sync to be one-directional (Done -> completed=true only, never auto-resets).

Output: Updated `convex/projects.ts` and `convex/tasks.ts` with correct status seeding and sync behavior.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-default-taskstatus-logic/03.1-RESEARCH.md
@convex/schema.ts
@convex/projects.ts
@convex/tasks.ts
@convex/taskStatuses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Seed default statuses in projects.create and simplify tasks.create</name>
  <files>convex/projects.ts, convex/tasks.ts</files>
  <action>
**convex/projects.ts — Add inline status seeding to `projects.create`:**

After the `projectMembers` insert (line 79), add idempotent status seeding. Statuses are workspace-scoped, so check if statuses already exist for the workspace before inserting. This handles the case where multiple projects are created in the same workspace — only the first project creation seeds statuses.

```typescript
// Seed default task statuses for workspace (idempotent — only seeds once per workspace)
const existingStatus = await ctx.db
  .query("taskStatuses")
  .withIndex("by_workspace", (q) => q.eq("workspaceId", workspaceId))
  .first();

if (!existingStatus) {
  await ctx.db.insert("taskStatuses", {
    workspaceId,
    name: "Todo",
    color: "bg-gray-500",
    order: 0,
    isDefault: true,
    isCompleted: false,
  });

  await ctx.db.insert("taskStatuses", {
    workspaceId,
    name: "In Progress",
    color: "bg-blue-500",
    order: 1,
    isDefault: false,
    isCompleted: false,
  });

  await ctx.db.insert("taskStatuses", {
    workspaceId,
    name: "Done",
    color: "bg-green-500",
    order: 2,
    isDefault: false,
    isCompleted: true,
  });
}
```

**convex/tasks.ts — Simplify `tasks.create` default status logic:**

Replace the entire lazy-seeding block (lines 50-101) with a simple default status fetch. Remove ALL seeding logic from tasks.create. The new logic:

```typescript
// If no statusId provided, fetch the default status for the workspace
let statusId = args.statusId;
if (!statusId) {
  const defaultStatus = await ctx.db
    .query("taskStatuses")
    .withIndex("by_workspace", (q) => q.eq("workspaceId", project.workspaceId))
    .filter((q) => q.eq(q.field("isDefault"), true))
    .first();

  if (!defaultStatus) {
    throw new ConvexError("No default status found for workspace. Ensure statuses are seeded.");
  }
  statusId = defaultStatus._id;
}
```

**convex/tasks.ts — Fix one-way sync in `tasks.update`:**

Replace line 383 (`patch.completed = newStatus.isCompleted;`) with one-way logic:

```typescript
patch.statusId = statusId;
// One-way sync: only auto-set completed=true when moving TO a completed status.
// Moving OUT of a completed status does NOT auto-reset completed.
// User must explicitly uncomplete the task.
if (newStatus.isCompleted) {
  patch.completed = true;
}
```

**convex/tasks.ts — Fix one-way sync in `tasks.updatePosition`:**

Replace lines 459-463 with:

```typescript
const patchData: Record<string, any> = {
  statusId,
  position,
};
// One-way sync: only auto-set completed=true when moving TO a completed status
if (newStatus.isCompleted) {
  patchData.completed = true;
}
await ctx.db.patch(taskId, patchData);
```

This ensures drag-and-drop from "Done" to "In Progress" does NOT reset `completed` to false.
  </action>
  <verify>
Run `npm run lint` — must pass with 0 errors and 0 warnings.
Run `npm run build` — must succeed.
  </verify>
  <done>
- projects.create seeds 3 default statuses (Todo, In Progress, Done) on first project creation per workspace
- Seeding is idempotent (second project in same workspace skips seeding)
- tasks.create fetches default status instead of lazy-seeding
- tasks.update only sets completed=true on move TO Done; does not reset on move away
- tasks.updatePosition same one-way sync behavior
- Lint and build pass cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end status flow with Convex dev server</name>
  <files></files>
  <action>
Run `npx convex dev --once` to push the schema and functions to the Convex dev deployment. This validates that:
1. The updated `projects.create` mutation deploys without errors
2. The updated `tasks.create` mutation deploys without errors
3. The updated `tasks.update` and `tasks.updatePosition` mutations deploy without errors
4. No type errors or schema mismatches

If `convex dev --once` is not available or fails, fall back to `npm run build` which validates TypeScript compilation of both frontend and Convex functions.

Review the Convex function output to confirm no deployment errors.
  </action>
  <verify>
`npx convex dev --once` (or `npm run build`) completes without errors.
  </verify>
  <done>
All Convex functions deploy successfully. No type errors, no schema mismatches, no runtime deployment failures.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors, 0 warnings
2. `npm run build` succeeds
3. In `convex/projects.ts`: `projects.create` contains `ctx.db.insert("taskStatuses"` calls with idempotency check
4. In `convex/tasks.ts`: `tasks.create` does NOT contain any `ctx.db.insert("taskStatuses"` calls (no lazy seeding)
5. In `convex/tasks.ts`: `tasks.update` status change block contains `if (newStatus.isCompleted)` guard (one-way sync)
6. In `convex/tasks.ts`: `tasks.updatePosition` contains same `if (newStatus.isCompleted)` guard
</verification>

<success_criteria>
- Default statuses seeded at project creation time (not task creation)
- Tasks always get default status when none provided
- Completed field only auto-set to true (never auto-reset to false)
- All lint and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-default-taskstatus-logic/03.1-01-SUMMARY.md`
</output>
