---
phase: 16-auth-resilience
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-yjs-provider.ts
  - src/pages/App/Document/CustomBlocks/DiagramBlock.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Connection status indicator turns red/disconnected when browser goes offline via DevTools or network loss"
    - "Clicking a diagram block embed in a document navigates to the diagram page"
  artifacts:
    - path: "src/hooks/use-yjs-provider.ts"
      provides: "Window offline/online event listeners for immediate connection state feedback"
      contains: "window.addEventListener.*offline"
    - path: "src/pages/App/Document/CustomBlocks/DiagramBlock.tsx"
      provides: "Click-to-navigate handler on diagram placeholder and future SVG preview"
      contains: "useNavigate"
  key_links:
    - from: "src/hooks/use-yjs-provider.ts"
      to: "window offline/online events"
      via: "useEffect with addEventListener"
      pattern: "addEventListener.*offline"
    - from: "src/pages/App/Document/CustomBlocks/DiagramBlock.tsx"
      to: "react-router-dom"
      via: "useNavigate + onClick handler"
      pattern: "navigate.*diagrams"
---

<objective>
Fix two UAT gaps: (1) connection status indicator does not respond to browser offline mode because useYjsProvider relies exclusively on WebSocket close events, and (2) DiagramBlock in documents has no click-to-navigate despite placeholder text saying "Click to view."

Purpose: Close UAT test 1 (connection indicator) and part of UAT test 3 (diagram click navigation).
Output: Working offline detection and clickable diagram blocks.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/use-yjs-provider.ts
@src/pages/App/Document/CustomBlocks/DiagramBlock.tsx
@src/routes.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add window offline/online event listeners to useYjsProvider</name>
  <files>src/hooks/use-yjs-provider.ts</files>
  <action>
Add a separate useEffect in useYjsProvider that listens for window "offline" and "online" events to provide immediate connection state feedback, independent of WebSocket close events.

The existing code only detects disconnection when the WebSocket connection actually closes, but Chrome DevTools offline mode does NOT close existing WebSockets (known Chrome limitation). The fix must detect the browser's network state change independently.

Implementation:
1. Add a new useEffect (after the existing provider effect) that:
   - Listens for window "offline" event: sets isConnected to false AND isOffline to true immediately
   - Listens for window "online" event: sets isOffline to false (isConnected will be restored by the WebSocket sync/status events when reconnection happens)
   - Only activate listeners when `enabled` is true
   - Clean up listeners on unmount

2. Also check `navigator.onLine` at the start of the connect function (inside the existing useEffect). If `!navigator.onLine` at connect time, skip connection attempt and set isOffline=true, isLoading=false immediately.

Do NOT remove or modify the existing WebSocket-based connection detection. The window events supplement the WebSocket events -- both are needed because:
- WebSocket close events catch server-side disconnects that don't trigger browser offline
- Window offline events catch DevTools offline / airplane mode that don't close WebSockets

The useEffect for offline/online listeners should be independent of the provider creation effect to avoid coupling.
  </action>
  <verify>
Run `npm run lint` -- must pass with 0 warnings.
Run `npm run build` -- must succeed.
Verify the new useEffect is present with both "offline" and "online" event listeners.
  </verify>
  <done>
Window offline event immediately sets isConnected=false and isOffline=true.
Window online event sets isOffline=false.
navigator.onLine check at connect time prevents connection attempt when already offline.
Existing WebSocket-based detection is preserved unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add click-to-navigate handler to DiagramBlock</name>
  <files>src/pages/App/Document/CustomBlocks/DiagramBlock.tsx</files>
  <action>
Add click-to-navigate functionality to DiagramBlock so clicking a diagram embed in a document opens the diagram page.

Implementation:
1. Import `useNavigate` and `useParams` from "react-router-dom"
2. In the DiagramView component, add:
   - `const navigate = useNavigate();`
   - `const { workspaceId } = useParams();`
   - A `handleClick` function: `if (diagram && workspaceId) { void navigate(\`/workspaces/${workspaceId}/diagrams/${diagramId}\`); }`
3. On the placeholder div (the one showing "Click to view or edit this diagram" around line 42), add:
   - `onClick={handleClick}`
   - `className` should include `cursor-pointer` and `hover:bg-muted/50 transition-colors`
4. Also wrap the entire DiagramView return in a clickable container for the case when SVG previews are restored (Plan 04). For now, only the placeholder div needs onClick since that's the only visible element.

Navigation should work regardless of editor editable state. The resize handles on the outer wrapper already use their own mouse handlers (mousedown/mousemove/mouseup) and won't conflict with a click on the inner content -- clicks on resize handles won't propagate to the inner div.

Match the DiagramEmbed pattern: use `void navigate(...)` for the async navigation call.
  </action>
  <verify>
Run `npm run lint` -- must pass with 0 warnings.
Run `npm run build` -- must succeed.
Verify DiagramBlock.tsx contains useNavigate import and onClick handler on the placeholder div.
  </verify>
  <done>
Clicking a diagram block embed in a document navigates to `/workspaces/{workspaceId}/diagrams/{diagramId}`.
Placeholder div has cursor-pointer and hover state.
Navigation pattern matches DiagramEmbed.tsx.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 warnings
2. `npm run build` succeeds
3. `src/hooks/use-yjs-provider.ts` contains window offline/online event listeners in a useEffect
4. `src/pages/App/Document/CustomBlocks/DiagramBlock.tsx` contains useNavigate and onClick handler
</verification>

<success_criteria>
- Connection status indicator responds immediately to browser offline/online state changes
- Diagram block embeds in documents are clickable and navigate to the diagram page
- Both changes pass lint and build
</success_criteria>

<output>
After completion, create `.planning/phases/16-auth-resilience/16-03-SUMMARY.md`
</output>
