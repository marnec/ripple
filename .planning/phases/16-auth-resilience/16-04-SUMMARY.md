---
phase: 16-auth-resilience
plan: 04
subsystem: diagrams
tags: [svg-preview, embeds, yjs-integration]
dependency_graph:
  requires: [16-03]
  provides: [diagram-svg-preview]
  affects: [document-embeds, task-embeds]
tech_stack:
  added: [excalidraw-exportToSvg]
  patterns: [periodic-svg-generation, dangerouslySetInnerHTML]
key_files:
  created: []
  modified:
    - convex/schema.ts
    - convex/diagrams.ts
    - src/pages/App/Diagram/DiagramPage.tsx
    - src/pages/App/Document/CustomBlocks/DiagramBlock.tsx
    - src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx
decisions:
  - Store actual SVG strings (not thumbnails or decoded Yjs snapshots)
  - 10-second periodic generation interval (balance between freshness and mutation load)
  - dangerouslySetInnerHTML safe because SVG from Excalidraw's own export function
  - Workspace membership auth for updateSvgPreview (follows rename/remove pattern)
metrics:
  duration: 4.5
  tasks_completed: 2
  files_modified: 5
  commits: 2
  completed_at: "2026-02-12"
---

# Phase 16 Plan 04: SVG Preview Storage Summary

**One-liner:** Store SVG strings generated by Excalidraw in Convex and render them inline in diagram embeds (documents and tasks).

## Objective

Restore diagram preview functionality lost when Phase 15 removed the content field. Store SVG preview strings in Convex when diagrams are saved, and render those SVG strings inline in DiagramBlock (documents) and DiagramEmbed (tasks).

## Implementation

### Task 1: Add svgPreview field and updateSvgPreview mutation

**Schema changes:**
- Added `svgPreview: v.optional(v.string())` to diagrams table in schema.ts
- Added svgPreview to diagramValidator in diagrams.ts (ensures queries return it)

**New mutation:**
- Created `updateSvgPreview` public mutation in diagrams.ts
- Permission check: workspace membership using `by_workspace_user` index
- Follows same auth pattern as rename/remove mutations
- Returns v.null() after patching diagram

**Files:** convex/schema.ts, convex/diagrams.ts
**Commit:** 988b08d

### Task 2: Generate SVG on diagram save and render in embeds

**SVG generation (DiagramPage.tsx):**
- Imported `exportToSvg` from @excalidraw/excalidraw
- Added `useMutation(api.diagrams.updateSvgPreview)`
- Created periodic SVG generation effect:
  - Runs every 10 seconds while connected (via setInterval)
  - Generates immediately on first connect
  - Uses `exportToSvg({ elements, appState, files })` with dark mode off and background off
  - Only saves SVG if string length > 100 (avoids empty wrappers)
  - Debounces via interval to prevent excessive mutations

**SVG rendering (DiagramBlock.tsx):**
- Check `hasSvgPreview = diagram !== undefined && diagram !== null && !!diagram.svgPreview`
- If true, render SVG with `dangerouslySetInnerHTML={{ __html: diagram.svgPreview }}`
- Applied responsive styles: `[&>svg]:w-full [&>svg]:h-auto` for scaling
- Preserved handleClick navigation from 16-03
- Fall back to placeholder when no SVG available

**SVG rendering (DiagramEmbed.tsx):**
- Same pattern as DiagramBlock
- Added max-height constraint: `[&>svg]:max-h-40` for inline task embeds
- Clickable with navigation preserved from 16-03

**Files:** src/pages/App/Diagram/DiagramPage.tsx, src/pages/App/Document/CustomBlocks/DiagramBlock.tsx, src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx
**Commit:** 0f71c66

## Key Decisions

1. **SVG strings, not thumbnails:** Per user decision, store actual SVG markup generated by Excalidraw's exportToSvg function. No image encoding, no snapshot decoding.

2. **10-second generation interval:** Balance between preview freshness and Convex mutation load. Diagrams update infrequently enough that 10s is acceptable.

3. **dangerouslySetInnerHTML is safe:** SVG strings come from Excalidraw's own export function (trusted source) and are stored/retrieved from our own Convex backend. No user-supplied HTML.

4. **Workspace membership auth:** updateSvgPreview requires workspace membership check, following the pattern established in rename/remove mutations.

5. **Graceful fallback:** Diagrams without SVG preview (legacy or not yet generated) show the existing clickable placeholder from Phase 15.

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- `npm run lint` passes with 0 warnings
- `npm run build` succeeds
- Schema has svgPreview field on diagrams table
- diagrams.ts has updateSvgPreview mutation with workspace membership auth
- DiagramPage generates SVG every 10 seconds while connected
- DiagramBlock renders SVG preview or falls back to placeholder
- DiagramEmbed renders SVG preview or falls back to placeholder
- Both embeds preserve click-to-navigate from 16-03

## Self-Check

Verifying created files and commits exist:

**Files:**
- FOUND: convex/schema.ts
- FOUND: convex/diagrams.ts
- FOUND: src/pages/App/Diagram/DiagramPage.tsx
- FOUND: src/pages/App/Document/CustomBlocks/DiagramBlock.tsx
- FOUND: src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx

**Commits:**
- FOUND: 988b08d (Task 1: add svgPreview field and updateSvgPreview mutation)
- FOUND: 0f71c66 (Task 2: generate and render SVG previews for diagram embeds)

## Self-Check: PASSED

All files exist and all commits are present in git history.
