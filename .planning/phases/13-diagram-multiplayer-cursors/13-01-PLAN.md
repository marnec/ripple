---
phase: 13-diagram-multiplayer-cursors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/canvas-coordinates.ts
  - src/hooks/use-diagram-collaboration.ts
  - src/hooks/use-diagram-cursor-awareness.ts
autonomous: true

must_haves:
  truths:
    - "Excalidraw elements sync in real-time between users via Yjs CRDTs"
    - "Diagram content persists across page refreshes via PartyKit + IndexedDB"
    - "Remote user pointer positions are tracked via Yjs Awareness API"
    - "Idle and stale pointer detection works with same timeouts as Phase 12 documents"
  artifacts:
    - path: "src/hooks/use-diagram-collaboration.ts"
      provides: "y-excalidraw binding hook with element sync and awareness"
      exports: ["useDiagramCollaboration"]
    - path: "src/hooks/use-diagram-cursor-awareness.ts"
      provides: "Excalidraw-specific awareness hook for pointer tracking"
      exports: ["useDiagramCursorAwareness"]
    - path: "src/lib/canvas-coordinates.ts"
      provides: "Screen-to-canvas coordinate transformation utilities"
      exports: ["screenToCanvas", "canvasToScreen", "getCameraFromAppState"]
  key_links:
    - from: "src/hooks/use-diagram-collaboration.ts"
      to: "src/hooks/use-yjs-provider.ts"
      via: "useYjsProvider call with resourceType diagram"
      pattern: "useYjsProvider.*diagram"
    - from: "src/hooks/use-diagram-collaboration.ts"
      to: "y-excalidraw"
      via: "ExcalidrawBinding constructor"
      pattern: "new ExcalidrawBinding"
    - from: "src/hooks/use-diagram-cursor-awareness.ts"
      to: "y-protocols/awareness"
      via: "awareness.on change event listener"
      pattern: "awareness\\.on.*change"
---

<objective>
Install y-excalidraw and create the collaboration hooks and coordinate utilities for Excalidraw diagram multiplayer.

Purpose: Establish the data layer for real-time element sync, pointer awareness, and canvas coordinate transformation. This plan creates all hooks and utilities that the UI plan (Plan 02) will consume.

Output: y-excalidraw installed, use-diagram-collaboration hook, use-diagram-cursor-awareness hook, canvas-coordinates utility module.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-diagram-multiplayer-cursors/13-RESEARCH.md

Prior phase artifacts to reference:
@src/hooks/use-yjs-provider.ts
@src/hooks/use-document-collaboration.ts
@src/hooks/use-cursor-awareness.ts
@src/lib/user-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install y-excalidraw and create canvas coordinate utilities</name>
  <files>package.json, src/lib/canvas-coordinates.ts</files>
  <action>
1. Install y-excalidraw: `npm install y-excalidraw`

2. Create `src/lib/canvas-coordinates.ts` with these exports:
   - `Point` interface: `{ x: number; y: number }`
   - `Camera` interface: `{ x: number; y: number; z: number }` (scrollX, scrollY, zoom.value)
   - `getCameraFromAppState(appState)`: Extract Camera from Excalidraw AppState — `{ x: appState.scrollX, y: appState.scrollY, z: appState.zoom.value }`
   - `screenToCanvas(screenPoint, camera)`: Convert screen coords to canvas coords — `{ x: screenPoint.x / camera.z - camera.x, y: screenPoint.y / camera.z - camera.y }`
   - `canvasToScreen(canvasPoint, camera)`: Convert canvas coords to screen coords — `{ x: (canvasPoint.x + camera.x) * camera.z, y: (canvasPoint.y + camera.y) * camera.z }`

   Import AppState type from `@excalidraw/excalidraw/types`.

   IMPORTANT: Store canvas coordinates in awareness (not screen coords). Transform to screen coords only at render time. See Research pitfall #1.
  </action>
  <verify>`npm run lint` passes. Verify y-excalidraw in package.json dependencies. Verify canvas-coordinates.ts exports all 5 items (Point, Camera, getCameraFromAppState, screenToCanvas, canvasToScreen).</verify>
  <done>y-excalidraw installed, canvas coordinate utilities exported and type-safe.</done>
</task>

<task type="auto">
  <name>Task 2: Create diagram collaboration hook and diagram cursor awareness hook</name>
  <files>src/hooks/use-diagram-collaboration.ts, src/hooks/use-diagram-cursor-awareness.ts</files>
  <action>
**Create `src/hooks/use-diagram-collaboration.ts`:**

This hook manages the y-excalidraw binding, Yjs provider, IndexedDB persistence, and awareness state. Follow the pattern from `use-document-collaboration.ts` but adapted for Excalidraw.

Parameters:
- `diagramId: string` — Convex diagram ID
- `userName: string` — current user display name
- `userId: string` — current user ID for color generation

Returns:
- `yDoc: Y.Doc` — Yjs document
- `provider: YPartyKitProvider | null` — WebSocket provider
- `isConnected: boolean` — connection state
- `isLoading: boolean` — true until provider synced AND IndexedDB synced
- `yElements: Y.Array<Y.Map<any>>` — Yjs array for Excalidraw elements
- `yAssets: Y.Map<any>` — Yjs map for Excalidraw assets
- `awareness: Awareness | null` — provider.awareness for cursor tracking
- `bindingRef: MutableRefObject<ExcalidrawBinding | null>` — ref to active binding (for cleanup, Plan 02 may need)

Implementation:
1. Call `useYjsProvider({ resourceType: "diagram", resourceId: diagramId })`
2. Create stable `yElements = useMemo(() => yDoc.getArray("elements"), [yDoc])` and `yAssets = useMemo(() => yDoc.getMap("assets"), [yDoc])`
3. Set up IndexedDB persistence with `IndexeddbPersistence(`diagram-${diagramId}`, yDoc)` — same pattern as documents
4. Set awareness user info: `provider.awareness.setLocalStateField("user", { name: userName, color: getUserColor(userId) })` in a useEffect
5. Return all values. The ExcalidrawBinding creation will be handled in Plan 02's ExcalidrawEditor (it needs excalidrawAPI ref which is only available in the component).

IMPORTANT: Do NOT create the ExcalidrawBinding here — it requires excalidrawAPI which is only available after Excalidraw mounts. The binding will be created in ExcalidrawEditor (Plan 02). This hook provides the Yjs plumbing.

**Create `src/hooks/use-diagram-cursor-awareness.ts`:**

Adapted from `use-cursor-awareness.ts` but for Excalidraw pointer coordinates (x,y canvas coords) instead of ProseMirror text cursor positions (anchor, head).

Interface `RemotePointer`:
- `clientId: number`
- `name: string`
- `color: string`
- `pointer: { x: number; y: number } | null` — canvas coordinates (NOT screen coords)
- `lockedElements: string[]` — element IDs locked by this user
- `lastUpdate: number`
- `isIdle: boolean`

Constants:
- `STALE_TIMEOUT = 10000` (10s, matches Phase 12)
- `IDLE_TIMEOUT = 30000` (30s, matches Phase 12)

Export function `useDiagramCursorAwareness(awareness: Awareness | null)`:
- Returns `{ remotePointers: RemotePointer[] }`
- Same pattern as `useCursorAwareness`: listen to `awareness.on("change", ...)`, filter stale clients (>10s), detect idle (>30s no pointer movement), re-evaluate every 1 second via setInterval
- Track pointer position changes (x,y comparison instead of anchor/head)
- Read `state.pointer` for coordinates, `state.lockedElements?.elementIds` for locks
- Filter out local clientId
- Clean up on unmount: off listener, clearInterval, clear state
  </action>
  <verify>`npm run lint` passes. `npm run build` succeeds. Verify both hooks export correctly. Verify use-diagram-collaboration.ts calls useYjsProvider with resourceType "diagram". Verify use-diagram-cursor-awareness.ts has STALE_TIMEOUT=10000 and IDLE_TIMEOUT=30000.</verify>
  <done>Both hooks created: useDiagramCollaboration returns Yjs plumbing for Excalidraw, useDiagramCursorAwareness returns RemotePointer array with idle/stale detection matching Phase 12 timeouts.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. y-excalidraw present in package.json dependencies
4. All new files exist: src/lib/canvas-coordinates.ts, src/hooks/use-diagram-collaboration.ts, src/hooks/use-diagram-cursor-awareness.ts
5. canvas-coordinates.ts exports Point, Camera, getCameraFromAppState, screenToCanvas, canvasToScreen
6. use-diagram-collaboration.ts calls useYjsProvider with resourceType "diagram"
7. use-diagram-cursor-awareness.ts uses 10s stale and 30s idle timeouts
</verification>

<success_criteria>
- y-excalidraw installed and importable
- Canvas coordinate utilities handle screen-to-canvas and canvas-to-screen transforms
- Diagram collaboration hook provides Yjs doc, provider, awareness, yElements, yAssets
- Diagram cursor awareness hook tracks remote pointers with idle/stale detection
- All code passes lint and build
</success_criteria>

<output>
After completion, create `.planning/phases/13-diagram-multiplayer-cursors/13-01-SUMMARY.md`
</output>
