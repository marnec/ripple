---
phase: 13-diagram-multiplayer-cursors
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/pages/App/Diagram/DiagramCursorOverlay.tsx
  - src/pages/App/Diagram/DiagramLockOverlay.tsx
  - src/pages/App/Diagram/ExcalidrawEditor.tsx
  - src/pages/App/Diagram/DiagramPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see other users' pointer positions as Figma-style colored arrow cursors in Excalidraw"
    - "Each pointer has an always-visible name label in the user's color"
    - "Pointers fade when idle (semi-transparent) and disappear when stale (10s)"
    - "Selecting an element locks it for that user; others see a lock indicator"
    - "Active users avatar stack shows who is viewing the diagram with colored rings"
    - "Clicking a user's avatar pans the canvas to center on their pointer position"
    - "Connection status indicator shows green/yellow/red state"
    - "Existing diagrams remain compatible (no migration breakage)"
    - "Old Convex presence (FacePile) removed from DiagramPage"
  artifacts:
    - path: "src/pages/App/Diagram/DiagramCursorOverlay.tsx"
      provides: "Figma-style pointer overlay with SVG arrows and name labels"
      exports: ["DiagramCursorOverlay"]
    - path: "src/pages/App/Diagram/DiagramLockOverlay.tsx"
      provides: "Lock indicator badges on selected elements"
      exports: ["DiagramLockOverlay"]
    - path: "src/pages/App/Diagram/ExcalidrawEditor.tsx"
      provides: "Excalidraw editor with y-excalidraw binding and cursor awareness"
    - path: "src/pages/App/Diagram/DiagramPage.tsx"
      provides: "Diagram page with ActiveUsers, ConnectionStatus, jump-to-user"
  key_links:
    - from: "src/pages/App/Diagram/ExcalidrawEditor.tsx"
      to: "y-excalidraw"
      via: "ExcalidrawBinding constructor in useEffect"
      pattern: "new ExcalidrawBinding"
    - from: "src/pages/App/Diagram/ExcalidrawEditor.tsx"
      to: "src/hooks/use-diagram-cursor-awareness.ts"
      via: "useDiagramCursorAwareness hook call"
      pattern: "useDiagramCursorAwareness"
    - from: "src/pages/App/Diagram/DiagramPage.tsx"
      to: "src/pages/App/Document/ActiveUsers.tsx"
      via: "ActiveUsers component with onUserClick for jump-to-user"
      pattern: "ActiveUsers"
    - from: "src/pages/App/Diagram/DiagramCursorOverlay.tsx"
      to: "src/lib/canvas-coordinates.ts"
      via: "canvasToScreen transform for positioning"
      pattern: "canvasToScreen"
    - from: "src/pages/App/Diagram/DiagramPage.tsx"
      to: "src/pages/App/Document/ConnectionStatus.tsx"
      via: "ConnectionStatus component reuse"
      pattern: "ConnectionStatus"
---

<objective>
Create cursor overlay UI, lock indicators, and wire everything into ExcalidrawEditor and DiagramPage for complete diagram multiplayer.

Purpose: This plan transforms the existing single-user Excalidraw diagram editor into a fully multiplayer experience with Figma-style cursors, element locking, active users display, and jump-to-user navigation.

Output: Working diagram multiplayer with cursor overlay, lock indicators, active users, connection status, and jump-to-user. Old Convex presence removed.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-diagram-multiplayer-cursors/13-RESEARCH.md
@.planning/phases/13-diagram-multiplayer-cursors/13-01-SUMMARY.md

Prior phase artifacts to reference:
@src/pages/App/Document/ActiveUsers.tsx
@src/pages/App/Document/ConnectionStatus.tsx
@src/pages/App/Diagram/ExcalidrawEditor.tsx
@src/pages/App/Diagram/DiagramPage.tsx
@src/lib/canvas-coordinates.ts
@src/hooks/use-diagram-collaboration.ts
@src/hooks/use-diagram-cursor-awareness.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiagramCursorOverlay and DiagramLockOverlay components</name>
  <files>src/pages/App/Diagram/DiagramCursorOverlay.tsx, src/pages/App/Diagram/DiagramLockOverlay.tsx</files>
  <action>
**Create `src/pages/App/Diagram/DiagramCursorOverlay.tsx`:**

Renders remote user pointers as Figma-style colored arrow cursors with name labels. This is an absolute-positioned sibling div to Excalidraw (NOT inside the canvas — see Research pitfall #2).

Props:
- `cursors: RemotePointer[]` — from useDiagramCursorAwareness
- `excalidrawAPI: ExcalidrawImperativeAPI` — for reading current camera state

Implementation:
1. Read camera from `excalidrawAPI.getAppState()` via `getCameraFromAppState()`
2. For each cursor with a non-null pointer:
   a. Transform canvas coords to screen coords via `canvasToScreen(cursor.pointer, camera)`
   b. Skip if screen position is outside viewport (per user decision: no off-screen indicators)
   c. Render absolutely-positioned div at screen position with:
      - SVG arrow cursor (Figma-style): `<svg width="24" height="36" viewBox="0 0 24 36">` with path `d="M0 0L0 24L9 15L15 27L18 25L12 13L24 10L0 0Z"` filled with `cursor.color`, white stroke 1.5px
      - Name label: positioned below-right of arrow, pill-shaped with `cursor.color` background, white text, `text-xs font-medium`, user name, rounded, shadow
      - Opacity: `cursor.isIdle ? 0.3 : 1` (Claude's discretion: semi-transparent for idle per research recommendation)
      - CSS transition on opacity: `transition-opacity duration-200`
3. The container div: `className="absolute inset-0 pointer-events-none overflow-hidden z-10"`

IMPORTANT: The overlay must re-render when camera changes (pan/zoom). Pass a `cameraVersion` state counter that increments on Excalidraw onChange, or use a state-based camera. The component should call `getCameraFromAppState(excalidrawAPI.getAppState())` on every render (just-in-time transform per Research anti-pattern #4).

**Create `src/pages/App/Diagram/DiagramLockOverlay.tsx`:**

Renders lock indicator badges on elements that are locked by remote users.

Props:
- `cursors: RemotePointer[]` — for lock data and user colors
- `excalidrawAPI: ExcalidrawImperativeAPI` — for element positions and camera

Implementation:
1. Collect all locked element IDs from all cursors: iterate cursors, collect elementId -> cursor mapping
2. For each locked element:
   a. Find element in scene via `excalidrawAPI.getSceneElements().find(el => el.id === elementId)`
   b. Skip if element not found
   c. Get element bounds (x, y from element) and transform to screen coords
   d. Render corner badge at top-left of element:
      - Small pill with user color background, white text
      - Lock icon (lucide-react `Lock`, h-3 w-3) + user name
      - `text-xs font-medium shadow-md rounded`
3. Container: `className="absolute inset-0 pointer-events-none overflow-hidden z-10"`
4. Show lock badge on hover only if there are many locked elements (Claude's discretion: always show for now, since typical use is 1-3 locked elements — clutter reduction can be added later if needed)
  </action>
  <verify>`npm run lint` passes. Both component files exist and export their named components. DiagramCursorOverlay uses canvasToScreen from canvas-coordinates. DiagramLockOverlay uses Lock icon from lucide-react.</verify>
  <done>Figma-style cursor overlay renders remote pointers with colored SVG arrows and name labels. Lock overlay shows badges on locked elements with user color and lock icon.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite ExcalidrawEditor and DiagramPage for multiplayer</name>
  <files>src/pages/App/Diagram/ExcalidrawEditor.tsx, src/pages/App/Diagram/DiagramPage.tsx</files>
  <action>
**Rewrite `src/pages/App/Diagram/ExcalidrawEditor.tsx`:**

Replace the current single-user editor (manual debounced save via Convex mutation, reconcileElements polling) with y-excalidraw binding and cursor awareness.

New props (replacing current `onSave` and `diagram` props):
- `diagramId: string` — for collaboration hook
- `userName: string` — current user display name
- `userId: string` — current user ID
- `excalidrawAPI: ExcalidrawImperativeAPI | null` — managed by parent (or keep internal, but expose via callback)

Actually, restructure: ExcalidrawEditor receives collaboration data from DiagramPage. New props:
- `yElements: Y.Array<Y.Map<any>>` — from useDiagramCollaboration
- `yAssets: Y.Map<any>` — from useDiagramCollaboration
- `awareness: Awareness | null` — for binding
- `provider: YPartyKitProvider | null` — for binding
- `onExcalidrawAPI: (api: ExcalidrawImperativeAPI) => void` — callback to give parent the API ref

Implementation:
1. Remove all old imports: `reconcileElements`, `useDebounceCallback`, `RemoteExcalidrawElement`, `Doc`
2. Remove old props type (`onSave`, `diagram`)
3. Remove old state: `isSaving`, `elementsRef`, `debouncedSave`
4. Remove old useEffects for content parsing and reconciliation
5. Keep: `excalidrawAPI` state, theme resolution
6. Add: `ExcalidrawBinding` setup in useEffect:
   ```
   useEffect(() => {
     if (!excalidrawAPI || !provider || !yElements || !yAssets) return;
     const excalidrawDom = document.querySelector(".excalidraw-wrapper");
     if (!excalidrawDom) return;
     const binding = new ExcalidrawBinding(yElements, yAssets, excalidrawAPI, provider.awareness, { excalidrawDom });
     return () => binding.destroy();
   }, [excalidrawAPI, provider, yElements, yAssets]);
   ```
7. Add: Lock-on-select tracking via useEffect watching `excalidrawAPI`:
   - Use Excalidraw's `onChange` callback to read `appState.selectedElementIds`
   - Broadcast to awareness: `awareness.setLocalStateField("lockedElements", { elementIds: Object.keys(selectedElementIds).filter(id => selectedElementIds[id]) })`
   - Clear locked elements when selection is empty
8. Add: Pointer tracking via `onPointerUpdate` prop on Excalidraw (if y-excalidraw provides `binding.onPointerUpdate`, pass it; otherwise manually broadcast pointer position to awareness using canvas coordinates):
   - In the Excalidraw onChange callback or a pointer move handler on the wrapper div, convert pointer to canvas coords and set `awareness.setLocalStateField("pointer", canvasPoint)`
9. Add: `cameraState` tracked via useState, updated on Excalidraw onChange — this triggers re-render of cursor overlays
10. Excalidraw component: Keep `zenModeEnabled`, `UIOptions` (no image, no loadScene). Remove `onChange` prop for saving (y-excalidraw handles sync). Add `onChange` callback ONLY for camera tracking and lock-on-select (NOT for element sync — y-excalidraw handles that). Set `initialData` using `yjsToExcalidraw(yElements)` from y-excalidraw.
11. Render DiagramCursorOverlay and DiagramLockOverlay as siblings to Excalidraw div (NOT children), passing remotePointers and excalidrawAPI
12. Get remotePointers from `useDiagramCursorAwareness(awareness)`

IMPORTANT anti-patterns from Research:
- Do NOT set `initialData` with raw diagram.content — let y-excalidraw manage state. Use `yjsToExcalidraw(yElements)` for initial render.
- Do NOT add onChange handler for element sync — y-excalidraw binding handles this internally.
- Do NOT store screen coordinates in awareness — use canvas coordinates via screenToCanvas.
- Render cursor overlays as siblings, not inside Excalidraw canvas.

**Rewrite `src/pages/App/Diagram/DiagramPage.tsx`:**

Replace old Convex presence with Yjs-based collaboration.

1. Remove imports: `useEnhancedPresence`, `FacePile`, `useMutation`, `useCallback`, `OrderedExcalidrawElement`, `AppState`
2. Remove: `onSave` callback, `updateDiagramContent` mutation, `enhancedPresence`
3. Add imports: `useDiagramCollaboration` from hooks, `useDiagramCursorAwareness` from hooks, `ActiveUsers` from `../Document/ActiveUsers`, `ConnectionStatus` from `../Document/ConnectionStatus`, `getUserColor` from lib, `useQuery(api.users.viewer)` for current user
4. Call `useDiagramCollaboration({ diagramId, userName: viewer.name, userId: viewer._id })`
5. Call `useDiagramCursorAwareness(awareness)` for remote pointers (for jump-to-user)
6. Keep `useQuery(api.diagrams.get)` for diagram metadata (name display in title if needed), but no longer use `diagram.content`
7. Add `excalidrawAPI` state managed here, passed to ExcalidrawEditor via callback
8. Render structure:
   ```
   <div className="relative h-full w-full">
     {/* Header with collaboration UI */}
     <div className="absolute top-5 right-10 z-50 flex items-center gap-3">
       <ConnectionStatus isConnected={isConnected} provider={provider} />
       <ActiveUsers
         remoteUsers={remotePointers.map(p => ({
           ...p,
           cursor: p.pointer,  // map pointer to cursor for ActiveUsers compatibility
         }))}
         currentUser={viewer ? { name: viewer.name, color: getUserColor(viewer._id) } : undefined}
         onUserClick={(user) => handleJumpToUser(user)}
       />
     </div>
     {/* Editor */}
     {!isLoading && (
       <ExcalidrawEditor
         yElements={yElements}
         yAssets={yAssets}
         awareness={awareness}
         provider={provider}
         onExcalidrawAPI={setExcalidrawAPI}
       />
     )}
     {isLoading && <div className="p-20 animate-pulse">Loading diagram...</div>}
   </div>
   ```
9. Implement `handleJumpToUser`: Find the remote pointer matching the clicked user, calculate new scrollX/scrollY to center on their position, call `excalidrawAPI.updateScene({ appState: { scrollX: newScrollX, scrollY: newScrollY } })`. Formula: `newScrollX = viewportCenterX / zoom - pointer.x`, `newScrollY = viewportCenterY / zoom - pointer.y`.

10. Update ActiveUsers component to support `onUserClick` prop:
    - Add optional `onUserClick?: (user: RemoteUser) => void` to ActiveUsersProps
    - When defined, wrap each remote user avatar in a clickable div (add `cursor-pointer` class and onClick handler)
    - Keep `pointer-events-auto` on clickable avatars
    - This is a backwards-compatible change (documents don't pass onUserClick, so behavior unchanged)

IMPORTANT: The ActiveUsers component lives at `src/pages/App/Document/ActiveUsers.tsx`. It needs a minor update to support `onUserClick`. This is a backwards-compatible addition.
  </action>
  <verify>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. No references to `reconcileElements` in ExcalidrawEditor.tsx
4. No references to `useEnhancedPresence` or `FacePile` in DiagramPage.tsx
5. ExcalidrawEditor.tsx imports ExcalidrawBinding from y-excalidraw
6. DiagramPage.tsx imports ActiveUsers, ConnectionStatus from Document directory
7. DiagramPage.tsx calls useDiagramCollaboration and useDiagramCursorAwareness
8. ActiveUsers.tsx has optional onUserClick prop
  </verify>
  <done>
Complete diagram multiplayer: Figma-style cursor overlay with colored arrows and name labels, lock-on-select with lock indicator badges, active users avatar stack with jump-to-user on click, connection status indicator. Old Convex presence fully removed. Existing diagrams remain compatible (y-excalidraw manages element state via Yjs, no migration needed).
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. No references to `reconcileElements`, `useEnhancedPresence`, or `FacePile` in Diagram directory
4. ExcalidrawEditor creates ExcalidrawBinding with y-excalidraw
5. DiagramCursorOverlay renders SVG arrow cursors with name labels
6. DiagramLockOverlay renders lock badges on locked elements
7. DiagramPage shows ActiveUsers with colored rings and jump-to-user
8. DiagramPage shows ConnectionStatus with green/yellow/red states
9. Pointer coordinates stored as canvas coords in awareness (not screen coords)
10. Idle pointers fade to 0.3 opacity, stale pointers removed after 10s
</verification>

<success_criteria>
- Remote user pointers appear as Figma-style colored arrows with name labels in Excalidraw
- Selecting an element broadcasts lock, others see lock indicator badge
- Active users avatar stack shows all diagram viewers with colored rings
- Clicking avatar pans canvas to center on that user's pointer
- Connection status shows syncing state
- Old Convex presence system fully removed from diagram page
- Idle pointers semi-transparent, stale pointers removed
- Excalidraw elements sync via y-excalidraw (no manual reconcileElements)
</success_criteria>

<output>
After completion, create `.planning/phases/13-diagram-multiplayer-cursors/13-02-SUMMARY.md`
</output>
