---
phase: 06.1-mention-people-in-task-comments
plan: 01
subsystem: ui
tags: [blocknote, mentions, rich-text, task-comments]

requires:
  - phase: 06-task-comments
    provides: TaskComments component and taskComments backend
  - phase: 05-document-diagram-embeds
    provides: UserMention inline content spec and BlockNote schema pattern
provides:
  - BlockNote-powered task comments with @mention autocomplete
  - taskCommentSchema with userMention inline content
  - Backwards-compatible comment rendering (plain text fallback)
affects: [07-notifications-polish]

tech-stack:
  added: []
  patterns: [BlockNote comment schema, compact editor styling]

key-files:
  created:
    - src/pages/App/Project/taskCommentSchema.ts
    - src/pages/App/Project/task-comment.css
  modified:
    - src/pages/App/Project/TaskComments.tsx
    - src/pages/App/Project/TaskDetailSheet.tsx
    - src/pages/App/Project/TaskDetailPage.tsx

key-decisions:
  - "Separate taskCommentSchema with only userMention (not reusing taskDescriptionSchema)"
  - "JSON.stringify for comment body storage, parseCommentBody fallback for plain text"
  - "SuggestionMenuController items follow title/onItemClick/icon/group pattern from existing code"
  - "Limit @mention autocomplete to 10 project members"

patterns-established:
  - "Compact BlockNote editor for comments with task-comment-editor CSS class"
  - "CommentBody sub-component for read-only display with backwards compatibility"
  - "EditCommentEditor sub-component for editing with preserved @mentions"
  - "Avatar icons in @mention autocomplete for visual identification"

duration: 3min
completed: 2026-02-06
---

# Phase 06.1 Plan 01: Mention People in Task Comments Summary

**One-liner:** BlockNote-powered task comments with @mention autocomplete for project members, replacing plain textarea while maintaining backwards compatibility

## What Was Built

### Core Features
1. **taskCommentSchema** - Minimal BlockNote schema with only userMention inline content type
2. **BlockNote Comment Input** - Rich text editor with @mention autocomplete replacing textarea
3. **Read-only Comment Display** - CommentBody component for displaying comments with @mentions
4. **Edit Mode** - EditCommentEditor component allowing editing with @mention support
5. **Backwards Compatibility** - parseCommentBody fallback renders existing plain-text comments

### User Experience
- Type @ to trigger autocomplete showing project members with avatars
- Select member to insert bold @Name mention
- Ctrl+Enter keyboard shortcut for quick submission
- Comment button disabled when editor is empty
- Existing plain-text comments render correctly without errors
- Edit mode preserves existing @mentions and allows adding new ones

### Technical Implementation
- taskCommentSchema created with defaultBlockSpecs + userMention only (no diagrams/documents/projects)
- SuggestionMenuController with title/onItemClick/icon/group pattern (matching existing codebase)
- JSON.stringify(editor.document) for storage, parseCommentBody for backwards-compatible parsing
- task-comment.css removes padding-inline for compact comment styling
- CommentBody and EditCommentEditor sub-components separate concerns
- useTheme integration for dark/light mode support
- isEmpty state tracks editor content to disable submit button

## Task Commits

| Task | Description | Commit | Key Changes |
|------|-------------|--------|-------------|
| 1 | Create comment schema and upgrade TaskComments to BlockNote | 368945c | Created taskCommentSchema.ts, task-comment.css; rewrote TaskComments.tsx with BlockNote editors |
| 2 | Pass projectId to TaskComments from both views | 089d824 | Added projectId prop in TaskDetailSheet.tsx and TaskDetailPage.tsx |

## Decisions Made

| Decision | Rationale | Alternatives Considered | Impact |
|----------|-----------|------------------------|--------|
| Separate taskCommentSchema vs reuse taskDescriptionSchema | Comments don't need diagrams/documents/projects - keep it minimal | Reuse taskDescriptionSchema (adds unnecessary complexity) | Smaller schema, simpler autocomplete logic |
| JSON.stringify storage vs custom serialization | Consistent with BlockNote best practices, easy parsing | Custom serialization format | Simple, standard approach |
| parseCommentBody fallback for plain text | Backwards compatibility with Phase 6 comments | Migrate all existing comments (requires data migration) | Zero-downtime upgrade |
| Limit 10 results for @mention autocomplete | Matches task description @ autocomplete limit | No limit (could overwhelm UI) | Consistent UX across features |
| SuggestionMenuController item structure | Matches existing codebase pattern from TaskDetailSheet | Direct member objects (caused type errors) | Type-safe, follows conventions |

## Deviations from Plan

None - plan executed exactly as written. Initial type errors with SuggestionMenuController resolved by following existing codebase pattern from TaskDetailSheet.

## Files Changed

### Created
- `src/pages/App/Project/taskCommentSchema.ts` - BlockNote schema with userMention only
- `src/pages/App/Project/task-comment.css` - Compact styling for comment editors

### Modified
- `src/pages/App/Project/TaskComments.tsx` - Complete rewrite with BlockNote (233 insertions, 71 deletions)
- `src/pages/App/Project/TaskDetailSheet.tsx` - Added projectId prop to TaskComments
- `src/pages/App/Project/TaskDetailPage.tsx` - Added projectId prop to TaskComments

### Lines of Code
- taskCommentSchema.ts: 15 lines
- task-comment.css: 8 lines
- TaskComments.tsx: 329 lines (rewritten from 187 lines)

## Technical Notes

### BlockNote Integration Pattern
```typescript
// Schema definition (minimal for comments)
export const taskCommentSchema = BlockNoteSchema.create({
  blockSpecs: { ...defaultBlockSpecs },
  inlineContentSpecs: { ...defaultInlineContentSpecs, userMention: UserMention },
});

// Backwards-compatible parsing
function parseCommentBody(body: string) {
  try {
    return JSON.parse(body);
  } catch {
    return [{ type: "paragraph", content: body }];
  }
}

// SuggestionMenuController item structure (matches codebase convention)
getItems={async (query) => {
  return projectMembers
    .filter(m => m.name?.toLowerCase().includes(query.toLowerCase()))
    .slice(0, 10)
    .map(m => ({
      title: m.name ?? "Unknown",
      onItemClick: () => { editor.insertInlineContent([...]) },
      icon: <Avatar>...</Avatar>,
      group: "Project members",
    }));
}}
```

### Compact Editor Styling
```css
.task-comment-editor .bn-editor {
  padding-inline: 0px;
}
.task-comment-editor .bn-block-group {
  padding-inline: 0px;
}
```

### Component Architecture
- **TaskComments** - Main container, manages new comment input
- **CommentBody** - Read-only display component (stateless)
- **EditCommentEditor** - Edit mode component (stateful, own editor instance)

## Integration Points

### Upstream Dependencies
- **Phase 06 (TaskComments)** - Provides base comment component, backend mutations (create/update/remove)
- **Phase 05 (Document/Diagram Embeds)** - Provides UserMention inline content spec, BlockNote integration patterns

### Downstream Impact
- **Phase 07 (Notifications)** - Can now parse @mentions from comment bodies to notify mentioned users
- **Future search** - JSON structure enables rich content search across comments

## Testing Notes

### Manual Testing Checklist
- [ ] Type @ in comment input shows project member autocomplete
- [ ] Autocomplete filters by name, limits to 10 results
- [ ] Select member inserts bold @Name mention
- [ ] Submit comment stores as JSON, displays @mention correctly
- [ ] Existing plain-text comments render without errors
- [ ] Edit comment preserves @mentions
- [ ] Add @mention in edit mode works
- [ ] Ctrl+Enter submits comment
- [ ] Empty editor disables Comment button
- [ ] Comment clears after successful submission
- [ ] Dark/light theme switches correctly

### Edge Cases Handled
- Missing user in @mention → renders "@unknown-user" (handled by UserMention component)
- Plain text comments → parseCommentBody fallback wraps in paragraph block
- Empty editor detection → checks for empty paragraph block
- Project member with no name → shows "Unknown" in autocomplete

## Next Phase Readiness

### Phase 07 (Notifications) Prerequisites Met
- [x] Comment bodies stored as JSON (parseable for @mentions)
- [x] UserMention inline content uses userId prop (extractable for notifications)
- [x] Backwards compatibility maintained (no breaking changes)

### Open Questions for Phase 07
- Should @mentions in comments trigger instant notifications or batch?
- Should notification include comment context (task name, project)?
- How to handle @mention of users not in project? (Currently prevented by scoped autocomplete)

### Potential Future Enhancements
- Rich text formatting (bold, italic, code) in comments
- File attachments in comments
- Comment reactions (emoji)
- Comment threading (replies)
- @mention in edit mode shows "already mentioned" indicator

## Self-Check: PASSED

All files created:
- FOUND: src/pages/App/Project/taskCommentSchema.ts
- FOUND: src/pages/App/Project/task-comment.css

All commits exist:
- FOUND: 368945c
- FOUND: 089d824
