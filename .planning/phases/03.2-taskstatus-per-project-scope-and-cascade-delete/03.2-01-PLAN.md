---
phase: 03.2-taskstatus-per-project-scope-and-cascade-delete
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/taskStatuses.ts
  - convex/projects.ts
  - convex/tasks.ts
autonomous: true

must_haves:
  truths:
    - "taskStatuses belong to projects, not workspaces"
    - "Each project gets its own independent set of default statuses at creation"
    - "Deleting a taskStatus moves all its tasks to the project default status"
    - "Deleting a project cascades to delete all its tasks, taskComments, and taskStatuses"
    - "New tasks default to the project-scoped default status"
  artifacts:
    - path: "convex/schema.ts"
      provides: "taskStatuses table with projectId field and project-scoped indexes"
      contains: "projectId: v.id(\"projects\")"
    - path: "convex/taskStatuses.ts"
      provides: "Project-scoped CRUD for task statuses with cascade delete"
      exports: ["listByProject", "create", "update", "reorderColumns", "remove"]
    - path: "convex/projects.ts"
      provides: "Project-scoped status seeding and full cascade delete"
      exports: ["create", "remove"]
    - path: "convex/tasks.ts"
      provides: "Default status lookup by project instead of workspace"
      exports: ["create"]
  key_links:
    - from: "convex/projects.ts (create)"
      to: "convex/schema.ts (taskStatuses)"
      via: "ctx.db.insert with projectId"
      pattern: "insert\\(\"taskStatuses\".*projectId"
    - from: "convex/taskStatuses.ts (remove)"
      to: "convex/tasks.ts (by_project_status index)"
      via: "cascade tasks to default status"
      pattern: "withIndex\\(\"by_project_status\""
    - from: "convex/projects.ts (remove)"
      to: "tasks, taskStatuses, taskComments"
      via: "cascade delete all project children"
      pattern: "query\\(\"tasks\"\\).*withIndex\\(\"by_project\""
    - from: "convex/tasks.ts (create)"
      to: "convex/schema.ts (taskStatuses by_project index)"
      via: "default status lookup by projectId"
      pattern: "withIndex\\(\"by_project\".*projectId"
---

<objective>
Migrate taskStatuses from workspace-scoped to project-scoped and implement cascade deletes.

Purpose: Each project needs independent status workflows. Currently all projects in a workspace share statuses, preventing per-project customization. Additionally, deleting a status currently blocks if tasks exist (bad UX), and deleting a project leaves orphaned tasks/statuses.

Output: Updated schema, backend mutations for project-scoped statuses, cascade delete on status removal and project removal.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-taskstatus-per-project-scope-and-cascade-delete/03.2-RESEARCH.md
@.planning/phases/03.1-default-taskstatus-logic/03.1-01-SUMMARY.md
@convex/schema.ts
@convex/taskStatuses.ts
@convex/projects.ts
@convex/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration and project-scoped taskStatuses backend</name>
  <files>convex/schema.ts, convex/taskStatuses.ts, convex/tasks.ts</files>
  <action>
**1. Update schema.ts - taskStatuses table:**
Replace the existing taskStatuses definition. Change `workspaceId` to `projectId`. Remove workspace indexes, add project indexes.

```typescript
taskStatuses: defineTable({
  projectId: v.id("projects"),      // was workspaceId
  name: v.string(),
  color: v.string(),
  order: v.number(),
  isDefault: v.boolean(),
  isCompleted: v.boolean(),
})
  .index("by_project", ["projectId"])
  .index("by_project_order", ["projectId", "order"]),
```

Remove the old `by_workspace` and `by_workspace_order` indexes entirely.

**2. Update taskStatuses.ts:**

a) **Delete `seedDefaultStatuses` mutation entirely** -- seeding is handled inline in projects.create.

b) **Rename `listByWorkspace` to `listByProject`:**
  - Change args from `workspaceId: v.id("workspaces")` to `projectId: v.id("projects")`
  - Change permission check from workspace membership to project membership using `projectMembers.by_project_user` index
  - Change query from `by_workspace_order` index to `by_project_order` index with `q.eq("projectId", projectId)`

c) **Update `create` mutation:**
  - Change args: replace `workspaceId: v.id("workspaces")` with `projectId: v.id("projects")`
  - Change permission check from workspace membership to project membership using `projectMembers.by_project_user` index
  - Change existing statuses query to use `by_project` index with projectId
  - Change insert to use `projectId` instead of `workspaceId`

d) **Update `update` mutation:**
  - Change permission check: after fetching the status document, look up project membership using `status.projectId` and `projectMembers.by_project_user` index (instead of workspace membership)

e) **Update `reorderColumns` mutation:**
  - Change permission check: after fetching `firstStatus`, look up project membership using `firstStatus.projectId` and `projectMembers.by_project_user` index (instead of workspace membership)

f) **Rewrite `remove` mutation with cascade delete to default status:**
  - Change permission check from workspace membership to project membership using `status.projectId` and `projectMembers.by_project_user`
  - Keep the check: cannot remove default status (throw error)
  - Instead of blocking when tasks exist, implement cascade: find the default status for the project using `by_project` index + filter `isDefault === true`
  - Query all tasks using the status being deleted via `by_project_status` index: `q.eq("projectId", status.projectId).eq("statusId", statusId)`
  - For each task, patch statusId to the default status ID (do NOT change the completed field -- preserve user's completed state)
  - After moving all tasks, delete the status document

**3. Update tasks.ts - `create` mutation:**
  - In the default status lookup (lines 51-62), change from querying `taskStatuses` by `by_workspace` with `project.workspaceId` to querying by `by_project` with `args.projectId`
  - Update error message from "No default status found for workspace" to "No default status found for project"
  </action>
  <verify>Run `npm run lint` -- must pass with 0 errors and 0 warnings. Then run `npx convex dev --once` to validate schema changes deploy and functions are valid.</verify>
  <done>taskStatuses table uses projectId, all taskStatuses mutations are project-scoped, remove mutation cascades tasks to default status, tasks.create fetches default status by project</done>
</task>

<task type="auto">
  <name>Task 2: Project cascade delete for tasks, taskStatuses, and taskComments</name>
  <files>convex/projects.ts</files>
  <action>
**1. Update projects.create - change status seeding from workspace-scoped to project-scoped:**

Replace the existing seeding block (lines 81-114). Remove the idempotent workspace-level check. Instead, ALWAYS seed 3 default statuses for the newly created project (every project gets its own statuses):

```typescript
// Seed default task statuses for this project
await ctx.db.insert("taskStatuses", {
  projectId,
  name: "Todo",
  color: "bg-gray-500",
  order: 0,
  isDefault: true,
  isCompleted: false,
});

await ctx.db.insert("taskStatuses", {
  projectId,
  name: "In Progress",
  color: "bg-blue-500",
  order: 1,
  isDefault: false,
  isCompleted: false,
});

await ctx.db.insert("taskStatuses", {
  projectId,
  name: "Done",
  color: "bg-green-500",
  order: 2,
  isDefault: false,
  isCompleted: true,
});
```

No idempotency check needed since each project gets its own statuses.

**2. Update projects.remove - add cascade delete for tasks, taskComments, and taskStatuses:**

After existing deletion of projectMembers and BEFORE deleting the linked channel, add:

a) **Delete all taskComments for tasks in this project:**
  - Query all tasks by `by_project` index: `q.eq("projectId", id)`
  - For each task, query taskComments by `by_task` index and delete them
  - Use `Promise.all` for batch deletion (task count per project is reasonable)

b) **Delete all tasks in the project:**
  - Query tasks by `by_project` index, delete each one

c) **Delete all taskStatuses for the project:**
  - Query taskStatuses by `by_project` index: `q.eq("projectId", id)`, delete each one

Order matters: delete taskComments first (they reference tasks), then tasks (they reference taskStatuses), then taskStatuses.

Use the existing `stream` import from `convex-helpers/server/stream` that's already in projects.ts for the task deletion if the collection could be large, or use simple `Promise.all` with `.collect()` for smaller sets. Follow the same pattern already used for projectMembers deletion in that file.
  </action>
  <verify>Run `npm run lint` -- must pass with 0 errors and 0 warnings. Then run `npx convex dev --once` to validate deployment.</verify>
  <done>Every new project gets its own 3 default statuses (not shared with workspace). Deleting a project cascades to remove all its taskComments, tasks, and taskStatuses before removing the project itself.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors and 0 warnings
2. `npx convex dev --once` deploys successfully (schema valid, functions valid)
3. Schema shows `projectId: v.id("projects")` on taskStatuses table (no more workspaceId)
4. taskStatuses.remove cascades tasks to default status (not blocking)
5. projects.remove cascades tasks, taskComments, and taskStatuses
6. projects.create seeds per-project statuses (not workspace-level)
7. tasks.create looks up default status by project
</verification>

<success_criteria>
- taskStatuses schema uses projectId with by_project and by_project_order indexes
- All taskStatuses mutations use project membership for permissions
- taskStatuses.remove moves tasks to default status instead of blocking
- projects.create seeds statuses per-project (no workspace-level idempotency)
- projects.remove deletes tasks, taskComments, and taskStatuses
- tasks.create fetches default status by projectId
- Lint and Convex deployment pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-taskstatus-per-project-scope-and-cascade-delete/03.2-01-SUMMARY.md`
</output>
