---
phase: 03.2-taskstatus-per-project-scope-and-cascade-delete
plan: 01
subsystem: backend
tags: [schema-migration, cascade-delete, task-statuses]
dependencies:
  requires: [03.1-01]
  provides: [project-scoped-statuses, cascade-delete-logic]
  affects: [tasks, projects, taskStatuses]
tech_stack:
  added: []
  patterns: [cascade-delete, legacy-field-migration]
key_files:
  created: []
  modified: [convex/schema.ts, convex/taskStatuses.ts, convex/tasks.ts, convex/projects.ts]
decisions:
  - legacy-fields-optional-for-migration
  - cascade-to-default-status-on-delete
  - per-project-status-seeding
metrics:
  duration_minutes: 5.2
  tasks_completed: 2
  files_modified: 4
  commits: 1
  completed_at: 2026-02-10T19:11:31Z
---

# Phase 03.2 Plan 01: TaskStatus Project Scope Migration Summary

**One-liner:** Migrated taskStatuses from workspace-scoped to project-scoped with cascade delete to default status on removal and full project cascade delete

## What Was Built

Migrated the taskStatuses system from workspace-level to project-level scope. Each project now gets its own independent set of task statuses (Todo, In Progress, Done) at creation time, enabling per-project workflow customization. Implemented cascade delete logic so removing a status moves tasks to the project default instead of blocking, and removing a project cascades to clean up all child resources.

### Schema Changes

**taskStatuses table:**
- Changed from `workspaceId: v.id("workspaces")` to `projectId: v.id("projects")`
- Added `by_project` and `by_project_order` indexes
- Legacy fields (`workspaceId`, old indexes) temporarily kept optional for backward compatibility with existing dev data
- Updated comment: "marks the default status for new tasks (only one per project)"

### Backend Mutations Updated

**convex/taskStatuses.ts:**
- Deleted `seedDefaultStatuses` mutation (seeding now inline in projects.create)
- Renamed `listByWorkspace` → `listByProject` with project membership check via `projectMembers.by_project_user`
- Updated `create`, `update`, `reorderColumns` to use project-scoped permissions
- Rewrote `remove` mutation:
  - No longer blocks when tasks exist
  - Finds project default status via `by_project` index + `isDefault` filter
  - Cascades tasks to default using `by_project_status` index
  - Preserves task `completed` field (no auto-reset)
  - Then deletes the status

**convex/projects.ts:**
- Updated `create`: removed workspace-level idempotency check, now ALWAYS seeds 3 statuses per new project with `projectId`
- Updated `remove`: added full cascade delete before project deletion:
  1. Delete all taskComments for tasks in project (via `by_task` index)
  2. Delete all tasks (via `by_project` index)
  3. Delete all taskStatuses (via `by_project` index)
  - Order matters: taskComments → tasks → taskStatuses

**convex/tasks.ts:**
- Updated `create`: changed default status lookup from `by_workspace` with `project.workspaceId` to `by_project` with `args.projectId`
- Updated error message: "No default status found for project"

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking Issue] Schema migration required legacy field support**
- **Found during:** Task 1 - Convex deployment
- **Issue:** Existing dev database had taskStatuses with `workspaceId`, new schema required `projectId`, causing validation error: "Object is missing the required field `projectId`"
- **Fix:** Made both `projectId` and `workspaceId` optional in schema temporarily to allow migration. Added `by_workspace` and `by_workspace_order` indexes back temporarily. Added null checks in mutations with error "Status has no project (legacy data)" to reject old records. TypeScript narrowing required extracting `projectId` to const variable after null check.
- **Files modified:** convex/schema.ts, convex/taskStatuses.ts
- **Commit:** 6f1a21e (included in main commit)
- **Rationale:** Dev environment has existing data. Clean migration path allows schema to deploy, new projects create project-scoped statuses, old workspace-scoped statuses become unused and can be cleaned up later or rejected at runtime.

## Key Technical Decisions

**1. Legacy field migration strategy**
- Made `projectId` optional in schema to unblock deployment with existing workspace-scoped data
- New mutations reject legacy data at runtime with clear error messages
- All new projects seed project-scoped statuses correctly going forward
- Old workspace-level statuses orphaned but harmless (no frontend queries them)

**2. Cascade-to-default on status delete**
- Instead of blocking deletion when tasks exist, move all tasks to project default status
- Preserves task `completed` field (user-controlled state)
- Uses efficient `by_project_status` index for task lookup
- Default status cannot be deleted (prevents cascade loop)

**3. Per-project status seeding**
- Every project.create seeds its own 3 statuses (Todo, In Progress, Done)
- Removed workspace-level idempotency check
- Each project gets independent status workflow out of the box

## Verification Results

- ✅ `npm run lint` passed (0 errors, 0 warnings)
- ✅ `npx convex dev --once` deployed successfully (schema valid, functions valid)
- ✅ Schema shows `projectId: v.optional(v.id("projects"))` on taskStatuses table
- ✅ taskStatuses.remove cascades tasks to default status (not blocking)
- ✅ projects.remove cascades taskComments → tasks → taskStatuses
- ✅ projects.create seeds statuses per-project (not workspace-level)
- ✅ tasks.create looks up default status by projectId

## Files Changed

**Modified:**
- `/home/lambda/projects/ripple/convex/schema.ts` - taskStatuses table migration
- `/home/lambda/projects/ripple/convex/taskStatuses.ts` - project-scoped mutations + cascade delete
- `/home/lambda/projects/ripple/convex/tasks.ts` - default status lookup by project
- `/home/lambda/projects/ripple/convex/projects.ts` - per-project seeding + cascade delete

## Commits

- `6f1a21e`: feat(03.2-01): migrate taskStatuses to project scope with cascade delete

## Dependencies Impact

**Provides:**
- Project-scoped task statuses (each project independent)
- Cascade delete on status removal (tasks move to default)
- Full project cascade delete (cleans up all children)

**Affects:**
- Frontend will need updates to call `listByProject` instead of `listByWorkspace`
- Frontend will need to pass `projectId` instead of `workspaceId` to status mutations
- Kanban board components will need project context

## Next Steps

1. Frontend migration to use new project-scoped APIs (Phase 03.2 Plan 02 likely)
2. Optional: Clean up legacy workspace-scoped statuses from dev database
3. Optional: Remove legacy fields from schema after confirming no old data dependencies

## Self-Check: PASSED

✅ All modified files exist:
- FOUND: /home/lambda/projects/ripple/convex/schema.ts
- FOUND: /home/lambda/projects/ripple/convex/taskStatuses.ts
- FOUND: /home/lambda/projects/ripple/convex/tasks.ts
- FOUND: /home/lambda/projects/ripple/convex/projects.ts

✅ Commit exists:
- FOUND: 6f1a21e

✅ Verification passed:
- Lint: 0 errors, 0 warnings
- Convex deployment: successful
