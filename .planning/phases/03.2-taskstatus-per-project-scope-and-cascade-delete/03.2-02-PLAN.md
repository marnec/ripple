---
phase: 03.2-taskstatus-per-project-scope-and-cascade-delete
plan: 02
type: execute
wave: 2
depends_on: ["03.2-01"]
files_modified:
  - src/pages/App/Project/KanbanBoard.tsx
  - src/pages/App/Project/AddColumnDialog.tsx
  - src/pages/App/Project/useTaskDetail.ts
  - src/pages/App/Project/KanbanColumn.tsx
autonomous: true

must_haves:
  truths:
    - "KanbanBoard fetches statuses by projectId, not workspaceId"
    - "AddColumnDialog creates statuses scoped to a project"
    - "TaskDetailSheet status dropdown shows project-scoped statuses"
    - "Deleting a kanban column is always allowed (except default), since cascade moves tasks"
  artifacts:
    - path: "src/pages/App/Project/KanbanBoard.tsx"
      provides: "KanbanBoard using api.taskStatuses.listByProject"
      contains: "api.taskStatuses.listByProject"
    - path: "src/pages/App/Project/AddColumnDialog.tsx"
      provides: "AddColumnDialog accepting projectId and calling create with projectId"
      contains: "projectId"
    - path: "src/pages/App/Project/useTaskDetail.ts"
      provides: "useTaskDetail fetching statuses by projectId"
      contains: "api.taskStatuses.listByProject"
    - path: "src/pages/App/Project/KanbanColumn.tsx"
      provides: "KanbanColumn with updated delete UX for cascade behavior"
      contains: "canDelete"
  key_links:
    - from: "src/pages/App/Project/KanbanBoard.tsx"
      to: "api.taskStatuses.listByProject"
      via: "useQuery call"
      pattern: "useQuery\\(api\\.taskStatuses\\.listByProject"
    - from: "src/pages/App/Project/AddColumnDialog.tsx"
      to: "api.taskStatuses.create"
      via: "useMutation call with projectId"
      pattern: "createStatus\\(\\{[\\s\\S]*projectId"
    - from: "src/pages/App/Project/useTaskDetail.ts"
      to: "api.taskStatuses.listByProject"
      via: "useQuery call with projectId"
      pattern: "useQuery\\(api\\.taskStatuses\\.listByProject.*projectId"
---

<objective>
Update all frontend components to use project-scoped taskStatus APIs and update cascade delete UX.

Purpose: Backend now serves statuses by project (not workspace). Frontend must switch all query/mutation calls from workspace-scoped to project-scoped, and update the column delete UX since cascade delete replaces the "block if tasks exist" behavior.

Output: All 4 frontend files updated to use new API signatures.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.2-taskstatus-per-project-scope-and-cascade-delete/03.2-01-SUMMARY.md
@src/pages/App/Project/KanbanBoard.tsx
@src/pages/App/Project/AddColumnDialog.tsx
@src/pages/App/Project/useTaskDetail.ts
@src/pages/App/Project/KanbanColumn.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update KanbanBoard and AddColumnDialog to use project-scoped status APIs</name>
  <files>src/pages/App/Project/KanbanBoard.tsx, src/pages/App/Project/AddColumnDialog.tsx</files>
  <action>
**1. KanbanBoard.tsx:**

a) Change the statuses query (line 47-49) from:
```typescript
const statuses = useQuery(api.taskStatuses.listByWorkspace, { workspaceId });
```
to:
```typescript
const statuses = useQuery(api.taskStatuses.listByProject, { projectId });
```

b) Update the `canDelete` prop on KanbanColumn (line 254). Since cascade delete now moves tasks to default status instead of blocking, columns should be deletable even if they have tasks. Change from:
```typescript
canDelete={!status.isDefault && (tasksByStatus[status._id]?.length ?? 0) === 0}
```
to:
```typescript
canDelete={!status.isDefault}
```
The only restriction is that the default status cannot be deleted (backend enforces this too).

c) Update the AddColumnDialog component (line 294-298). Change from passing `workspaceId` to passing `projectId`:
```tsx
<AddColumnDialog
  projectId={projectId}
  open={showAddColumn}
  onOpenChange={setShowAddColumn}
/>
```

**2. AddColumnDialog.tsx:**

a) Change the props type (line 19-23) from:
```typescript
type AddColumnDialogProps = {
  workspaceId: Id<"workspaces">;
  open: boolean;
  onOpenChange: (open: boolean) => void;
};
```
to:
```typescript
type AddColumnDialogProps = {
  projectId: Id<"projects">;
  open: boolean;
  onOpenChange: (open: boolean) => void;
};
```

b) Update the component parameter destructuring (line 36-40) to use `projectId`.

c) Update the `createStatus` call (lines 53-58) from passing `workspaceId` to `projectId`:
```typescript
void createStatus({
  projectId,
  name: trimmedName,
  color: selectedColor,
  isCompleted,
})
```
  </action>
  <verify>Run `npm run lint` -- must pass with 0 errors and 0 warnings.</verify>
  <done>KanbanBoard fetches statuses by projectId, canDelete allows deletion of non-default columns regardless of task count, AddColumnDialog creates statuses scoped to project</done>
</task>

<task type="auto">
  <name>Task 2: Update useTaskDetail and KanbanColumn for project-scoped statuses</name>
  <files>src/pages/App/Project/useTaskDetail.ts, src/pages/App/Project/KanbanColumn.tsx</files>
  <action>
**1. useTaskDetail.ts:**

Change the statuses query (line 18) from:
```typescript
const statuses = useQuery(api.taskStatuses.listByWorkspace, { workspaceId });
```
to:
```typescript
const statuses = useQuery(api.taskStatuses.listByProject, { projectId });
```

The hook already receives `projectId` in its arguments (line 13), so no signature change needed. The `workspaceId` parameter may still be needed for other queries in the hook (diagrams, documents), so do NOT remove it from the hook's arguments.

**2. KanbanColumn.tsx:**

Update the delete confirmation dialog text (line 217) to inform the user that tasks will be moved, not lost. Change from:
```tsx
<DialogDescription>
  Delete &quot;{status.name}&quot; column? This cannot be undone.
</DialogDescription>
```
to:
```tsx
<DialogDescription>
  Delete &quot;{status.name}&quot; column? Tasks in this column will be moved to the default status. This cannot be undone.
</DialogDescription>
```

Also update the disabled menu item text (line 173-177). Since we now allow deletion when tasks exist (cascade moves them), the only disabled state is for the default column. Simplify:
```tsx
<DropdownMenuItem
  onClick={() => setShowDeleteDialog(true)}
  disabled={!canDelete}
  className={canDelete ? "text-destructive" : ""}
>
  <Trash2 className="h-4 w-4 mr-2" />
  {!canDelete ? "Default column" : "Delete Column"}
</DropdownMenuItem>
```

The `text-destructive` class should only apply when canDelete is true so it doesn't color the disabled state.

After all changes, run full build to ensure everything compiles.
  </action>
  <verify>Run `npm run lint` -- must pass with 0 errors and 0 warnings. Run `npm run build` to ensure full compilation succeeds.</verify>
  <done>useTaskDetail fetches statuses by projectId, KanbanColumn delete UX reflects cascade behavior (tasks moved to default, not blocked), full build passes</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors and 0 warnings
2. `npm run build` succeeds (full production build)
3. No references to `listByWorkspace` remain in frontend code
4. No references to `workspaceId` in AddColumnDialog
5. KanbanColumn delete dialog mentions tasks being moved to default status
6. canDelete on KanbanColumn only checks isDefault (not task count)
</verification>

<success_criteria>
- All frontend files use api.taskStatuses.listByProject with projectId
- AddColumnDialog accepts projectId prop and passes it to create mutation
- KanbanBoard passes projectId to AddColumnDialog
- canDelete only restricts default status deletion (not based on task count)
- KanbanColumn delete dialog explains cascade behavior
- Full build (npm run build) passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-taskstatus-per-project-scope-and-cascade-delete/03.2-02-SUMMARY.md`
</output>
