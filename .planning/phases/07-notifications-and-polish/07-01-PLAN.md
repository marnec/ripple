---
phase: 07-notifications-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/utils/blocknote.ts
  - convex/taskNotifications.ts
autonomous: true

must_haves:
  truths:
    - "BlockNote JSON documents can be parsed to extract all @mentioned user IDs"
    - "Internal actions exist to send push notifications for task assignment and user mentions"
    - "Notification actions reuse existing web-push and VAPID infrastructure"
  artifacts:
    - path: "convex/utils/blocknote.ts"
      provides: "extractMentionedUserIds utility function"
      exports: ["extractMentionedUserIds"]
    - path: "convex/taskNotifications.ts"
      provides: "Internal actions for task notification delivery"
      exports: ["notifyTaskAssignment", "notifyUserMentions"]
  key_links:
    - from: "convex/taskNotifications.ts"
      to: "convex/pushSubscription.ts"
      via: "api.pushSubscription.usersSubscriptions query"
      pattern: "ctx\\.runQuery\\(api\\.pushSubscription\\.usersSubscriptions"
    - from: "convex/taskNotifications.ts"
      to: "web-push"
      via: "webpush.sendNotification"
      pattern: "webpush\\.sendNotification"
---

<objective>
Create the notification infrastructure for task events: a BlockNote JSON parser to extract @mentioned user IDs, and two internal actions to send push notifications for task assignment and user mentions.

Purpose: Provides the backend building blocks that task and comment mutations will schedule in Plan 02.
Output: Two new files — a reusable BlockNote utility and a task notifications action module.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-notifications-and-polish/07-RESEARCH.md

# Existing push notification pattern to replicate
@convex/pushNotifications.ts
@convex/pushSubscription.ts
# Existing internal action pattern
@convex/emails.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlockNote mention extraction utility</name>
  <files>convex/utils/blocknote.ts</files>
  <action>
Create `convex/utils/blocknote.ts` with an `extractMentionedUserIds` function.

This function takes a BlockNote JSON string (as stored in task descriptions and comments) and returns an array of unique user ID strings found in `userMention` inline content nodes.

Implementation details:
- Input: `documentJson: string` (BlockNote JSON string)
- Output: `string[]` (unique user IDs)
- Parse the JSON string into an array of block objects
- Recursively traverse blocks: each block has optional `content` (inline content array) and optional `children` (nested blocks)
- For each inline content item, check `type === "userMention"` and extract `props.userId`
- Also check nested content in `link` type inline content (links contain a `content` array)
- Use a `Set<string>` to deduplicate user IDs
- Wrap entire function in try/catch — return empty array on parse failure (graceful degradation)
- Do NOT use `"use node"` directive — this is a pure utility used by mutations (not actions)

Type definitions (inline, not imported from BlockNote):
```typescript
type BlockNoteBlock = {
  type: string;
  content?: InlineContent[];
  children?: BlockNoteBlock[];
  [key: string]: unknown;
};

type InlineContent =
  | { type: "text"; text: string; styles: Record<string, unknown> }
  | { type: "link"; content: InlineContent[]; href: string }
  | { type: "userMention"; props: { userId: string } }
  | { type: string; [key: string]: unknown };
```

Export the function as a named export.
  </action>
  <verify>Run `npx convex dev --once` (or check TypeScript compilation). The file should compile without errors. No runtime test needed — this is a pure utility.</verify>
  <done>convex/utils/blocknote.ts exists with extractMentionedUserIds function that recursively traverses BlockNote JSON and extracts userMention IDs</done>
</task>

<task type="auto">
  <name>Task 2: Create task notification internal actions</name>
  <files>convex/taskNotifications.ts</files>
  <action>
Create `convex/taskNotifications.ts` with two internal actions: `notifyTaskAssignment` and `notifyUserMentions`.

**IMPORTANT:** This file MUST start with `"use node";` directive since it uses `web-push` (Node.js library).

**notifyTaskAssignment** — sends push notification when a user is assigned to a task:
- Args: `taskId: v.id("tasks")`, `assigneeId: v.id("users")`, `taskTitle: v.string()`, `assignedBy: v.object({ name: v.string(), id: v.id("users") })`
- Returns: `v.null()`
- Use `internalAction` (from `"./_generated/server"`)
- Build notification payload:
  - title: `"${assignedBy.name} assigned you a task"`
  - body: `taskTitle`
  - data.url: `/workspaces/${task.workspaceId}/projects/${task.projectId}?task=${taskId}` (query tasks.get to get workspaceId/projectId)
- Query `api.pushSubscription.usersSubscriptions` with `[assigneeId]` to get subscriptions
- Setup VAPID from `process.env.VAPID_SUBJECT`, `process.env.VAPID_PUBLIC_KEY`, `process.env.VAPID_PRIVATE_KEY`
- If any VAPID var missing, `console.error` and return null (don't throw — graceful degradation)
- Call `webpush.setVapidDetails(subject, publicKey, privateKey)`
- Send via `Promise.allSettled` with `webpush.sendNotification` per subscription
- Log errors via `console.error`, don't throw on individual send failures

**notifyUserMentions** — sends push notification when users are @mentioned:
- Args: `taskId: v.id("tasks")`, `mentionedUserIds: v.array(v.string())`, `taskTitle: v.string()`, `mentionedBy: v.object({ name: v.string(), id: v.id("users") })`, `context: v.union(v.literal("task description"), v.literal("comment"))`
- Note: `mentionedUserIds` is `v.array(v.string())` not `v.array(v.id("users"))` because IDs come from JSON parsing and are plain strings
- Returns: `v.null()`
- Build notification payload:
  - title: `"${mentionedBy.name} mentioned you"`
  - body: `"In ${context} for: ${taskTitle}"`
  - data.url: same pattern as assignment notification
- Query `api.pushSubscription.usersSubscriptions` with mentionedUserIds (cast to Id array via `as any` since the strings are valid Convex IDs from the database)
- Same VAPID setup and send pattern as notifyTaskAssignment
- Send to ALL mentioned users' subscriptions

Follow the exact patterns from `convex/pushNotifications.ts` for VAPID setup and web-push sending. Follow `convex/emails.ts` for `internalAction` import pattern.

Import `api` from `"./_generated/api"` and `internal` is NOT needed (these are the endpoints, not callers).
  </action>
  <verify>Run `npx convex dev --once` to verify TypeScript compilation. Both internal actions should be available in the generated API types. Check `convex/_generated/api.d.ts` for `taskNotifications.notifyTaskAssignment` and `taskNotifications.notifyUserMentions`.</verify>
  <done>convex/taskNotifications.ts exists with notifyTaskAssignment and notifyUserMentions internal actions using web-push and VAPID pattern from existing pushNotifications.ts</done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` completes without TypeScript errors
2. `convex/utils/blocknote.ts` exports `extractMentionedUserIds`
3. `convex/taskNotifications.ts` exports `notifyTaskAssignment` and `notifyUserMentions` as internal actions
4. Generated API types include `internal.taskNotifications.notifyTaskAssignment` and `internal.taskNotifications.notifyUserMentions`
</verification>

<success_criteria>
- BlockNote utility correctly parses nested block structure and extracts userMention IDs
- Both internal actions follow the exact web-push pattern from existing pushNotifications.ts
- VAPID setup is graceful (console.error, not throw) so missing env vars don't crash the app
- All files compile with `npx convex dev --once`
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-and-polish/07-01-SUMMARY.md`
</output>
