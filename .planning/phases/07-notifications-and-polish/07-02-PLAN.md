---
phase: 07-notifications-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - convex/tasks.ts
  - convex/taskComments.ts
autonomous: true

must_haves:
  truths:
    - "User receives push notification when assigned to a task (create or update)"
    - "User receives push notification when @mentioned in a task description (create or update)"
    - "User receives push notification when @mentioned in a task comment (create or update)"
    - "User does NOT receive notification for their own actions (self-assignment, self-mention)"
    - "Editing a description or comment only notifies NEWLY added mentions, not existing ones"
  artifacts:
    - path: "convex/tasks.ts"
      provides: "Task mutations with notification scheduling"
      contains: "ctx.scheduler.runAfter"
    - path: "convex/taskComments.ts"
      provides: "Comment mutations with notification scheduling"
      contains: "ctx.scheduler.runAfter"
  key_links:
    - from: "convex/tasks.ts"
      to: "convex/taskNotifications.ts"
      via: "ctx.scheduler.runAfter(0, internal.taskNotifications.*)"
      pattern: "internal\\.taskNotifications\\."
    - from: "convex/taskComments.ts"
      to: "convex/taskNotifications.ts"
      via: "ctx.scheduler.runAfter(0, internal.taskNotifications.*)"
      pattern: "internal\\.taskNotifications\\."
    - from: "convex/tasks.ts"
      to: "convex/utils/blocknote.ts"
      via: "extractMentionedUserIds import"
      pattern: "import.*extractMentionedUserIds.*blocknote"
    - from: "convex/taskComments.ts"
      to: "convex/utils/blocknote.ts"
      via: "extractMentionedUserIds import"
      pattern: "import.*extractMentionedUserIds.*blocknote"
---

<objective>
Wire task and comment mutations to schedule push notifications for assignment changes and @mentions, completing the notification pipeline.

Purpose: Connects the notification actions (from Plan 01) to the actual user events, completing the Phase 7 success criteria.
Output: Modified tasks.ts and taskComments.ts with scheduler calls for all notification triggers.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-notifications-and-polish/07-RESEARCH.md
@.planning/phases/07-notifications-and-polish/07-01-SUMMARY.md

# Files being modified
@convex/tasks.ts
@convex/taskComments.ts

# Notification infrastructure created in Plan 01
@convex/taskNotifications.ts
@convex/utils/blocknote.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire task mutations for assignment and mention notifications</name>
  <files>convex/tasks.ts</files>
  <action>
Modify `convex/tasks.ts` to schedule notifications when tasks are created or updated.

Add these imports at the top:
```typescript
import { internal } from "./_generated/api";
import { extractMentionedUserIds } from "./utils/blocknote";
```

**In `create` mutation** — after `await ctx.db.insert("tasks", ...)` and before `return taskId`:

1. **Assignment notification:** If `args.assigneeId` is provided AND is not the current user (`args.assigneeId !== userId`):
   - Get the current user: `const user = await ctx.db.get(userId);`
   - Schedule: `await ctx.scheduler.runAfter(0, internal.taskNotifications.notifyTaskAssignment, { taskId, assigneeId: args.assigneeId, taskTitle: args.title, assignedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId } });`

2. **Description mention notification:** If `args.description` is provided:
   - Extract mentions: `const mentionedUserIds = extractMentionedUserIds(args.description);`
   - Filter out self: `const filteredMentions = mentionedUserIds.filter(id => id !== userId);`
   - If `filteredMentions.length > 0`, schedule: `await ctx.scheduler.runAfter(0, internal.taskNotifications.notifyUserMentions, { taskId, mentionedUserIds: filteredMentions, taskTitle: args.title, mentionedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId }, context: "task description" });`
   - Note: reuse the `user` variable from above (fetch it once regardless, before both checks)

**In `update` mutation** — after `await ctx.db.patch(taskId, patch)` and before `return null`:

1. **Assignment change notification:** Detect if assignee changed:
   - `const assigneeChanged = assigneeId !== undefined && assigneeId !== null && assigneeId !== task.assigneeId;`
   - If `assigneeChanged && assigneeId !== userId`:
     - Get current user: `const user = await ctx.db.get(userId);`
     - Schedule notifyTaskAssignment with `{ taskId, assigneeId, taskTitle: title ?? task.title, assignedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId } }`

2. **Description mention notification (diff-based):** If `description !== undefined`:
   - Extract old mentions: `const oldMentions = new Set(task.description ? extractMentionedUserIds(task.description) : []);`
   - Extract new mentions: `const newMentions = extractMentionedUserIds(description);`
   - Find newly added: `const addedMentions = newMentions.filter(id => !oldMentions.has(id) && id !== userId);`
   - If `addedMentions.length > 0`:
     - Get user (reuse if already fetched above): `const user = user ?? await ctx.db.get(userId);` — actually, use a let variable pattern to avoid refetching
     - Schedule notifyUserMentions with `{ taskId, mentionedUserIds: addedMentions, taskTitle: title ?? task.title, mentionedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId }, context: "task description" }`

**Variable scoping approach for update mutation:** Declare `let currentUser: any = null;` early in the handler. Fetch it lazily only when needed (on first notification trigger). This avoids unnecessary db reads when no notification is needed.

**IMPORTANT:** All scheduler calls MUST come AFTER `ctx.db.patch` / `ctx.db.insert` to ensure the database write succeeds before scheduling the notification.
  </action>
  <verify>Run `npx convex dev --once` to confirm TypeScript compilation succeeds. Check that `internal.taskNotifications.notifyTaskAssignment` and `internal.taskNotifications.notifyUserMentions` references resolve correctly.</verify>
  <done>tasks.ts create mutation schedules notifications for assignment and description mentions; update mutation schedules notifications only for changed assignments and newly added mentions</done>
</task>

<task type="auto">
  <name>Task 2: Wire comment mutations for mention notifications</name>
  <files>convex/taskComments.ts</files>
  <action>
Modify `convex/taskComments.ts` to schedule notifications when comments are created or updated with @mentions.

Add these imports at the top:
```typescript
import { internal } from "./_generated/api";
import { extractMentionedUserIds } from "./utils/blocknote";
```

**In `create` mutation** — after `await ctx.db.insert("taskComments", ...)` and before `return commentId`:

1. Extract mentions from comment body: `const mentionedUserIds = extractMentionedUserIds(body);`
2. Filter out self: `const filteredMentions = mentionedUserIds.filter(id => id !== userId);`
3. If `filteredMentions.length > 0`:
   - Get task for title: task is already fetched above (`const task = await ctx.db.get(taskId);`)
   - Get user: `const user = await ctx.db.get(userId);`
   - Schedule: `await ctx.scheduler.runAfter(0, internal.taskNotifications.notifyUserMentions, { taskId, mentionedUserIds: filteredMentions, taskTitle: task?.title ?? "a task", mentionedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId }, context: "comment" });`

**In `update` mutation** — after `await ctx.db.patch(id, { body: body.trim() })` and before `return null`:

1. Detect newly added mentions (diff old vs new):
   - Extract old mentions: `const oldMentions = new Set(comment.body ? extractMentionedUserIds(comment.body) : []);`
   - Extract new mentions: `const newMentions = extractMentionedUserIds(body);`
   - Find newly added: `const addedMentions = newMentions.filter(id => !oldMentions.has(id) && id !== userId);`
2. If `addedMentions.length > 0`:
   - Get task: `const task = await ctx.db.get(comment.taskId);`
   - Get user: `const user = await ctx.db.get(userId);`
   - Schedule notifyUserMentions with `{ taskId: comment.taskId, mentionedUserIds: addedMentions, taskTitle: task?.title ?? "a task", mentionedBy: { name: user?.name ?? user?.email ?? "Someone", id: userId }, context: "comment" }`

**IMPORTANT:** All scheduler calls MUST come AFTER database writes.
  </action>
  <verify>Run `npx convex dev --once` to confirm TypeScript compilation succeeds. Verify both create and update mutations now import and use extractMentionedUserIds and schedule notifications via internal.taskNotifications.</verify>
  <done>taskComments.ts create mutation schedules mention notifications for new comments; update mutation schedules notifications only for newly added mentions in edited comments</done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` completes without TypeScript errors
2. `convex/tasks.ts` imports `internal` and `extractMentionedUserIds`
3. `convex/tasks.ts` `create` mutation schedules both assignment and mention notifications
4. `convex/tasks.ts` `update` mutation detects assignee changes and new mentions before scheduling
5. `convex/taskComments.ts` imports `internal` and `extractMentionedUserIds`
6. `convex/taskComments.ts` `create` mutation schedules mention notifications
7. `convex/taskComments.ts` `update` mutation only notifies newly added mentions (diff-based)
8. No self-notifications: all scheduler calls filter out `userId` from recipients
9. All scheduler calls come AFTER database writes
10. `npm run lint` passes with 0 warnings
</verification>

<success_criteria>
- Creating a task with an assignee triggers push notification to the assignee (unless self-assigned)
- Creating a task with @mentions in description triggers push notification to mentioned users
- Updating a task assignee triggers notification to the new assignee only
- Updating a task description triggers notification only for newly added @mentions
- Creating a comment with @mentions triggers notification to mentioned users
- Editing a comment to add @mentions triggers notification only for newly added mentions
- No user receives notification for their own actions
- All TypeScript compiles and lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-and-polish/07-02-SUMMARY.md`
</output>
