---
phase: 13.1-fix-deployment-pipeline-and-environment-configuration
plan: 01
subsystem: infra
tags: [github-actions, ci-cd, cloudflare-workers, partykit, convex, wrangler]

requires:
  - phase: 13-diagram-multiplayer-cursors
    provides: "All application features requiring deployment"
provides:
  - "GitHub Actions CI/CD pipeline for 3-service sequential deployment"
  - ".env.example documenting all environment variables"
  - "npm overrides for y-excalidraw peer dep resolution"
affects: [deployment, infrastructure, onboarding]

tech-stack:
  added: []
  patterns: [github-actions-sequential-jobs, npm-overrides]

key-files:
  created:
    - .env.example
    - .github/workflows/deploy-production.yml
    - .npmrc (created then removed in favor of overrides)
  modified:
    - .gitignore
    - package.json
    - package-lock.json
    - wrangler.jsonc

key-decisions:
  - "Separate Cloudflare tokens: CLOUDFLARE_WORKERS_API_TOKEN for wrangler deploy, existing CLOUDFLARE_API_TOKEN for RTK video calls"
  - "PartyKit CI auth via GitHub token (GITHUB_TOKEN/GITHUB_LOGIN) — Clerk-based tokens hang in CI"
  - "npm overrides instead of --legacy-peer-deps for y-excalidraw peer dep resolution"
  - "Committed package-lock.json (was gitignored) for deterministic CI installs"
  - "Relaxed health checks: PartyKit returns non-200 to HTTP (WebSocket server), frontend may redirect"
  - "account_id in wrangler.jsonc + CLOUDFLARE_ACCOUNT_ID env var to skip /memberships API call"
  - "CLOUDFLARE_RTK_API_TOKEN removed from CI — not in Convex env, RTK calls work without it"

patterns-established:
  - "CI/CD: 3-job sequential deployment (Convex → PartyKit → Frontend) with concurrency group"
  - "Health checks: verify reachability only (not HTTP 200) for WebSocket and SPA servers"

duration: 25min
completed: 2026-02-12
---

# Phase 13.1: Fix Deployment Pipeline Summary

**GitHub Actions CI/CD with sequential Convex/PartyKit/Cloudflare Workers deployment, .env.example, and npm peer dep overrides**

## Performance

- **Duration:** ~25 min (including iterative CI debugging)
- **Started:** 2026-02-12
- **Completed:** 2026-02-12
- **Tasks:** 3 (2 auto + 1 checkpoint)
- **Files modified:** 6

## Accomplishments
- GitHub Actions workflow deploys all 3 services in correct order with concurrency controls
- .env.example documents every environment variable across Convex, PartyKit, and frontend
- package-lock.json committed for deterministic CI installs
- npm overrides resolve y-excalidraw peer dep conflict without --legacy-peer-deps

## Task Commits

1. **Task 1: Create .env.example and update .gitignore** - `3cfc1a1`
2. **Task 2: Create GitHub Actions deployment workflow** - `5daf178`
3. **Task 3: Verify deployment and set up secrets** - checkpoint (user verified)

Iterative CI fixes:
- `0f55ea6` - Remove RTK API token from CI
- `78e3377` - Commit package-lock.json
- `a41299f` → `6d34ba6` - .npmrc → npm overrides for peer deps
- `b8073e2` - Add PARTYKIT_LOGIN
- `8db71ec` - Switch to GitHub token auth for PartyKit
- `3687bd9` - Relax PartyKit health check
- `2e9fb3d` - Separate Cloudflare Workers deploy token
- `2a064b6` - Add account_id to wrangler.jsonc
- `68a627e` - Pass CLOUDFLARE_ACCOUNT_ID env var
- `1bf32cb` - Follow redirects in frontend health check

## Files Created/Modified
- `.env.example` - Complete environment variable documentation
- `.github/workflows/deploy-production.yml` - 3-job sequential CI/CD pipeline
- `.gitignore` - Whitelists .env.example, removed package-lock.json ignore
- `package.json` - npm overrides for y-excalidraw
- `package-lock.json` - Committed for CI
- `wrangler.jsonc` - Added account_id for CI deploys

## Decisions Made
- Separate Cloudflare tokens (Workers deploy vs RTK) — least privilege
- GitHub token for PartyKit CI — Clerk token hangs (tries to refresh session)
- npm overrides over .npmrc — cleaner, explicit in package.json
- Relaxed health checks — WebSocket servers and SPAs don't return 200 to plain HTTP

## Deviations from Plan
Multiple iterative fixes required during CI debugging — plan couldn't anticipate all CI environment differences (missing lockfile, peer dep strictness, PartyKit auth mechanism, Cloudflare token permissions, health check behavior).

## Issues Encountered
- `npm ci` requires committed lockfile (was gitignored)
- `npm ci` strict peer dep resolution fails without overrides
- PartyKit Clerk tokens hang in CI (Clerk SDK tries browser-based session refresh)
- PartyKit needs both PARTYKIT_LOGIN + PARTYKIT_TOKEN (not just token)
- Wrangler needs Zone > Workers Routes > Edit permission for custom domain routes
- Wrangler calls /memberships before reading config — needs CLOUDFLARE_ACCOUNT_ID env var
- Health checks fail on WebSocket servers (non-200) and SPA redirects

## User Setup Required
User completed setup during checkpoint:
- GitHub environment "production" created with all secrets
- PartyKit production deployed
- Cloudflare Workers API token with correct permissions
- All three services deploying successfully via GitHub Actions

## Next Phase Readiness
- CI/CD pipeline fully operational
- All v0.10 features deployed to production
- Ready for next milestone

---
*Phase: 13.1-fix-deployment-pipeline-and-environment-configuration*
*Completed: 2026-02-12*
