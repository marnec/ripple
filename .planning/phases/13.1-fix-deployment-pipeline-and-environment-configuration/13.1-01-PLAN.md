---
phase: 13.1-fix-deployment-pipeline-and-environment-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .env.example
  - .gitignore
  - .github/workflows/deploy-production.yml
autonomous: false
user_setup:
  - service: github-actions
    why: "CI/CD deployment secrets for all three services"
    env_vars:
      - name: CONVEX_DEPLOY_KEY
        source: "Convex Dashboard -> Settings -> Deploy Key (generate production deploy key)"
      - name: VITE_CONVEX_URL
        source: "Convex Dashboard -> Settings -> URL (production deployment .convex.cloud URL)"
      - name: VITE_CONVEX_SITE_URL
        source: "Convex Dashboard -> Settings -> URL (production deployment .convex.site URL)"
      - name: CONVEX_SITE_URL
        source: "Same value as VITE_CONVEX_SITE_URL (used by PartyKit for auth verification)"
      - name: VITE_PARTYKIT_HOST
        source: "Output of first 'npx partykit deploy' (format: ripple-collaboration.USERNAME.partykit.dev)"
      - name: PARTYKIT_TOKEN
        source: "PartyKit Dashboard or 'npx partykit login' then check ~/.partykit/config.json"
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token (Workers edit permission)"
      - name: AUTH_RESEND_KEY
        source: "Resend Dashboard -> API Keys (used by Convex auth email)"
      - name: SITE_URL
        source: "Production frontend URL: https://ripple.conduits.space"
      - name: VAPID_SUBJECT
        source: "mailto:your@email.com (for web push notifications)"
      - name: VAPID_PUBLIC_KEY
        source: "VAPID key pair generated during initial setup (check Convex dashboard env vars)"
      - name: VAPID_PRIVATE_KEY
        source: "VAPID key pair generated during initial setup (check Convex dashboard env vars)"
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard -> Workers & Pages -> Account ID (for video calls RTK)"
      - name: CLOUDFLARE_RTK_APP_ID
        source: "Cloudflare Dashboard -> Calls -> App ID (for video calls RTK)"
      - name: CLOUDFLARE_RTK_API_TOKEN
        source: "Cloudflare Dashboard -> Calls -> API Token (for video calls RTK, separate from deploy token)"
    dashboard_config:
      - task: "Create 'production' environment in GitHub repo settings"
        location: "GitHub -> Repo Settings -> Environments -> New Environment"
      - task: "Add all secrets listed above to the production environment"
        location: "GitHub -> Repo Settings -> Environments -> production -> Environment secrets"
  - service: partykit
    why: "Initial production deployment to determine production host URL"
    env_vars:
      - name: CONVEX_SITE_URL
        source: "Production Convex site URL (set via 'npx partykit env add CONVEX_SITE_URL')"
    dashboard_config:
      - task: "Run initial 'npx partykit deploy' to get production URL"
        location: "Terminal (outputs URL like ripple-collaboration.USERNAME.partykit.dev)"
  - service: convex
    why: "Production environment variables for backend services"
    dashboard_config:
      - task: "Set production env vars: AUTH_RESEND_KEY, SITE_URL, VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_RTK_APP_ID, CLOUDFLARE_RTK_API_TOKEN"
        location: "Convex Dashboard -> Production Deployment -> Settings -> Environment Variables"

must_haves:
  truths:
    - ".env.example documents every environment variable needed for development setup"
    - "GitHub Actions workflow deploys Convex, PartyKit, and frontend in correct sequential order"
    - "Concurrent production deployments are prevented via concurrency group"
    - "Post-deployment health checks verify each service is reachable"
    - "User can populate GitHub secrets and trigger a successful production deployment"
  artifacts:
    - path: ".env.example"
      provides: "Complete environment variable documentation for developers"
      contains: "VITE_CONVEX_URL"
    - path: ".github/workflows/deploy-production.yml"
      provides: "CI/CD pipeline with sequential multi-service deployment"
      contains: "deploy-convex"
    - path: ".gitignore"
      provides: "Updated to whitelist .env.example"
      contains: "!.env.example"
  key_links:
    - from: ".github/workflows/deploy-production.yml"
      to: "Convex CLI"
      via: "npx convex deploy with CONVEX_DEPLOY_KEY"
      pattern: "convex deploy"
    - from: ".github/workflows/deploy-production.yml"
      to: "PartyKit CLI"
      via: "npx partykit deploy --var CONVEX_SITE_URL"
      pattern: "partykit deploy"
    - from: ".github/workflows/deploy-production.yml"
      to: "Cloudflare Wrangler"
      via: "npx wrangler deploy with CLOUDFLARE_API_TOKEN"
      pattern: "wrangler deploy"
    - from: ".github/workflows/deploy-production.yml"
      to: "Vite build"
      via: "VITE_ env vars set during npm run build step"
      pattern: "VITE_CONVEX_URL.*VITE_PARTYKIT_HOST"
---

<objective>
Create the complete deployment pipeline infrastructure: environment variable documentation (.env.example), and GitHub Actions CI/CD workflow for automated sequential deployment of all three services (Convex backend, PartyKit collaboration server, Cloudflare Workers frontend).

Purpose: The project has no CI/CD, no .env.example, and PartyKit production host is still localhost:1999. This blocks reliable production deployment of the multiplayer collaboration features built in Phases 11-13.

Output: .env.example, .github/workflows/deploy-production.yml, updated .gitignore
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-fix-deployment-pipeline-and-environment-configuration/13.1-RESEARCH.md

# Key source files for understanding current env var usage
@partykit/server.ts
@src/hooks/use-yjs-provider.ts
@src/main.tsx
@convex/auth.config.ts
@convex/emails.ts
@convex/taskNotifications.ts
@convex/callSessions.ts
@partykit.json
@wrangler.jsonc
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .env.example and update .gitignore</name>
  <files>.env.example, .gitignore</files>
  <action>
1. Update `.gitignore` to whitelist `.env.example`. The current gitignore has `*.env*` which would exclude `.env.example`. Add `!.env.example` immediately after the `*.env*` line.

2. Create `.env.example` documenting ALL environment variables used across the three services. Group by service with clear section headers and comments. Include:

**Convex Backend Configuration:**
- `CONVEX_DEPLOYMENT=dev:your-deployment-name` — Auto-set by `npx convex dev` (development only)

**Frontend Build-Time Variables (Vite - statically replaced during build):**
- `VITE_CONVEX_URL=https://your-deployment.convex.cloud` — Convex API URL (used in `src/main.tsx`)
- `VITE_CONVEX_SITE_URL=https://your-deployment.convex.site` — Convex HTTP actions URL (currently unused in frontend but kept for consistency)
- `VITE_PARTYKIT_HOST=localhost:1999` — PartyKit WebSocket host. Dev: localhost:1999. Prod: ripple-collaboration.USERNAME.partykit.dev (used in `src/hooks/use-yjs-provider.ts`)

**PartyKit Runtime Variables:**
- `CONVEX_SITE_URL=https://your-deployment.convex.site` — Used by PartyKit server to verify auth tokens (accessed via `this.room.env.CONVEX_SITE_URL` in `partykit/server.ts`). In production, set via `npx partykit env add` or `--var` flag.

**Convex Backend Runtime Variables (set via Convex Dashboard or `npx convex env set`):**
- `AUTH_RESEND_KEY` — Resend API key for auth emails (used in `convex/auth.ts`)
- `SITE_URL` — Production frontend URL for invite links (used in `convex/emails.ts`)
- `VAPID_SUBJECT` — Web push notification subject (mailto:email, used in `convex/taskNotifications.ts`, `convex/pushNotifications.ts`, `convex/chatNotifications.ts`)
- `VAPID_PUBLIC_KEY` — VAPID public key for web push
- `VAPID_PRIVATE_KEY` — VAPID private key for web push
- `CLOUDFLARE_ACCOUNT_ID` — Cloudflare account for video calls RTK (used in `convex/callSessions.ts`)
- `CLOUDFLARE_RTK_APP_ID` — Cloudflare Calls app ID
- `CLOUDFLARE_API_TOKEN` — Cloudflare API token for RTK (note: this is the RTK token used by Convex, different from the Workers deploy token)

**Development Setup Flag:**
- `SETUP_SCRIPT_RAN=1` — Internal flag set by setup.mjs

**CI/CD Secrets (GitHub Actions only - DO NOT SET LOCALLY):**
- Document as comments only (not key=value): CONVEX_DEPLOY_KEY, PARTYKIT_TOKEN, CLOUDFLARE_API_TOKEN (for Workers deployment)

Include a header comment: "Copy this file to .env.local and fill in your values. See README for setup instructions."

Mark variables as "# REQUIRED" or "# OPTIONAL" and indicate "# Build-time only" for VITE_ vars.
  </action>
  <verify>
Run `git status` to confirm both files show as modified/new. Run `grep -c "VITE_CONVEX_URL" .env.example` to confirm env vars are documented. Run `grep "!.env.example" .gitignore` to confirm whitelist entry exists.
  </verify>
  <done>.env.example exists with all environment variables grouped by service, .gitignore whitelists .env.example</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deployment workflow</name>
  <files>.github/workflows/deploy-production.yml</files>
  <action>
Create `.github/workflows/deploy-production.yml` with the following structure.

**Trigger:** Push to `main` branch + `workflow_dispatch` for manual triggers.

**Concurrency:** Group `production-deployment` with `cancel-in-progress: false` (queue deployments, don't cancel in-progress ones).

**Three sequential jobs:**

**Job 1: deploy-convex**
- `runs-on: ubuntu-latest`
- `environment: production`
- Steps: checkout, setup-node (v20, cache npm), `npm ci`, set Convex env vars (AUTH_RESEND_KEY, SITE_URL, VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_RTK_APP_ID, CLOUDFLARE_RTK_API_TOKEN via `npx convex env set`), deploy with `npx convex deploy` using CONVEX_DEPLOY_KEY env var.
- Note: `convex deploy` automatically handles schema migrations. Do NOT use `--cmd 'npm run build'` flag — Convex deploy only needs the convex/ directory, not a frontend build.
- Health check: `curl -f -s -o /dev/null -w "%{http_code}" "$VITE_CONVEX_URL"` (the Convex cloud URL responds with 200).

**Job 2: deploy-partykit**
- `needs: deploy-convex`
- `runs-on: ubuntu-latest`
- `environment: production`
- Steps: checkout, setup-node (v20, cache npm), `npm ci`, deploy with `npx partykit deploy --var CONVEX_SITE_URL=${{ secrets.CONVEX_SITE_URL }}` using PARTYKIT_TOKEN env var.
- Health check: `curl -f -s -o /dev/null -I "https://${{ secrets.VITE_PARTYKIT_HOST }}"` (PartyKit host responds to HTTP).

**Job 3: deploy-frontend**
- `needs: [deploy-convex, deploy-partykit]`
- `runs-on: ubuntu-latest`
- `environment: production`
- Steps: checkout, setup-node (v20, cache npm), `npm ci`, build frontend with `npm run build` (set VITE_CONVEX_URL, VITE_CONVEX_SITE_URL, VITE_PARTYKIT_HOST as env vars during this step), deploy with `npx wrangler deploy` using CLOUDFLARE_API_TOKEN env var.
- Health check: `curl -f -s -o /dev/null -I "https://ripple.conduits.space"`.
- Add deployment summary step that writes to `$GITHUB_STEP_SUMMARY` listing all three service statuses.

**Important details:**
- Use `actions/checkout@v4` and `actions/setup-node@v4` with `node-version: '20'` and `cache: 'npm'`
- For Convex env vars, use a multi-line run step that sets each var individually with `npx convex env set KEY "${{ secrets.KEY }}"` (each on its own line). All Convex env set commands need CONVEX_DEPLOY_KEY in env.
- Do NOT put secrets in the `env:` section at workflow level — only at job/step level.
- Health checks should use `|| exit 1` and have a `continue-on-error: false` (default).
- Add a `timeout-minutes: 10` at the job level for safety.
  </action>
  <verify>
Run `cat .github/workflows/deploy-production.yml | head -5` to confirm file exists. Verify YAML syntax by checking the file starts with `name:`. Verify three jobs exist: `grep -c "runs-on:" .github/workflows/deploy-production.yml` should return 3. Verify sequential ordering: `grep "needs:" .github/workflows/deploy-production.yml` should show deploy-partykit needs deploy-convex and deploy-frontend needs both. Verify concurrency: `grep "production-deployment" .github/workflows/deploy-production.yml` should match.
  </verify>
  <done>GitHub Actions workflow exists with 3 sequential jobs (Convex -> PartyKit -> Frontend), concurrency controls, health checks, and all required secrets referenced</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify deployment configuration and set up secrets</name>
  <what-built>
Complete deployment pipeline:
- `.env.example` documenting all environment variables
- `.github/workflows/deploy-production.yml` with sequential 3-service deployment
- Updated `.gitignore` to whitelist `.env.example`
  </what-built>
  <how-to-verify>
1. Review `.env.example` - confirm all variables match what your services need
2. Review `.github/workflows/deploy-production.yml` - confirm the workflow structure looks correct
3. Set up production secrets:
   a. Go to GitHub repo -> Settings -> Environments -> Create "production" environment
   b. Add all required secrets (see the CI/CD Secrets section in .env.example for the full list)
   c. Required secrets: CONVEX_DEPLOY_KEY, VITE_CONVEX_URL, VITE_CONVEX_SITE_URL, CONVEX_SITE_URL, VITE_PARTYKIT_HOST, PARTYKIT_TOKEN, CLOUDFLARE_API_TOKEN, AUTH_RESEND_KEY, SITE_URL, VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_RTK_APP_ID, CLOUDFLARE_RTK_API_TOKEN
4. If you haven't deployed PartyKit to production yet: run `npx partykit deploy` locally to determine the production URL (format: ripple-collaboration.USERNAME.partykit.dev), then use that as VITE_PARTYKIT_HOST secret
5. Push to main (or use workflow_dispatch) to trigger first deployment
6. Verify all three jobs succeed in the GitHub Actions tab
  </how-to-verify>
  <resume-signal>Type "approved" to complete the phase, or describe any issues with the workflow or configuration</resume-signal>
</task>

</tasks>

<verification>
- `.env.example` exists and documents all VITE_, CONVEX_SITE_URL, Convex runtime, and CI/CD-only variables
- `.gitignore` has `!.env.example` to whitelist the example file
- `.github/workflows/deploy-production.yml` has 3 jobs: deploy-convex, deploy-partykit, deploy-frontend
- Jobs run sequentially: Convex first, then PartyKit (needs Convex), then Frontend (needs both)
- Concurrency group prevents parallel production deployments
- Health checks verify each service after deployment
- No secrets are hardcoded in any committed file
</verification>

<success_criteria>
- .env.example committed and visible in repo (not gitignored)
- GitHub Actions workflow triggers on push to main
- All three services deploy in correct order with proper environment variables
- Health checks pass for each service
- User has populated GitHub secrets and verified first successful deployment
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-fix-deployment-pipeline-and-environment-configuration/13.1-01-SUMMARY.md`
</output>
