---
phase: 01-projects-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/enums/roles.ts
  - convex/schema.ts
  - convex/projects.ts
  - convex/projectMembers.ts
autonomous: true

must_haves:
  truths:
    - "Projects table exists with name, color, workspaceId, roleCount fields"
    - "ProjectMembers table exists with proper indexes for bi-directional queries"
    - "Creating a project also creates creator's admin membership atomically"
    - "Creating a project auto-creates a linked private channel"
    - "Only workspace admins can create projects"
    - "Project queries filter by user membership"
  artifacts:
    - path: "shared/enums/roles.ts"
      provides: "ProjectRole enum (admin, member)"
      contains: "ProjectRole"
    - path: "convex/schema.ts"
      provides: "projects and projectMembers table definitions"
      contains: "projects:"
    - path: "convex/projects.ts"
      provides: "CRUD operations for projects"
      exports: ["create", "get", "list", "listByUserMembership", "update", "remove"]
    - path: "convex/projectMembers.ts"
      provides: "Membership management operations"
      exports: ["addToProject", "removeFromProject", "membersByProject"]
  key_links:
    - from: "convex/projects.ts"
      to: "convex/schema.ts"
      via: "table definitions"
      pattern: "ctx\\.db\\.insert\\(\"projects\""
    - from: "convex/projects.ts"
      to: "convex/channels.ts"
      via: "auto-create channel in create mutation"
      pattern: "ctx\\.db\\.insert\\(\"channels\""
    - from: "convex/projectMembers.ts"
      to: "convex/channelMembers.ts"
      via: "sync membership to linked channel"
      pattern: "ctx\\.db\\.insert\\(\"channelMembers\""
---

<objective>
Implement the backend foundation for projects: database schema, role enum, and Convex mutations/queries for project and membership CRUD operations.

Purpose: Establish the data layer that all frontend features will depend on. Projects need tables, indexes, and API operations before any UI can be built.

Output: Working Convex backend with projects table, projectMembers table, and all required mutations/queries following established channel/document patterns.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-projects-foundation/01-CONTEXT.md
@.planning/phases/01-projects-foundation/01-RESEARCH.md

# Key reference files (existing patterns to follow)
@convex/schema.ts
@convex/channels.ts
@convex/channelMembers.ts
@shared/enums/roles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProjectRole enum and schema tables</name>
  <files>
    shared/enums/roles.ts
    convex/schema.ts
  </files>
  <action>
1. In `shared/enums/roles.ts`, add ProjectRole enum following the existing pattern:
   ```typescript
   export const ProjectRole = {
     ADMIN: "admin",
     MEMBER: "member"
   } as const
   ```

2. In `convex/schema.ts`:
   - Import ProjectRole from @shared/enums/roles
   - Create projectRoleSchema validator (like channelRoleSchema)
   - Add `projects` table with fields:
     - name: v.string()
     - description: v.optional(v.string())
     - color: v.string() (Tailwind color class like "bg-blue-500")
     - workspaceId: v.id("workspaces")
     - linkedChannelId: v.id("channels") (the auto-created discussion channel)
     - roleCount: v.object with admin/member counts
   - Add indexes: by_workspace, searchIndex by_name with workspaceId filter

   - Add `projectMembers` table with fields:
     - projectId: v.id("projects")
     - workspaceId: v.id("workspaces") (denormalized for efficient queries)
     - userId: v.id("users")
     - role: projectRoleSchema
   - Add indexes: by_user, by_project, by_project_user, by_workspace_user, by_project_role

IMPORTANT: Follow the exact pattern from channels/channelMembers - use satisfies Record for roleCount typing.
  </action>
  <verify>
    Run `npm run lint` - no TypeScript errors in schema.ts or roles.ts
    Run `npx convex dev --once` - schema deploys successfully
  </verify>
  <done>
    ProjectRole enum exists in shared/enums/roles.ts
    projects and projectMembers tables defined in schema.ts with all required indexes
    Schema deploys without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create projects.ts with CRUD operations</name>
  <files>convex/projects.ts</files>
  <action>
Create `convex/projects.ts` following the channels.ts pattern exactly:

1. **create mutation:**
   - Args: name (string), color (string), workspaceId (id)
   - Returns: v.id("projects")
   - Auth: getAuthUserId, throw if not authenticated
   - Authorization: Check workspace membership with by_workspace_user index, require WorkspaceRole.ADMIN
   - Create project with roleCount: { admin: 1, member: 0 }
   - Insert creator as projectMembers with role "admin"
   - Auto-create linked channel:
     - Name: `${name} Discussion`
     - isPublic: false
     - Insert channel and channelMembers for creator
   - Store linkedChannelId in project (patch after channel creation)
   - Return projectId

2. **get query:**
   - Args: id (v.id("projects"))
   - Returns: project object or null
   - Check user has project membership via by_project_user index
   - Return full project document if authorized

3. **list query:**
   - Args: workspaceId
   - Returns: array of projects
   - Simple list all projects in workspace (for admin views)

4. **listByUserMembership query:**
   - Args: workspaceId
   - Returns: array of projects user has access to
   - Query projectMembers with by_workspace_user index
   - Use getAll helper to batch fetch projects
   - Sort alphabetically by name (per CONTEXT.md decision)

5. **update mutation:**
   - Args: id, name (optional), description (optional), color (optional)
   - Authorization: require project admin role
   - Patch only provided fields
   - If name changes, also update linked channel name to `${newName} Discussion`

6. **remove mutation:**
   - Args: id
   - Authorization: require project admin role
   - Delete all projectMembers
   - Delete linked channel (use channels.remove pattern - delete messages, channelMembers first)
   - Delete project

Use the projectValidator pattern from channels.ts for return types.
Import: getAuthUserId, ConvexError, v, mutation, query, getAll, WorkspaceRole, ProjectRole, ChannelRole
  </action>
  <verify>
    Run `npm run lint` - no errors
    Run `npx convex dev --once` - functions deploy successfully
  </verify>
  <done>
    convex/projects.ts exists with create, get, list, listByUserMembership, update, remove
    All mutations have proper authentication and authorization checks
    Create mutation atomically creates project + membership + linked channel
  </done>
</task>

<task type="auto">
  <name>Task 3: Create projectMembers.ts with membership operations</name>
  <files>convex/projectMembers.ts</files>
  <action>
Create `convex/projectMembers.ts` following channelMembers.ts pattern:

1. **membersByProject query:**
   - Args: projectId
   - Returns: array of members with user info (name from users table)
   - Pattern: query projectMembers by_project, then fetch user details
   - Return member object with: _id, projectId, userId, role, name

2. **addToProject mutation:**
   - Args: userId, projectId
   - Auth check (must be authenticated)
   - Authorization: requesting user must be project admin (check by_project_user)
   - Check user not already member (by_project_user unique check)
   - Get project, increment roleCount.member
   - Insert projectMembers record
   - ALSO add user to linked channel (sync membership):
     - Get project.linkedChannelId
     - Insert channelMembers for the user with role "member"
     - Update channel roleCount
   - Return membership id

3. **removeFromProject mutation:**
   - Args: userId, projectId
   - Authorization: requesting user must be project admin
   - Cannot remove last admin (check by_project_role count)
   - Cannot remove self (per CONTEXT.md - "Members cannot remove themselves")
   - Get membership, decrement roleCount
   - Delete projectMembers record
   - ALSO remove from linked channel (sync membership):
     - Remove channelMembers record
     - Update channel roleCount

4. **changeMemberRole mutation:** (for promoting member to admin)
   - Args: projectMemberId, role
   - Authorization: requesting user must be project admin
   - Cannot demote last admin
   - Patch role, update roleCount (decrement old, increment new)
   - Note: channel membership role stays as "member" - project admin doesn't mean channel admin

Import pattern from channelMembers.ts. Use proper validators for return types.
  </action>
  <verify>
    Run `npm run lint` - no errors
    Run `npx convex dev --once` - functions deploy
  </verify>
  <done>
    convex/projectMembers.ts exists with membersByProject, addToProject, removeFromProject, changeMemberRole
    Adding/removing project members also syncs to linked channel
    Cannot remove last admin or self from project
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint` passes with 0 errors
2. `npx convex dev --once` deploys all functions successfully
3. Schema includes projects and projectMembers tables with correct indexes
4. All exported functions visible in convex/_generated/api.d.ts
</verification>

<success_criteria>
- ProjectRole enum exists alongside WorkspaceRole, ChannelRole, DocumentRole
- projects table has: name, description, color, workspaceId, linkedChannelId, roleCount
- projectMembers table has: projectId, workspaceId, userId, role with all required indexes
- projects.create atomically creates project + admin membership + linked channel
- projects.listByUserMembership returns only projects user has access to, sorted alphabetically
- projectMembers operations sync membership to linked channel
- All functions have proper auth and authorization
</success_criteria>

<output>
After completion, create `.planning/phases/01-projects-foundation/01-01-SUMMARY.md`
</output>
