---
phase: 01-projects-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/projects.ts
  - convex/projectMembers.ts
autonomous: true

must_haves:
  truths:
    - "User who creates a project can view it immediately in their sidebar"
    - "Only workspace admins can create projects"
    - "Project creator can add and remove other workspace members"
    - "Members added to a project can access it and its linked channel"
    - "User can only see projects they have membership in"
  artifacts:
    - path: "convex/schema.ts"
      provides: "projects and projectMembers table definitions"
      contains: "projects:"
    - path: "convex/projects.ts"
      provides: "CRUD operations for projects"
      exports: ["create", "get", "list", "listByUserMembership", "update", "remove"]
    - path: "convex/projectMembers.ts"
      provides: "Membership management operations"
      exports: ["addToProject", "removeFromProject", "membersByProject"]
  key_links:
    - from: "convex/projects.ts"
      to: "convex/schema.ts"
      via: "table definitions"
      pattern: "ctx\\.db\\.insert\\(\"projects\""
    - from: "convex/projects.ts"
      to: "convex/channels.ts"
      via: "auto-create channel in create mutation"
      pattern: "ctx\\.db\\.insert\\(\"channels\""
    - from: "convex/projectMembers.ts"
      to: "convex/channelMembers.ts"
      via: "sync membership to linked channel"
      pattern: "ctx\\.db\\.insert\\(\"channelMembers\""
---

<objective>
Implement the backend foundation for projects: database schema and Convex mutations/queries for project and membership CRUD operations.

Purpose: Establish the data layer that all frontend features will depend on. Projects need tables, indexes, and API operations before any UI can be built.

Output: Working Convex backend with projects table, projectMembers table, and all required mutations/queries following established channel/document patterns.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-projects-foundation/01-CONTEXT.md
@.planning/phases/01-projects-foundation/01-RESEARCH.md

# Key reference files (existing patterns to follow)
@convex/schema.ts
@convex/channels.ts
@convex/channelMembers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema tables for projects and projectMembers</name>
  <files>convex/schema.ts</files>
  <action>
In `convex/schema.ts`, add the projects and projectMembers tables:

1. Add `projects` table with fields:
   - name: v.string()
   - description: v.optional(v.string())
   - color: v.string() (Tailwind color class like "bg-blue-500")
   - workspaceId: v.id("workspaces")
   - linkedChannelId: v.id("channels") (the auto-created discussion channel)
   - creatorId: v.id("users") (the user who created the project - this is the "admin")
   - memberCount: v.number() (total members including creator)
   Add indexes: by_workspace, searchIndex by_name with workspaceId filter

2. Add `projectMembers` table with fields:
   - projectId: v.id("projects")
   - workspaceId: v.id("workspaces") (denormalized for efficient queries)
   - userId: v.id("users")
   Add indexes: by_user, by_project, by_project_user, by_workspace_user

IMPORTANT: No role field in projectMembers - per CONTEXT.md "No project-specific roles for v1 - just membership (access or no access)". The creator stored in projects.creatorId is the only one who can manage the project.
  </action>
  <verify>
    Run `npm run lint` - no TypeScript errors in schema.ts
    Run `npx convex dev --once` - schema deploys successfully
  </verify>
  <done>
    projects table defined with name, description, color, workspaceId, linkedChannelId, creatorId, memberCount
    projectMembers table defined with projectId, workspaceId, userId and required indexes
    No role field in projectMembers (access or no access model)
    Schema deploys without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create projects.ts with CRUD operations</name>
  <files>convex/projects.ts</files>
  <action>
Create `convex/projects.ts` following the channels.ts pattern:

1. **create mutation:**
   - Args: name (string), color (string), workspaceId (id)
   - Returns: v.id("projects")
   - Auth: getAuthUserId, throw if not authenticated
   - Authorization: Check workspace membership with by_workspace_user index, require WorkspaceRole.ADMIN
   - Create project with creatorId set to current user, memberCount: 1
   - Insert creator into projectMembers (no role field)
   - Auto-create linked channel:
     - Name: `${name} Discussion`
     - isPublic: false
     - Insert channel and channelMembers for creator
   - Store linkedChannelId in project (patch after channel creation)
   - Return projectId

2. **get query:**
   - Args: id (v.id("projects"))
   - Returns: project object or null
   - Check user has project membership via by_project_user index
   - Return full project document if authorized

3. **list query:**
   - Args: workspaceId
   - Returns: array of projects
   - Simple list all projects in workspace (for admin views)

4. **listByUserMembership query:**
   - Args: workspaceId
   - Returns: array of projects user has access to
   - Query projectMembers with by_workspace_user index
   - Use getAll helper to batch fetch projects
   - Sort alphabetically by name (per CONTEXT.md decision)

5. **update mutation:**
   - Args: id, name (optional), description (optional), color (optional)
   - Authorization: require current user to be project.creatorId (the admin)
   - Patch only provided fields
   - If name changes, also update linked channel name to `${newName} Discussion`

6. **remove mutation:**
   - Args: id
   - Authorization: require current user to be project.creatorId
   - Delete all projectMembers
   - Delete linked channel (use channels.remove pattern - delete messages, channelMembers first)
   - Delete project

Import: getAuthUserId, ConvexError, v, mutation, query, getAll, WorkspaceRole, ChannelRole
  </action>
  <verify>
    Run `npm run lint` - no errors
    Run `npx convex dev --once` - functions deploy successfully
  </verify>
  <done>
    convex/projects.ts exists with create, get, list, listByUserMembership, update, remove
    All mutations have proper authentication and authorization checks
    Authorization checks use creatorId field, not a role system
    Create mutation atomically creates project + membership + linked channel
  </done>
</task>

<task type="auto">
  <name>Task 3: Create projectMembers.ts with membership operations</name>
  <files>convex/projectMembers.ts</files>
  <action>
Create `convex/projectMembers.ts` following channelMembers.ts pattern:

1. **membersByProject query:**
   - Args: projectId
   - Returns: array of members with user info (name from users table) and isCreator boolean
   - Pattern: query projectMembers by_project, then fetch user details
   - Also fetch the project to check creatorId
   - Return member object with: _id, projectId, userId, name, isCreator (userId === project.creatorId)

2. **addToProject mutation:**
   - Args: userId, projectId
   - Auth check (must be authenticated)
   - Authorization: requesting user must be project.creatorId (the admin)
   - Check user not already member (by_project_user unique check)
   - Get project, increment memberCount
   - Insert projectMembers record (no role field)
   - ALSO add user to linked channel (sync membership):
     - Get project.linkedChannelId
     - Insert channelMembers for the user with role "member"
     - Update channel roleCount
   - Return membership id

3. **removeFromProject mutation:**
   - Args: userId, projectId
   - Authorization: requesting user must be project.creatorId
   - Cannot remove the creator (project.creatorId) - they must delete the project instead
   - Cannot remove yourself - members cannot remove themselves per CONTEXT.md
   - Get membership, decrement memberCount
   - Delete projectMembers record
   - ALSO remove from linked channel (sync membership):
     - Remove channelMembers record
     - Update channel roleCount

NOTE: No changeMemberRole mutation - per CONTEXT.md "No project-specific roles for v1 - just membership (access or no access)". The creator is the only "admin" and that's determined by creatorId field.

Import pattern from channelMembers.ts. Use proper validators for return types.
  </action>
  <verify>
    Run `npm run lint` - no errors
    Run `npx convex dev --once` - functions deploy
  </verify>
  <done>
    convex/projectMembers.ts exists with membersByProject, addToProject, removeFromProject
    NO changeMemberRole mutation (no role tiers in v1)
    Adding/removing project members also syncs to linked channel
    Cannot remove creator or yourself from project
    membersByProject returns isCreator flag for UI to determine who can manage
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint` passes with 0 errors
2. `npx convex dev --once` deploys all functions successfully
3. Schema includes projects and projectMembers tables with correct indexes
4. All exported functions visible in convex/_generated/api.d.ts
5. No ProjectRole enum exists - membership is binary (access or no access)
</verification>

<success_criteria>
- projects table has: name, description, color, workspaceId, linkedChannelId, creatorId, memberCount
- projectMembers table has: projectId, workspaceId, userId (NO role field) with all required indexes
- projects.create atomically creates project + membership + linked channel
- projects.listByUserMembership returns only projects user has access to, sorted alphabetically
- projectMembers operations sync membership to linked channel
- Authorization uses creatorId field, not a role system
- No changeMemberRole mutation exists
</success_criteria>

<output>
After completion, create `.planning/phases/01-projects-foundation/01-01-SUMMARY.md`
</output>
