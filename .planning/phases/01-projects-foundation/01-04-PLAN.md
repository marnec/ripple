---
phase: 01-projects-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/pages/App/Project/ProjectSettings.tsx
autonomous: false

must_haves:
  truths:
    - "Project admin can view settings page"
    - "Project admin can rename the project"
    - "Project admin can add workspace members to the project"
    - "Project admin can remove members from the project (except self)"
    - "Project admin can delete the project"
    - "Non-admin members cannot access settings or see management controls"
  artifacts:
    - path: "src/pages/App/Project/ProjectSettings.tsx"
      provides: "Project settings and membership management"
      min_lines: 100
  key_links:
    - from: "src/pages/App/Project/ProjectSettings.tsx"
      to: "api.projects.update"
      via: "useMutation for rename"
      pattern: "useMutation\\(api\\.projects\\.update"
    - from: "src/pages/App/Project/ProjectSettings.tsx"
      to: "api.projectMembers.addToProject"
      via: "useMutation for adding members"
      pattern: "useMutation\\(api\\.projectMembers\\.addToProject"
    - from: "src/pages/App/Project/ProjectSettings.tsx"
      to: "api.projectMembers.removeFromProject"
      via: "useMutation for removing members"
      pattern: "useMutation\\(api\\.projectMembers\\.removeFromProject"
---

<objective>
Implement the project settings page with membership management, rename, and delete functionality.

Purpose: Enable project admins to manage their projects - add/remove members, rename, and delete. This completes the full CRUD cycle for projects.

Output: Working settings page with all management features per PROJ-02 and PROJ-03 requirements.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-projects-foundation/01-CONTEXT.md
@.planning/phases/01-projects-foundation/01-01-SUMMARY.md
@.planning/phases/01-projects-foundation/01-02-SUMMARY.md

# Key reference files (existing patterns to follow)
@src/pages/App/Channel/ChannelSettings.tsx
@src/pages/App/Channel/ChannelMembershipSelection.tsx
@src/pages/App/Workspace/WorkspaceSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ProjectSettings with full management features</name>
  <files>src/pages/App/Project/ProjectSettings.tsx</files>
  <action>
Replace the placeholder ProjectSettings.tsx with full implementation:

```typescript
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { LoadingSpinner } from "@/components/ui/loading-spinner";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Separator } from "@/components/ui/separator";
import { useToast } from "@/components/ui/use-toast";
import SomethingWentWrong from "@/pages/SomethingWentWrong";
import { QueryParams } from "@shared/types/routes";
import { useMutation, useQuery } from "convex/react";
import { Trash2, UserMinus, UserPlus } from "lucide-react";
import { useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { api } from "../../../../convex/_generated/api";
import { Id } from "../../../../convex/_generated/dataModel";

const PROJECT_COLORS = [
  { name: "Blue", class: "bg-blue-500" },
  { name: "Green", class: "bg-green-500" },
  { name: "Yellow", class: "bg-yellow-500" },
  { name: "Red", class: "bg-red-500" },
  { name: "Purple", class: "bg-purple-500" },
  { name: "Pink", class: "bg-pink-500" },
  { name: "Orange", class: "bg-orange-500" },
  { name: "Teal", class: "bg-teal-500" },
];

export function ProjectSettings() {
  const { workspaceId, projectId } = useParams<QueryParams>();

  if (!workspaceId || !projectId) {
    return <SomethingWentWrong />;
  }

  return (
    <ProjectSettingsContent
      workspaceId={workspaceId as Id<"workspaces">}
      projectId={projectId as Id<"projects">}
    />
  );
}

function ProjectSettingsContent({
  workspaceId,
  projectId,
}: {
  workspaceId: Id<"workspaces">;
  projectId: Id<"projects">;
}) {
  const navigate = useNavigate();
  const { toast } = useToast();

  // Queries
  const project = useQuery(api.projects.get, { id: projectId });
  const projectMembers = useQuery(api.projectMembers.membersByProject, { projectId });
  const workspaceMembers = useQuery(api.workspaceMembers.membersByWorkspace, { workspaceId });

  // Mutations
  const updateProject = useMutation(api.projects.update);
  const deleteProject = useMutation(api.projects.remove);
  const addMember = useMutation(api.projectMembers.addToProject);
  const removeMember = useMutation(api.projectMembers.removeFromProject);

  // Local state
  const [projectName, setProjectName] = useState<string | null>(null);
  const [selectedColor, setSelectedColor] = useState<string | null>(null);
  const [selectedUserId, setSelectedUserId] = useState<string>("");

  if (project === undefined || projectMembers === undefined || workspaceMembers === undefined) {
    return (
      <div className="flex items-center justify-center h-full">
        <LoadingSpinner />
      </div>
    );
  }

  if (project === null) {
    return <SomethingWentWrong />;
  }

  const displayName = projectName ?? project.name;
  const displayColor = selectedColor ?? project.color;

  // Find workspace members not in project (for add dropdown)
  const projectMemberIds = new Set(projectMembers.map((m) => m.userId));
  const availableMembers = workspaceMembers.filter((m) => !projectMemberIds.has(m.userId));

  const handleSaveDetails = async () => {
    try {
      await updateProject({
        id: projectId,
        ...(projectName !== null && { name: projectName }),
        ...(selectedColor !== null && { color: selectedColor }),
      });
      toast({ title: "Project updated" });
      setProjectName(null);
      setSelectedColor(null);
    } catch (error) {
      toast({
        title: "Error updating project",
        description: error instanceof Error ? error.message : "Please try again",
        variant: "destructive",
      });
    }
  };

  const handleAddMember = async () => {
    if (!selectedUserId) return;
    try {
      await addMember({
        userId: selectedUserId as Id<"users">,
        projectId,
      });
      toast({ title: "Member added" });
      setSelectedUserId("");
    } catch (error) {
      toast({
        title: "Error adding member",
        description: error instanceof Error ? error.message : "Please try again",
        variant: "destructive",
      });
    }
  };

  const handleRemoveMember = async (userId: Id<"users">) => {
    try {
      await removeMember({ userId, projectId });
      toast({ title: "Member removed" });
    } catch (error) {
      toast({
        title: "Error removing member",
        description: error instanceof Error ? error.message : "Please try again",
        variant: "destructive",
      });
    }
  };

  const handleDeleteProject = async () => {
    if (!confirm("Are you sure you want to delete this project? This cannot be undone.")) {
      return;
    }
    try {
      await deleteProject({ id: projectId });
      toast({ title: "Project deleted" });
      navigate(`/workspaces/${workspaceId}/projects`);
    } catch (error) {
      toast({
        title: "Error deleting project",
        description: error instanceof Error ? error.message : "Please try again",
        variant: "destructive",
      });
    }
  };

  const hasChanges = projectName !== null || selectedColor !== null;

  return (
    <div className="container mx-auto py-6 max-w-2xl">
      <h1 className="text-2xl font-bold mb-6">Project Settings</h1>

      {/* Project Details Section */}
      <section className="mb-8">
        <h2 className="text-lg font-semibold mb-4">Details</h2>
        <div className="space-y-4">
          <div>
            <Label htmlFor="project-name">Project Name</Label>
            <Input
              id="project-name"
              value={displayName}
              onChange={(e) => setProjectName(e.target.value)}
              placeholder="Enter project name"
            />
          </div>
          <div>
            <Label>Color</Label>
            <div className="flex flex-wrap gap-2 mt-2">
              {PROJECT_COLORS.map((color) => (
                <button
                  key={color.class}
                  type="button"
                  onClick={() => setSelectedColor(color.class)}
                  className={`w-8 h-8 rounded-full ${color.class} ${
                    displayColor === color.class
                      ? "ring-2 ring-offset-2 ring-primary"
                      : ""
                  }`}
                  title={color.name}
                />
              ))}
            </div>
          </div>
          {hasChanges && (
            <Button onClick={handleSaveDetails}>Save Changes</Button>
          )}
        </div>
      </section>

      <Separator className="my-6" />

      {/* Members Section */}
      <section className="mb-8">
        <h2 className="text-lg font-semibold mb-4">Members</h2>

        {/* Add Member */}
        {availableMembers.length > 0 && (
          <div className="flex gap-2 mb-4">
            <Select value={selectedUserId} onValueChange={setSelectedUserId}>
              <SelectTrigger className="flex-1">
                <SelectValue placeholder="Select a member to add" />
              </SelectTrigger>
              <SelectContent>
                {availableMembers.map((member) => (
                  <SelectItem key={member.userId} value={member.userId}>
                    {member.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Button onClick={handleAddMember} disabled={!selectedUserId}>
              <UserPlus className="w-4 h-4 mr-2" />
              Add
            </Button>
          </div>
        )}

        {/* Member List */}
        <div className="space-y-2">
          {projectMembers.map((member) => (
            <div
              key={member._id}
              className="flex items-center justify-between p-3 rounded-lg border"
            >
              <div>
                <span className="font-medium">{member.name}</span>
                <span className="ml-2 text-xs text-muted-foreground">
                  {member.role}
                </span>
              </div>
              {/* Cannot remove self - per CONTEXT.md */}
              {member.role !== "admin" && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemoveMember(member.userId)}
                >
                  <UserMinus className="w-4 h-4" />
                </Button>
              )}
            </div>
          ))}
        </div>
      </section>

      <Separator className="my-6" />

      {/* Danger Zone */}
      <section>
        <h2 className="text-lg font-semibold mb-4 text-destructive">Danger Zone</h2>
        <Button variant="destructive" onClick={handleDeleteProject}>
          <Trash2 className="w-4 h-4 mr-2" />
          Delete Project
        </Button>
        <p className="text-sm text-muted-foreground mt-2">
          This will permanently delete the project and its linked discussion channel.
        </p>
      </section>
    </div>
  );
}
```

Key points:
- Displays project name and color with edit capability
- Shows member list with role badges
- Add member via dropdown (only shows workspace members not already in project)
- Remove member button (hidden for admins - cannot remove self or demote last admin handled in backend)
- Delete project with confirmation
- All mutations use proper error handling with toast
- Note: Authorization (only admins can access) is enforced by backend mutations. UI shows controls regardless but mutations will fail if not admin.
  </action>
  <verify>
    Run `npm run lint` - no errors
    Navigate to /workspaces/{id}/projects/{projectId}/settings - should show settings page
    Test: rename project, change color, add/remove member, delete project
  </verify>
  <done>
    ProjectSettings.tsx has working name/color editing
    Member list displays with add/remove functionality
    Delete button with confirmation deletes project and navigates away
    All actions provide feedback via toast notifications
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Projects Foundation feature:
- Backend: projects and projectMembers tables with CRUD operations
- Sidebar: Projects section with list and create button
- Create dialog: name + color picker
- Project details: shows project info with empty state for tasks
- Settings: rename, add/remove members, delete project
- Auto-created channel: each project gets a linked discussion channel
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`

2. **Create a project:**
   - In sidebar, click the + button in "Projects" section
   - Enter a name (e.g., "Test Project") and select a color
   - Click "Create Project"
   - Expected: Toast shows success, navigates to project details page

3. **Verify project details:**
   - Project name and color dot display at top
   - Empty state shows "No tasks yet" message

4. **Verify sidebar:**
   - New project appears in Projects section
   - Shows color dot and name
   - Sorted alphabetically if multiple projects

5. **Verify linked channel:**
   - Check Channels section in sidebar
   - Expected: New private channel named "{ProjectName} Discussion" appears

6. **Test settings page:**
   - Click dropdown on project in sidebar > "Settings"
   - Or navigate to /workspaces/{id}/projects/{projectId}/settings
   - Change project name and click Save
   - Add a workspace member to the project (if you have multiple users)
   - Remove a member (not yourself)
   - Expected: All operations show toast and update immediately

7. **Test delete:**
   - In settings, click "Delete Project"
   - Confirm deletion
   - Expected: Project removed from sidebar, navigates to /projects

8. **Verify authorization:**
   - Only workspace admins should be able to create projects
   - (If testing with non-admin user: create button should work but mutation should fail)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and human verification passes:
1. All PROJ-* requirements from Phase 1 are satisfied
2. Full create/read/update/delete flow works for projects
3. Membership management works correctly
4. Linked channel is created automatically
5. Authorization enforced (only workspace admins create, only project admins manage)
</verification>

<success_criteria>
Requirements verification:
- PROJ-01: User can create a project within a workspace (via sidebar dialog)
- PROJ-02: User can rename and delete projects they administer (via settings page)
- PROJ-03: Project has membership with access control (projectMembers table, settings page management)
- PROJ-04: Creating a project auto-creates a dedicated channel (create mutation does this atomically)
- PROJ-05: User can view list of projects they have access to (sidebar shows filtered list)
</success_criteria>

<output>
After completion, create `.planning/phases/01-projects-foundation/01-04-SUMMARY.md`
</output>
