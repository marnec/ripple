---
phase: 06-task-comments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/taskComments.ts
  - src/pages/App/Project/TaskComments.tsx
  - src/pages/App/Project/TaskDetailSheet.tsx
  - src/pages/App/Project/TaskDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can add a comment to a task they have project membership for"
    - "Comments display in chronological order (oldest first) below task description"
    - "User can edit their own comments inline"
    - "User can soft-delete their own comments"
    - "Comments update in real-time for all viewers via Convex reactivity"
  artifacts:
    - path: "convex/schema.ts"
      provides: "taskComments table definition with indexes"
      contains: "taskComments"
    - path: "convex/taskComments.ts"
      provides: "CRUD operations for task comments"
      exports: ["list", "create", "update", "remove"]
    - path: "src/pages/App/Project/TaskComments.tsx"
      provides: "Comment list display and comment input UI"
      min_lines: 80
  key_links:
    - from: "src/pages/App/Project/TaskComments.tsx"
      to: "convex/taskComments.ts"
      via: "useQuery(api.taskComments.list) and useMutation(api.taskComments.create/update/remove)"
      pattern: "api\\.taskComments\\."
    - from: "src/pages/App/Project/TaskDetailSheet.tsx"
      to: "src/pages/App/Project/TaskComments.tsx"
      via: "imports and renders TaskComments component"
      pattern: "TaskComments"
    - from: "src/pages/App/Project/TaskDetailPage.tsx"
      to: "src/pages/App/Project/TaskComments.tsx"
      via: "imports and renders TaskComments component"
      pattern: "TaskComments"
    - from: "convex/taskComments.ts"
      to: "convex/schema.ts"
      via: "projectMembers.by_project_user index for permission checks"
      pattern: "by_project_user"
---

<objective>
Add threaded task comments so users can discuss tasks within the task detail view.

Purpose: Task comments are essential for team collaboration - allowing discussion, questions, and updates directly on tasks rather than requiring separate chat channels.
Output: Backend taskComments table with CRUD, frontend comment list + input component integrated into both TaskDetailSheet and TaskDetailPage.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-task-comments/06-RESEARCH.md
@convex/schema.ts
@convex/messages.ts
@convex/tasks.ts
@src/pages/App/Project/TaskDetailSheet.tsx
@src/pages/App/Project/TaskDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend - taskComments schema and CRUD operations</name>
  <files>convex/schema.ts, convex/taskComments.ts</files>
  <action>
1. In `convex/schema.ts`, add a `taskComments` table definition after the `tasks` table:
   ```
   taskComments: defineTable({
     taskId: v.id("tasks"),
     userId: v.id("users"),
     body: v.string(),
     deleted: v.boolean(),
   })
     .index("by_task", ["taskId"])
     .index("undeleted_by_task", ["taskId", "deleted"]),
   ```

2. Create `convex/taskComments.ts` with four functions following the exact patterns from `convex/messages.ts`:

   **`list` query:** Takes `taskId`. Auth check via `getAuthUserId`. Get task, then check project membership via `projectMembers.by_project_user` index. Query comments using `undeleted_by_task` index with `deleted: false`, order `"asc"` (chronological). Batch fetch authors using `getAll()` from `convex-helpers/server/relationships`. Return array of comments enriched with `author: string` (name or email or "Unknown") and `image: string | undefined` (user avatar). Use `v.any()` for the return validator to handle the enriched type.

   **`create` mutation:** Takes `taskId: v.id("tasks")` and `body: v.string()`. Auth check. Get task, check project membership. Insert with `deleted: false`. Return `v.id("taskComments")`.

   **`update` mutation:** Takes `id: v.id("taskComments")` and `body: v.string()`. Auth check. Get comment (throw if not found). Author-only check: `comment.userId !== userId` throws "Not authorized". Patch body with trimmed value. Return `v.null()`.

   **`remove` mutation:** Takes `id: v.id("taskComments")`. Auth check. Get comment (throw if not found). Author-only check. Soft delete: `ctx.db.patch(id, { deleted: true })`. Return `v.null()`.

   All mutations and queries must use the new function syntax with explicit `args:` and `returns:` validators per CLAUDE.md conventions.
  </action>
  <verify>Run `npm run lint` to confirm schema and function files have no TypeScript errors. Run `npx convex dev --once` or verify that the Convex dev server picks up the schema change without errors.</verify>
  <done>taskComments table exists in schema with both indexes. All four CRUD functions (list, create, update, remove) are exported from convex/taskComments.ts with proper permission checks and return validators.</done>
</task>

<task type="auto">
  <name>Task 2: Frontend - TaskComments component and integration</name>
  <files>src/pages/App/Project/TaskComments.tsx, src/pages/App/Project/TaskDetailSheet.tsx, src/pages/App/Project/TaskDetailPage.tsx</files>
  <action>
1. Create `src/pages/App/Project/TaskComments.tsx` with a single `TaskComments` component that takes `taskId: Id<"tasks">` and `currentUserId: Id<"users">` as props:

   **Data fetching:**
   - `useQuery(api.taskComments.list, { taskId })` for the comment list
   - `useMutation(api.taskComments.create)` for adding
   - `useMutation(api.taskComments.update)` for editing
   - `useMutation(api.taskComments.remove)` for deleting

   **Comment input section (top or bottom of comments):**
   - Use shadcn `Textarea` component (import from `@/components/ui/textarea`) for the input. If Textarea component does not exist, use a plain HTML `<textarea>` with Tailwind classes matching the codebase style (`border rounded-md p-2 text-sm w-full resize-none`).
   - "Comment" `Button` that submits. Disabled when body is empty.
   - Ctrl+Enter keyboard shortcut to submit.
   - Clear input after successful submit.
   - Place the input at the bottom of the comment section (below existing comments).

   **Comment list:**
   - Map over comments in chronological order (already sorted by query).
   - Each comment shows: Avatar (AvatarFallback with first 2 chars of author name, AvatarImage if image available), author name (font-medium text-sm), timestamp (`new Date(comment._creationTime).toLocaleString()`), and comment body (text-sm whitespace-pre-wrap).
   - Layout: flex gap-3 for avatar + content side by side.

   **Author actions (only when `comment.userId === currentUserId`):**
   - Show small "Edit" and "Delete" buttons (variant="ghost", size="sm") below the comment body, using Pencil and Trash2 icons from lucide-react.
   - **Edit mode:** When "Edit" clicked, replace the body text with a textarea pre-filled with current body. Show "Save" and "Cancel" buttons. Save calls `update` mutation. Cancel reverts to display mode.
   - **Delete:** Calls `remove` mutation directly (no confirmation dialog needed for comments - soft delete is reversible server-side).

   **Empty state:** When no comments exist, show "No comments yet" in muted text.

   **Loading state:** Guard with `if (comments === undefined) return <LoadingSpinner />`.

   **Section header:** Use `<h3 className="text-sm font-semibold text-muted-foreground">Comments</h3>` to match the "Properties" and "Description" section headers in the task detail views.

2. In `TaskDetailSheet.tsx`:
   - Import `TaskComments` from `./TaskComments`.
   - Get the current user: `const currentUser = useQuery(api.users.viewer);`
   - Add the comments section AFTER the Description section (inside the `<div className="mt-6 space-y-6">` container). Wrap in a `<div className="space-y-2">` to match the Description section spacing.
   - Pass `taskId={taskId}` and `currentUserId={currentUser._id}` (guard with currentUser check before rendering).

3. In `TaskDetailPage.tsx`:
   - Import `TaskComments` from `./TaskComments`.
   - Get the current user: `const currentUser = useQuery(api.users.viewer);`
   - Add the comments section AFTER the Description section (inside the `<div className="space-y-8">` container). Wrap in a `<div className="space-y-2">` to match section spacing.
   - Pass `taskId={taskId}` and `currentUserId={currentUser._id}` (guard with currentUser check before rendering).
  </action>
  <verify>Run `npm run lint` to confirm no TypeScript or ESLint errors. Run `npm run build` to verify production build succeeds. Visually confirm (if dev server running) that the comments section appears below the description in both the task detail sheet and full page views.</verify>
  <done>TaskComments component renders below task description in both TaskDetailSheet and TaskDetailPage. Users can add comments via textarea + submit button, see comments chronologically with author avatars and timestamps, edit their own comments inline, and delete their own comments. Non-authors see no edit/delete controls.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors and 0 warnings
2. `npm run build` succeeds
3. Convex schema deploys without errors (taskComments table created with indexes)
4. All four taskComments functions exported: list, create, update, remove
5. Comments section visible in both TaskDetailSheet and TaskDetailPage below description
</verification>

<success_criteria>
- A project member can open a task, type a comment, and submit it
- The comment appears immediately in the chronological list with author name and timestamp
- The comment author sees Edit and Delete buttons on their own comments
- Clicking Edit opens inline textarea; Save persists the change; Cancel reverts
- Clicking Delete soft-removes the comment from the list
- Non-authors do not see Edit/Delete buttons on other users' comments
- Comments section renders in both the side sheet and full page task detail views
</success_criteria>

<output>
After completion, create `.planning/phases/06-task-comments/06-01-SUMMARY.md`
</output>
