---
phase: 11-partykit-infrastructure-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - partykit.json
  - partykit/server.ts
  - partykit/tsconfig.json
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "PartyKit dev server starts on port 1999 via npm run dev"
    - "PartyKit server handles Yjs WebSocket sync with snapshot mode persistence"
    - "Yjs document state survives PartyKit server restart (Durable Objects storage)"
    - "Snapshot compaction runs automatically when last client disconnects"
  artifacts:
    - path: "partykit/server.ts"
      provides: "PartyKit Yjs server with snapshot mode persistence"
      min_lines: 15
    - path: "partykit.json"
      provides: "PartyKit configuration (port 1999, snapshot persist, env vars)"
      contains: "ripple-collaboration"
    - path: "partykit/tsconfig.json"
      provides: "TypeScript config for PartyKit server code"
    - path: "package.json"
      provides: "Updated scripts (dev:partykit, deploy:partykit) and new dependencies"
      contains: "dev:partykit"
  key_links:
    - from: "package.json"
      to: "partykit.json"
      via: "dev:partykit script runs partykit dev which reads partykit.json"
      pattern: "partykit dev"
    - from: "partykit.json"
      to: "partykit/server.ts"
      via: "main field points to server entry"
      pattern: "partykit/server.ts"
---

<objective>
Set up PartyKit server with Yjs persistence and integrate into the monorepo development workflow.

Purpose: Establish the WebSocket infrastructure (INFRA-01, INFRA-03, INFRA-04) that Phase 12 and 13 build on. PartyKit provides Cloudflare Durable Objects-backed rooms with automatic Yjs snapshot persistence and compaction.

Output: Working PartyKit server that starts alongside Vite + Convex via `npm run dev`, with Yjs snapshot mode persistence configured.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-partykit-infrastructure-persistence/11-CONTEXT.md
@.planning/phases/11-partykit-infrastructure-persistence/11-RESEARCH.md
@package.json
@partykit.json (will be created)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PartyKit dependencies and configure project</name>
  <files>package.json, partykit.json, partykit/tsconfig.json, .gitignore</files>
  <action>
1. Install dependencies:
   ```bash
   npm install -D partykit@0.0.115
   npm install yjs@13.6.29 y-partykit@0.0.33
   ```

2. Create `partykit.json` at project root:
   ```json
   {
     "name": "ripple-collaboration",
     "main": "partykit/server.ts",
     "port": 1999,
     "persist": ".partykit/state",
     "compatibilityDate": "2026-02-11",
     "define": {
       "CONVEX_SITE_URL": "env:CONVEX_SITE_URL"
     }
   }
   ```
   Note: `persist` enables local filesystem persistence for dev. In production, Durable Objects handle persistence automatically.

3. Create `partykit/tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "ES2022",
       "moduleResolution": "bundler",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "outDir": "./dist",
       "rootDir": ".",
       "lib": ["ES2022"]
     },
     "include": ["./**/*.ts"]
   }
   ```

4. Update `package.json` scripts:
   - Change `"dev"` to: `"npm-run-all --parallel dev:frontend dev:backend dev:partykit"`
   - Add `"dev:partykit": "partykit dev"`
   - Add `"deploy:partykit": "partykit deploy"`
   - Update `"deploy"` to: `"npm run build && npx convex deploy && partykit deploy && wrangler deploy"`

5. Add `.partykit/` to `.gitignore` (local dev persistence state should not be committed).
  </action>
  <verify>
Run `npm run dev:partykit` and confirm PartyKit dev server starts on port 1999 without errors. Check that `partykit.json` is valid JSON. Verify `npm ls partykit yjs y-partykit` shows correct versions installed.
  </verify>
  <done>
partykit, yjs, and y-partykit installed at specified versions. partykit.json configures project with snapshot persist. Dev and deploy scripts updated. PartyKit dev server starts cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PartyKit Yjs server with snapshot mode persistence</name>
  <files>partykit/server.ts</files>
  <action>
Create `partykit/server.ts` as the main PartyKit server entry point. This server extends `YPartyKitServer` from y-partykit to provide:

1. Yjs document sync over WebSocket (automatic via YPartyKitServer base class)
2. Snapshot mode persistence via Durable Objects (auto-compacts when last client disconnects)
3. Room isolation (each document/diagram gets its own Durable Object instance, keyed by room ID)

Implementation:
```typescript
import type { Party } from "partyserver";
import { YPartyKitServer } from "y-partykit/server";

export default class CollaborationServer extends YPartyKitServer {
  // YPartyKitServer handles:
  // - Yjs document sync (onConnect, onMessage, onDisconnect)
  // - Snapshot mode persistence (auto-compact on last client disconnect)
  // - Durable Objects storage (state persists across server restarts)
  //
  // Room ID format: "doc-{documentId}" or "diagram-{diagramId}"
  // Each room is an isolated Durable Object with its own Yjs document.
  //
  // Auth will be added in Plan 02 via onBeforeConnect static handler.
}
```

Keep the server minimal for now. Auth (onBeforeConnect) is added in Plan 02. The YPartyKitServer base class handles all Yjs sync, persistence, and compaction automatically in snapshot mode (which is the default).

Do NOT add a custom constructor unless needed. YPartyKitServer's defaults use snapshot mode persistence out of the box. The `persist` field in `partykit.json` enables local dev persistence; in production, Durable Objects storage is automatic.
  </action>
  <verify>
1. Run `npm run dev` and confirm all 3 servers start (Vite, Convex, PartyKit).
2. Check PartyKit server logs show startup on port 1999.
3. Verify no TypeScript errors: `npx tsc --noEmit -p partykit/tsconfig.json`
  </verify>
  <done>
PartyKit Yjs server runs with snapshot mode persistence. `npm run dev` starts all three services in parallel. Server accepts WebSocket connections and syncs Yjs documents with automatic compaction.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts Vite + Convex + PartyKit (3 parallel processes)
2. PartyKit dev server accessible at ws://localhost:1999
3. `npm ls partykit yjs y-partykit` shows correct versions
4. No TypeScript errors in partykit/ directory
5. `.partykit/` directory in .gitignore
</verification>

<success_criteria>
PartyKit server runs locally with Yjs snapshot mode persistence. Development workflow supports all three services via single `npm run dev` command. Deploy script includes PartyKit deployment step.
</success_criteria>

<output>
After completion, create `.planning/phases/11-partykit-infrastructure-persistence/11-01-SUMMARY.md`
</output>
