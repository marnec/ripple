---
phase: 13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks
plan: 02
type: execute
wave: 2
depends_on: ["13.2-01"]
files_modified:
  - src/pages/App/Project/useTaskDetail.ts
  - src/pages/App/Project/TaskDescriptionEditor.tsx
  - src/pages/App/Project/TaskDetailSheet.tsx
  - src/pages/App/Project/TaskDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Multiple users can collaboratively edit a task description in real-time with live cursors"
    - "Task descriptions sync via Yjs/PartyKit (no more 500ms debounced save to Convex)"
    - "ActiveUsers avatars and ConnectionStatus indicator appear in both TaskDetailSheet and TaskDetailPage"
    - "Existing task descriptions stored in Convex are migrated to Yjs on first editor load"
    - "Task description editor works correctly for tasks with no existing description"
  artifacts:
    - path: "src/pages/App/Project/useTaskDetail.ts"
      provides: "Collaborative task editing hook using useDocumentCollaboration with resourceType task"
      contains: "useDocumentCollaboration"
    - path: "src/pages/App/Project/TaskDescriptionEditor.tsx"
      provides: "Editor component without onChange prop (Yjs handles sync)"
    - path: "src/pages/App/Project/TaskDetailSheet.tsx"
      provides: "Sheet with ActiveUsers and ConnectionStatus collaboration UI"
      contains: "ActiveUsers"
    - path: "src/pages/App/Project/TaskDetailPage.tsx"
      provides: "Full-page view with ActiveUsers and ConnectionStatus collaboration UI"
      contains: "ActiveUsers"
  key_links:
    - from: "src/pages/App/Project/useTaskDetail.ts"
      to: "src/hooks/use-document-collaboration.ts"
      via: "useDocumentCollaboration with resourceType task"
      pattern: "useDocumentCollaboration.*resourceType.*task"
    - from: "src/pages/App/Project/TaskDetailSheet.tsx"
      to: "src/pages/App/Document/ActiveUsers.tsx"
      via: "ActiveUsers component import"
      pattern: "import.*ActiveUsers"
    - from: "src/pages/App/Project/TaskDetailSheet.tsx"
      to: "src/pages/App/Document/ConnectionStatus.tsx"
      via: "ConnectionStatus component import"
      pattern: "import.*ConnectionStatus"
    - from: "src/pages/App/Project/useTaskDetail.ts"
      to: "convex/tasks.ts"
      via: "clearDescription mutation for migration"
      pattern: "api\\.tasks\\.clearDescription"
---

<objective>
Integrate collaborative Yjs-based editing into task descriptions, replacing the local BlockNote editor and debounced auto-save.

Purpose: Task descriptions become real-time collaborative with live cursors, matching the collaboration experience in documents (Phase 12). Removes the 500ms debounced save-to-Convex pattern and replaces it with Yjs automatic sync. Adds collaboration UI (ActiveUsers, ConnectionStatus) to both the sheet and full-page task views.

Output: Fully collaborative task description editing with migration from Convex-stored descriptions to Yjs.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks/13.2-01-SUMMARY.md
@src/pages/App/Project/useTaskDetail.ts
@src/pages/App/Project/TaskDescriptionEditor.tsx
@src/pages/App/Project/TaskDetailSheet.tsx
@src/pages/App/Project/TaskDetailPage.tsx
@src/pages/App/Document/DocumentEditor.tsx
@src/pages/App/Document/ActiveUsers.tsx
@src/pages/App/Document/ConnectionStatus.tsx
@src/hooks/use-document-collaboration.ts
@src/hooks/use-cursor-awareness.ts
@src/lib/user-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite useTaskDetail for collaborative editing and update TaskDescriptionEditor</name>
  <files>src/pages/App/Project/useTaskDetail.ts, src/pages/App/Project/TaskDescriptionEditor.tsx</files>
  <action>
**useTaskDetail.ts - Major rewrite:**

1. Remove these imports that are no longer needed: `useCreateBlockNote` from `@blocknote/react`.
2. Add new imports:
   - `useDocumentCollaboration` from `../../../hooks/use-document-collaboration`
   - `useMutation` is already imported
   - `useCursorAwareness` from `../../../hooks/use-cursor-awareness`
   - `getUserColor` from `../../../lib/user-colors`
   - `taskDescriptionSchema` stays (already imported)

3. Remove all debounced description save logic:
   - Delete `descriptionTimeoutRef` ref
   - Delete `loadedTaskIdRef` ref
   - Delete `suppressOnChangeRef` ref
   - Delete the `useCreateBlockNote` call (`const editor = useCreateBlockNote(...)`)
   - Delete the useEffect that loads description into editor (the one with `loadedTaskIdRef`)
   - Delete `handleDescriptionChange` function entirely
   - Delete `resetEditor` function entirely (no longer needed - Yjs handles cleanup)

4. Replace with collaborative editor setup. After the existing query hooks and before the handler functions, add:
   ```typescript
   // Collaborative editor - Yjs handles sync automatically
   const { editor, isLoading: editorLoading, isConnected, provider, yDoc } = useDocumentCollaboration({
     documentId: taskId ?? "",
     userName: currentUser?.name ?? "Anonymous",
     userId: currentUser?._id ?? "anonymous",
     schema: taskDescriptionSchema,
     resourceType: "task",
   });

   const { remoteUsers } = useCursorAwareness(provider?.awareness ?? null);

   const clearDescription = useMutation(api.tasks.clearDescription);
   ```

5. Add client-side migration effect. This migrates existing Convex description content to Yjs on first load. Place it after the collaborative editor setup:
   ```typescript
   // One-time migration: Convex description -> Yjs
   const migrationDoneRef = useRef(false);
   useEffect(() => {
     if (!editor || !provider || !task || !taskId || migrationDoneRef.current) return;
     if (!isConnected) return; // Wait for provider to connect

     // Check if Yjs document is empty (no content yet)
     const doc = editor.document;
     const isEmpty = doc.length === 0 ||
       (doc.length === 1 && doc[0].type === "paragraph" &&
        (!doc[0].content || (Array.isArray(doc[0].content) && doc[0].content.length === 0)));

     // If Yjs empty AND Convex has description, migrate
     if (isEmpty && task.description) {
       migrationDoneRef.current = true;
       try {
         const blocks = JSON.parse(task.description);
         editor.replaceBlocks(editor.document, blocks);
         // Clear Convex description to mark as migrated
         void clearDescription({ taskId });
       } catch (err) {
         console.error("Task description migration failed:", err);
       }
     } else {
       // No migration needed (either Yjs has content or no Convex description)
       migrationDoneRef.current = true;
     }
   }, [editor, provider, isConnected, task, taskId, clearDescription]);
   ```

6. Update return object:
   - Remove: `handleDescriptionChange`, `resetEditor`
   - Add: `isConnected`, `provider`, `remoteUsers`, `editorLoading`
   - `editor` is now from useDocumentCollaboration (may be null while loading)

**TaskDescriptionEditor.tsx - Remove onChange:**

1. Remove `onChange` from the `TaskDescriptionEditorProps` type definition.
2. Remove `onChange` from the destructured props.
3. Remove `onChange={onChange}` from the `<BlockNoteView>` component.
4. Add null check for editor: if `editor` is null/undefined, return a loading placeholder (a div with "Loading editor..." or similar).

The updated type:
```typescript
type TaskDescriptionEditorProps = {
  editor: any;
  documents?: Array<{ _id: string; name: string }>;
  diagrams?: Array<{ _id: string; name: string }>;
  members?: Array<{ userId: string; name?: string | null; image?: string }>;
  className?: string;
};
```

And the destructuring:
```typescript
export function TaskDescriptionEditor({
  editor,
  documents,
  diagrams,
  members,
  className,
}: TaskDescriptionEditorProps) {
```

Add early return if no editor:
```typescript
if (!editor) {
  return (
    <div className="space-y-2">
      <h3 className="text-sm font-semibold text-muted-foreground">Description</h3>
      <div className={cn("task-description-editor border rounded-md p-4 animate-pulse", className)}>
        <div className="h-6 bg-muted rounded w-3/4" />
      </div>
    </div>
  );
}
```

Run `npm run lint` to verify.
  </action>
  <verify>Run `npm run lint` passes with 0 errors and 0 warnings.</verify>
  <done>useTaskDetail uses Yjs collaborative editing via useDocumentCollaboration with resourceType "task". All debounced auto-save logic removed. Client-side migration from Convex description to Yjs implemented. TaskDescriptionEditor no longer requires onChange prop.</done>
</task>

<task type="auto">
  <name>Task 2: Add collaboration UI to TaskDetailSheet and TaskDetailPage</name>
  <files>src/pages/App/Project/TaskDetailSheet.tsx, src/pages/App/Project/TaskDetailPage.tsx</files>
  <action>
**TaskDetailSheet.tsx:**

1. Add imports:
   ```typescript
   import { ActiveUsers } from "../../Document/ActiveUsers";
   import { ConnectionStatus } from "../../Document/ConnectionStatus";
   import { getUserColor } from "../../../../lib/user-colors";
   ```
   Note: path from Project/ to Document/ is `../../Document/` and to lib/ is `../../../../lib/` (verify actual relative paths based on file location at `src/pages/App/Project/TaskDetailSheet.tsx`; Document components are at `src/pages/App/Document/`).

2. Update the destructured return from `useTaskDetail` to include the new fields:
   ```typescript
   const { titleInputRef, ...detail } = useTaskDetail({ taskId, workspaceId, projectId });
   ```
   The spread `detail` already captures everything. The new fields (`isConnected`, `provider`, `remoteUsers`, `editorLoading`) are available via `detail.*`.

3. Remove the `useEffect` that calls `detail.resetEditor()` on sheet close (resetEditor no longer exists). The Yjs provider cleanup is handled by useDocumentCollaboration's own cleanup effect when taskId changes.

4. Add loading state for editor: after the existing loading check for statuses/members, add a check for `detail.editorLoading`:
   ```typescript
   if (detail.editorLoading || !detail.editor) {
     // Show loading state (can merge with existing loading check)
   }
   ```
   OR simply let the TaskDescriptionEditor handle null editor (it already has a loading placeholder from Task 1).

5. Add collaboration UI. Inside the SheetContent, after the existing expand button and before the SheetHeader, add:
   ```typescript
   <div className="absolute right-14 top-4 flex items-center gap-2" style={{ zIndex: 10 }}>
     <ConnectionStatus isConnected={detail.isConnected} provider={detail.provider} />
     <ActiveUsers
       remoteUsers={detail.remoteUsers}
       currentUser={
         detail.currentUser
           ? {
               name: detail.currentUser.name,
               color: getUserColor(detail.currentUser._id),
             }
           : undefined
       }
     />
   </div>
   ```
   Position it to the left of the existing expand/close buttons (right-14 puts it next to the Maximize2 button at right-12).

6. Remove `onChange={detail.handleDescriptionChange}` from `<TaskDescriptionEditor>` (handleDescriptionChange no longer exists).

**TaskDetailPage.tsx:**

1. Add imports:
   ```typescript
   import { ActiveUsers } from "../../Document/ActiveUsers";
   import { ConnectionStatus } from "../../Document/ConnectionStatus";
   import { getUserColor } from "../../../../lib/user-colors";
   ```

2. In `TaskDetailPageContent`, the `useTaskDetail` already returns all new fields via the spread.

3. Add collaboration UI in the header area. After the existing header div (with back button and title), add:
   ```typescript
   {/* Collaboration indicators */}
   <div className="flex items-center gap-3 mb-6">
     <ConnectionStatus isConnected={detail.isConnected} provider={detail.provider} />
     <ActiveUsers
       remoteUsers={detail.remoteUsers}
       currentUser={
         detail.currentUser
           ? {
               name: detail.currentUser.name,
               color: getUserColor(detail.currentUser._id),
             }
           : undefined
       }
     />
   </div>
   ```

4. Remove `onChange={detail.handleDescriptionChange}` from `<TaskDescriptionEditor>`.

Run `npm run lint` to verify.
  </action>
  <verify>Run `npm run lint` passes with 0 errors and 0 warnings. Run `npm run build` to verify production build succeeds.</verify>
  <done>Both TaskDetailSheet and TaskDetailPage show ActiveUsers avatars and ConnectionStatus indicator. TaskDescriptionEditor no longer receives onChange. Collaboration UI is visually consistent with DocumentEditor's collaboration indicators.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 errors
2. `npm run build` succeeds
3. Grep confirms: No `handleDescriptionChange` or `descriptionTimeoutRef` in useTaskDetail.ts
4. Grep confirms: `useDocumentCollaboration` imported in useTaskDetail.ts
5. Grep confirms: `resourceType: "task"` in useTaskDetail.ts
6. Grep confirms: `ActiveUsers` imported in both TaskDetailSheet.tsx and TaskDetailPage.tsx
7. Grep confirms: `ConnectionStatus` imported in both TaskDetailSheet.tsx and TaskDetailPage.tsx
8. Grep confirms: No `onChange` prop passed to TaskDescriptionEditor in any file
9. Grep confirms: `clearDescription` called in useTaskDetail.ts migration effect
</verification>

<success_criteria>
- Task description editing uses Yjs collaborative sync (no debounced Convex saves)
- Multiple users see each other's cursors and edits in real-time in task descriptions
- ActiveUsers avatar stack appears in both TaskDetailSheet and TaskDetailPage
- ConnectionStatus indicator (green dot / syncing / offline) appears in both views
- Existing task descriptions migrate from Convex JSON to Yjs on first editor load
- After migration, Convex description field is cleared (single source of truth is Yjs)
- Tasks with no description work correctly (empty editor, no migration attempt)
- No regressions in document or diagram collaboration
</success_criteria>

<output>
After completion, create `.planning/phases/13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks/13.2-02-SUMMARY.md`
</output>
