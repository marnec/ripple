---
phase: 13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks
plan: 02
subsystem: collaboration
tags: [yjs, partykit, blocknote, collaboration, tasks, ui, migration]

# Dependency graph
requires:
  - phase: 13.2-01
    provides: "Task resource type in collaboration token system, parameterized useDocumentCollaboration hook"
  - phase: 12-document-multiplayer-cursors-yjs-migration
    provides: "ActiveUsers, ConnectionStatus components, collaboration UI patterns"
provides:
  - "Collaborative task description editing with Yjs"
  - "Client-side migration from Convex description to Yjs"
  - "Collaboration UI (ActiveUsers, ConnectionStatus) in task views"
affects: [tasks, task-detail-ui, project-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Client-side migration pattern: check Yjs empty + Convex has data → migrate → clear Convex"
    - "Migration guard: migrationDoneRef prevents duplicate migrations on re-renders"
    - "Loading state pattern: null editor during Yjs provider connection"

key-files:
  created: []
  modified:
    - src/pages/App/Project/useTaskDetail.ts
    - src/pages/App/Project/TaskDescriptionEditor.tsx
    - src/pages/App/Project/TaskDetailSheet.tsx
    - src/pages/App/Project/TaskDetailPage.tsx

key-decisions:
  - "Client-side migration triggered on first editor load (not backend migration script)"
  - "Migration checks Yjs emptiness via document length/content analysis"
  - "clearDescription mutation called after successful migration (single source of truth)"
  - "TaskDescriptionEditor shows loading placeholder when editor is null"
  - "Absolute imports (@/pages, @/lib) used for cross-directory components"

patterns-established:
  - "Yjs migration pattern: check empty → parse Convex JSON → replaceBlocks → clear Convex"
  - "Collaboration UI positioning: Sheet (absolute top-right), Page (dedicated section)"
  - "No onChange prop for Yjs-backed editors (automatic sync)"

# Metrics
duration: 5min
completed: 2026-02-12
---

# Phase 13.2 Plan 02: Task Collaborative Editing UI Summary

**Yjs-based collaborative task description editing with client-side migration and full collaboration UI (ActiveUsers, ConnectionStatus) in both sheet and page views**

## Performance

- **Duration:** 5 minutes
- **Started:** 2026-02-12T13:20:12Z
- **Completed:** 2026-02-12T13:25:13Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Task descriptions now use Yjs collaborative editing (replacing debounced Convex auto-save)
- Client-side migration from Convex description JSON to Yjs on first editor load
- ActiveUsers avatar stack and ConnectionStatus indicator in both TaskDetailSheet and TaskDetailPage
- Loading state handling for editor during Yjs provider connection
- Multiple users can now see each other's cursors and edits in real-time in task descriptions

## Task Commits

Each task was committed atomically:

1. **Task 1: Rewrite useTaskDetail for collaborative editing and update TaskDescriptionEditor** - `9738875` (feat)
2. **Task 2: Add collaboration UI to TaskDetailSheet and TaskDetailPage** - `f347494` (feat)

## Files Created/Modified

- `src/pages/App/Project/useTaskDetail.ts` - Replaced useCreateBlockNote with useDocumentCollaboration, removed debounced auto-save, added client-side migration with clearDescription call
- `src/pages/App/Project/TaskDescriptionEditor.tsx` - Removed onChange prop, added null editor loading placeholder
- `src/pages/App/Project/TaskDetailSheet.tsx` - Added ActiveUsers and ConnectionStatus, removed resetEditor useEffect, removed onChange from TaskDescriptionEditor
- `src/pages/App/Project/TaskDetailPage.tsx` - Added ActiveUsers and ConnectionStatus collaboration indicators, removed onChange from TaskDescriptionEditor

## Decisions Made

- **Client-side migration over backend migration**: Migration happens on first editor load in the client. Checks if Yjs document is empty and Convex has description, then migrates. This avoids a one-time backend migration script and handles tasks incrementally as users access them.
- **Migration emptiness check**: Yjs document is considered empty if it has zero blocks or one empty paragraph block. This prevents overwriting existing Yjs content.
- **clearDescription after migration**: Once Yjs has the content, Convex description field is cleared via clearDescription mutation. Yjs becomes the single source of truth.
- **Loading placeholder for null editor**: TaskDescriptionEditor shows a skeleton loader when editor is null (during Yjs provider connection). Prevents rendering BlockNoteView with undefined editor.
- **Absolute imports for collaboration components**: Used @/pages and @/lib aliases instead of relative paths (../../Document) for cleaner imports and better IDE support.

## Deviations from Plan

None - plan executed exactly as written. All tasks completed successfully with no auto-fixes or architectural changes needed.

## Issues Encountered

None - plan execution was smooth. Lint and build passed on first try after Task 2 completion.

## User Setup Required

None - no external service configuration required. Migration happens automatically when users open tasks with existing descriptions.

## Next Phase Readiness

- Task collaboration feature is now complete (Phase 13.2 finished)
- Task descriptions have real-time collaborative editing matching documents and diagrams
- All collaboration infrastructure (PartyKit, Yjs, token system) fully supports doc/diagram/task resource types
- Ready for next roadmap phases

## Self-Check

Verifying files and commits exist:

- [x] src/pages/App/Project/useTaskDetail.ts modified (no handleDescriptionChange, no descriptionTimeoutRef)
- [x] src/pages/App/Project/useTaskDetail.ts imports useDocumentCollaboration
- [x] src/pages/App/Project/useTaskDetail.ts has resourceType: "task"
- [x] src/pages/App/Project/useTaskDetail.ts calls clearDescription in migration effect
- [x] src/pages/App/Project/TaskDescriptionEditor.tsx has no onChange prop in type definition
- [x] src/pages/App/Project/TaskDescriptionEditor.tsx has loading placeholder for null editor
- [x] src/pages/App/Project/TaskDetailSheet.tsx imports ActiveUsers and ConnectionStatus
- [x] src/pages/App/Project/TaskDetailSheet.tsx removed resetEditor useEffect
- [x] src/pages/App/Project/TaskDetailSheet.tsx does not pass onChange to TaskDescriptionEditor
- [x] src/pages/App/Project/TaskDetailPage.tsx imports ActiveUsers and ConnectionStatus
- [x] src/pages/App/Project/TaskDetailPage.tsx does not pass onChange to TaskDescriptionEditor
- [x] Commit 9738875 exists (Task 1)
- [x] Commit f347494 exists (Task 2)
- [x] npm run lint passes with 0 errors, 0 warnings
- [x] npm run build succeeds

**Self-Check: PASSED**

---
*Phase: 13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks*
*Completed: 2026-02-12*
