---
phase: 13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks
plan: 01
subsystem: collaboration
tags: [yjs, partykit, blocknote, collaboration, tasks, indexeddb]

# Dependency graph
requires:
  - phase: 12-document-multiplayer-cursors-yjs-migration
    provides: "useDocumentCollaboration hook, Yjs integration, IndexedDB persistence"
  - phase: 11-partykit-infrastructure-persistence
    provides: "PartyKit server, collaboration token system"
provides:
  - "Task resource type in collaboration token system"
  - "Parameterized useDocumentCollaboration hook (resourceType)"
  - "clearDescription mutation for task migration"
  - "Resource-prefixed IndexedDB cache keys (task-{id}, doc-{id})"
affects: [13.2-02, tasks, task-detail-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Resource type pattern: collaboration system now supports doc/diagram/task"
    - "Project membership pattern: task access via projectMembers.by_project_user"
    - "Cache key prefix pattern: IndexedDB keys use resourceType prefix to prevent collisions"

key-files:
  created:
    - src/hooks/use-pending-invites.ts
  modified:
    - convex/collaboration.ts
    - convex/tasks.ts
    - src/hooks/use-yjs-provider.ts
    - src/hooks/use-document-collaboration.ts

key-decisions:
  - "Task collaboration validates project membership (not direct task members)"
  - "useDocumentCollaboration defaults resourceType to 'doc' for backward compatibility"
  - "IndexedDB cache keys use resource type prefix to prevent cross-resource collisions"

patterns-established:
  - "checkTaskAccess pattern: validate task access via project membership"
  - "Resource type extension: adding new resource type requires token generation + access check"

# Metrics
duration: 4min
completed: 2026-02-12
---

# Phase 13.2 Plan 01: Task Collaboration Backend Summary

**Task resource type added to collaboration token system with project-based access validation and parameterized useDocumentCollaboration hook**

## Performance

- **Duration:** 4 minutes
- **Started:** 2026-02-12T13:13:19Z
- **Completed:** 2026-02-12T13:17:49Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments
- Task resource type added to collaboration token system with project membership validation
- useDocumentCollaboration hook generalized with resourceType parameter (defaults to "doc")
- IndexedDB cache keys now use resource type prefix (task-{id}, doc-{id}) to prevent collisions
- clearDescription mutation added for post-migration Convex cleanup

## Task Commits

Each task was committed atomically:

1. **Task 1: Add task resource type to collaboration system** - `d6bb279` (feat)
2. **Task 2: Parameterize useDocumentCollaboration for task reuse** - `934786e` (feat)

## Files Created/Modified
- `convex/collaboration.ts` - Added v.literal("task") to resourceType union, added checkTaskAccess internal query
- `convex/tasks.ts` - Added clearDescription mutation for post-migration cleanup
- `src/hooks/use-yjs-provider.ts` - Updated ResourceType to include "task"
- `src/hooks/use-document-collaboration.ts` - Added resourceType parameter (defaults to "doc"), updated IndexedDB cache key prefix
- `src/hooks/use-pending-invites.ts` - Created to fix pre-existing react-refresh warning
- `src/pages/App/UserMenu.tsx` - Updated import path for usePendingInvites
- `src/pages/App/Workspace/PendingInvites.tsx` - Moved usePendingInvites to separate file
- `src/sw.ts` - Fixed pre-existing floating promise warning

## Decisions Made
- **Task access validation via project membership**: Tasks don't have direct member tables like documents/diagrams. Access is validated by checking project membership via projectMembers.by_project_user index.
- **Backward compatible resourceType default**: useDocumentCollaboration defaults resourceType to "doc" so existing DocumentEditor.tsx usage requires no changes.
- **Resource-prefixed IndexedDB keys**: Cache keys use `${resourceType}-${resourceId}` pattern (task-123, doc-456) to prevent cross-resource collisions in IndexedDB.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed service worker floating promise warning**
- **Found during:** Task 1 (lint verification)
- **Issue:** src/sw.ts line 14 had floating promise for self.skipWaiting() call
- **Fix:** Added void operator: `void self.skipWaiting();`
- **Files modified:** src/sw.ts
- **Verification:** npm run lint passes with 0 errors
- **Committed in:** d6bb279 (Task 1 commit)

**2. [Rule 1 - Bug] Fixed react-refresh ESLint warning in PendingInvites.tsx**
- **Found during:** Task 1 (lint verification)
- **Issue:** PendingInvites.tsx exported both a hook and a component, causing react-refresh warning (max warnings = 0)
- **Fix:** Moved usePendingInvites to new file src/hooks/use-pending-invites.ts, updated imports in UserMenu.tsx and PendingInvites.tsx
- **Files modified:** src/hooks/use-pending-invites.ts (created), src/pages/App/UserMenu.tsx, src/pages/App/Workspace/PendingInvites.tsx
- **Verification:** npm run lint passes with 0 warnings
- **Committed in:** d6bb279 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Pre-existing lint errors blocking verification. Auto-fixes required for correctness. No scope creep.

## Issues Encountered
None - plan executed smoothly after fixing pre-existing lint blockers.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Backend collaboration infrastructure ready for task description editor
- Plan 02 can now wire useDocumentCollaboration into TaskDetailSheet with resourceType="task"
- clearDescription mutation available for client-side migration after Yjs content is persisted

## Self-Check

Verifying files and commits exist:

- [x] convex/collaboration.ts contains v.literal("task")
- [x] convex/collaboration.ts contains checkTaskAccess internal query
- [x] convex/tasks.ts contains clearDescription mutation
- [x] src/hooks/use-yjs-provider.ts contains "task" in ResourceType
- [x] src/hooks/use-document-collaboration.ts contains resourceType parameter
- [x] Commit d6bb279 exists
- [x] Commit 934786e exists

**Self-Check: PASSED**

---
*Phase: 13.2-add-document-like-collaboration-to-the-blocknote-editor-in-tasks*
*Completed: 2026-02-12*
