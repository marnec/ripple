---
phase: 05-document-diagram-embeds
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx
  - src/pages/App/Project/CustomInlineContent/DocumentLink.tsx
  - src/pages/App/Project/CustomInlineContent/UserMention.tsx
  - src/pages/App/Project/CustomInlineContent/ProjectReference.tsx
  - src/pages/App/Project/taskDescriptionSchema.ts
autonomous: true

must_haves:
  truths:
    - "Four custom inline content types exist: diagramEmbed, documentLink, userMention, projectReference"
    - "A shared task description schema combines default specs with all four inline content types"
    - "DiagramEmbed renders read-only SVG preview using exportToSvg (not interactive Excalidraw)"
    - "DocumentLink queries fresh document data by ID and renders styled link with icon"
    - "UserMention queries fresh user data by ID and renders bold text (no chip)"
    - "ProjectReference queries fresh project data by ID and renders colored chip with dot"
    - "Deleted/inaccessible entities degrade gracefully with greyed-out labels"
  artifacts:
    - path: "src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx"
      provides: "Diagram embed inline content spec with SVG preview"
    - path: "src/pages/App/Project/CustomInlineContent/DocumentLink.tsx"
      provides: "Document link inline content spec with icon and title"
    - path: "src/pages/App/Project/CustomInlineContent/UserMention.tsx"
      provides: "User mention inline content spec with bold text"
    - path: "src/pages/App/Project/CustomInlineContent/ProjectReference.tsx"
      provides: "Project reference inline content spec with colored chip"
    - path: "src/pages/App/Project/taskDescriptionSchema.ts"
      provides: "Shared BlockNote schema for task descriptions"
  key_links:
    - from: "src/pages/App/Project/taskDescriptionSchema.ts"
      to: "All four inline content specs"
      via: "imports and BlockNoteSchema.create"
      pattern: "inlineContentSpecs.*diagramEmbed.*documentLink.*userMention.*projectReference"
---

<objective>
Create the four custom inline content types (diagramEmbed, documentLink, userMention, projectReference) and a shared task description schema that both TaskDetailSheet and TaskDetailPage will use.

Purpose: This is the foundation for all Phase 5 features. The inline content specs define how each reference type renders in the editor, and the shared schema ensures consistency between the sheet and full-page views.

Output: Five new files — four inline content components and one shared schema module.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-document-diagram-embeds/05-CONTEXT.md
@.planning/phases/05-document-diagram-embeds/05-RESEARCH.md

# Key existing files to reference:
@src/pages/App/Chat/CustomInlineContent/TaskMention.tsx
@src/pages/App/Document/CustomBlocks/DiagramBlock.tsx
@src/pages/App/Document/CustomBlocks/UserBlock.tsx
@src/pages/App/Chat/TaskMentionChip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create four custom inline content types</name>
  <files>
    src/pages/App/Project/CustomInlineContent/DiagramEmbed.tsx
    src/pages/App/Project/CustomInlineContent/DocumentLink.tsx
    src/pages/App/Project/CustomInlineContent/UserMention.tsx
    src/pages/App/Project/CustomInlineContent/ProjectReference.tsx
  </files>
  <action>
Create a `CustomInlineContent/` directory inside `src/pages/App/Project/` (parallel to Chat's CustomInlineContent).

**DiagramEmbed.tsx** — `createReactInlineContentSpec` with type "diagramEmbed":
- Props: `diagramId: { default: "" as unknown as string }` (store only ID, query fresh data)
- Render component queries `api.diagrams.get` by diagramId
- Reuse the `DiagramView` rendering pattern from `src/pages/App/Document/CustomBlocks/DiagramBlock.tsx`:
  - Parse diagram.content JSON, filter deleted elements, call `exportToSvg`, render sanitized SVG
  - Use `useSanitize()` hook, `useTheme()` for dark mode
- Render as block-level div (NOT inline span) — diagram previews need visual space
  - Wrap in `<div className="my-2 border rounded-lg p-2 cursor-pointer hover:bg-muted/50 transition-colors" contentEditable={false}>`
  - Click handler navigates to diagram page: `/workspaces/${workspaceId}/diagrams/${diagramId}` using `useNavigate()` and `useParams()` to get workspaceId
  - Max height: `h-40` with overflow hidden for consistent sizing
- **Read-only**: No resize handles, no interactive Excalidraw (just SVG)
- **Deleted state**: If diagram query returns null, show greyed-out label: `<span className="text-muted-foreground italic">#deleted-diagram</span>`
- **Loading state**: Show `<Skeleton className="h-20 w-full" />`
- **Empty diagram state**: Show muted text "Empty diagram"

**DocumentLink.tsx** — `createReactInlineContentSpec` with type "documentLink":
- Props: `documentId: { default: "" as unknown as string }` (ID only, query fresh data)
- Render component queries `api.documents.get` by documentId
- Display: Inline span with `FileText` icon from lucide-react + document title
  - `<span className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-muted text-sm font-medium cursor-pointer hover:bg-muted/80 transition-colors align-middle">`
  - `<FileText className="h-3.5 w-3.5 shrink-0" />`
  - `<span className="max-w-[200px] truncate">{document.name}</span>`
- Click navigates to: `/workspaces/${workspaceId}/documents/${documentId}`
- **Deleted state**: Grey text `#deleted-document` with muted styling (same pattern as TaskMentionChip)
- **Loading state**: Skeleton inline `h-5 w-24 rounded`

**UserMention.tsx** — `createReactInlineContentSpec` with type "userMention":
- Props: `userId: { default: "" as unknown as string }` (ID only)
- Render component queries `api.users.get` by userId
- Display: **Bold clickable text** (per user decision — NO background chip, NO avatar)
  - `<span className="font-bold text-foreground align-middle">@{user.name}</span>`
  - Click action: None (display only, per user decision)
- **Deleted/removed state**: Grey text `@unknown-user` with `text-muted-foreground` class
- **Loading state**: Skeleton inline `h-5 w-16 rounded`
- Note: This is different from UserBlock.tsx in DocumentEditor which shows avatar+chip. Task description @mentions are intentionally lighter per user decision.

**ProjectReference.tsx** — `createReactInlineContentSpec` with type "projectReference":
- Props: `projectId: { default: "" as unknown as string }` (ID only)
- Render component queries `api.projects.get` by projectId
- Display: Inline colored chip with project color dot and name
  - `<span className="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-muted text-sm font-medium cursor-pointer hover:bg-muted/80 transition-colors align-middle">`
  - `<span className={cn("h-2 w-2 rounded-full shrink-0", project.color)} />`
  - `<span className="max-w-[200px] truncate">{project.name}</span>`
- Click navigates to: `/workspaces/${workspaceId}/projects/${projectId}`
- **Inaccessible/deleted state**: Grey chip, no link: `<span className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-background/60 text-muted-foreground text-sm align-middle">#inaccessible-project</span>`
- **Loading state**: Skeleton inline `h-5 w-24 rounded-full`

Important: All four components must use `contentEditable={false}` on their root wrapper to prevent BlockNote from treating them as editable text. Follow the same `as const` pattern used by TaskMention.tsx for the spec config.
  </action>
  <verify>
Run `npm run lint` — all four files should pass TypeScript and ESLint with zero warnings.
Verify each file exports a named const that is a valid BlockNote inline content spec.
  </verify>
  <done>
Four inline content type files exist in `src/pages/App/Project/CustomInlineContent/`, each exporting a `createReactInlineContentSpec` result with correct propSchema, render component, deleted/loading states, and navigation handlers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared task description schema</name>
  <files>
    src/pages/App/Project/taskDescriptionSchema.ts
  </files>
  <action>
Create `src/pages/App/Project/taskDescriptionSchema.ts` that exports a shared BlockNote schema for task descriptions.

Pattern: Follow `MessageComposer.tsx` schema creation pattern.

```typescript
import { BlockNoteSchema, defaultBlockSpecs, defaultInlineContentSpecs } from "@blocknote/core";
import { DiagramEmbed } from "./CustomInlineContent/DiagramEmbed";
import { DocumentLink } from "./CustomInlineContent/DocumentLink";
import { UserMention } from "./CustomInlineContent/UserMention";
import { ProjectReference } from "./CustomInlineContent/ProjectReference";

// Remove audio, image, heading blocks (same as MessageComposer) — no, actually KEEP them.
// Task descriptions are richer than chat messages. Keep all default block specs.
export const taskDescriptionSchema = BlockNoteSchema.create({
  blockSpecs: {
    ...defaultBlockSpecs,
  },
  inlineContentSpecs: {
    ...defaultInlineContentSpecs,
    diagramEmbed: DiagramEmbed,
    documentLink: DocumentLink,
    userMention: UserMention,
    projectReference: ProjectReference,
  },
});

export type TaskDescriptionEditor = typeof taskDescriptionSchema extends BlockNoteSchema<infer B, infer I> ?
  BlockNoteEditor<B, I> : never;
```

Wait — the type export needs correct import. Let the executor figure out the exact generic type. The key point:
- Export `taskDescriptionSchema` as the schema constant
- Export a type alias for the editor type based on the schema (for consumers that need to type the editor)
- Keep ALL default block specs (task descriptions can have headings, images, etc.)
- Add all four custom inline content specs

This schema will be used by:
1. TaskDetailSheet (Plan 02)
2. TaskDetailPage (Plan 02)
  </action>
  <verify>
Run `npm run lint` — file should pass with zero warnings.
Verify the schema exports are importable by checking: `grep -r "taskDescriptionSchema" src/` shows the file exists.
  </verify>
  <done>
`taskDescriptionSchema.ts` exports a `taskDescriptionSchema` constant with all four custom inline content types registered alongside default specs. The schema is ready to be consumed by TaskDetailSheet and TaskDetailPage.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. All five new files exist in expected locations
3. Each inline content spec has: type name, propSchema with ID field, render function with deleted/loading states
4. Schema correctly includes all four inline content types
5. No existing files were modified (this plan only creates new files)
</verification>

<success_criteria>
- Four inline content types compile and export valid BlockNote specs
- Shared schema combines all four with default specs
- DiagramEmbed uses exportToSvg for read-only preview (not interactive Excalidraw)
- DocumentLink shows FileText icon + title with navigation
- UserMention shows bold text only (no avatar, no chip)
- ProjectReference shows colored chip with project dot
- All four handle deleted/null entity gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/05-document-diagram-embeds/05-01-SUMMARY.md`
</output>
