---
phase: 05-document-diagram-embeds
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/App/Chat/MessageComposer.tsx
  - src/pages/App/Chat/MessageRenderer.tsx
  - src/pages/App/Chat/ProjectReferenceChip.tsx
autonomous: true

must_haves:
  truths:
    - "User can type # in chat to see both task mentions AND project references in combined autocomplete"
    - "Project references in sent messages render as colored chips with project dot and name"
    - "Clicking a project reference chip in a sent message navigates to the project page"
    - "Inaccessible/deleted projects show greyed-out chip"
    - "Existing task mention # autocomplete continues to work alongside project references"
  artifacts:
    - path: "src/pages/App/Chat/ProjectReferenceChip.tsx"
      provides: "Live project reference chip for rendered messages"
    - path: "src/pages/App/Chat/MessageComposer.tsx"
      provides: "Updated composer with projectReference inline content and combined # autocomplete"
    - path: "src/pages/App/Chat/MessageRenderer.tsx"
      provides: "Updated renderer with projectReference support"
  key_links:
    - from: "src/pages/App/Chat/MessageComposer.tsx"
      to: "ProjectReference inline content spec"
      via: "schema inlineContentSpecs"
      pattern: "projectReference.*ProjectReference"
    - from: "src/pages/App/Chat/MessageRenderer.tsx"
      to: "src/pages/App/Chat/ProjectReferenceChip.tsx"
      via: "InlineRenderer case"
      pattern: "case.*projectReference.*ProjectReferenceChip"
---

<objective>
Add project reference support to chat messages. The `#` autocomplete in MessageComposer already handles task mentions — extend it to also show projects. Create a ProjectReferenceChip for rendering project references in sent messages.

Purpose: Users can reference projects from any channel's chat, creating cross-references between conversations and projects.

Output: One new file (ProjectReferenceChip.tsx), two modified files (MessageComposer.tsx, MessageRenderer.tsx).
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-document-diagram-embeds/05-CONTEXT.md
@.planning/phases/05-document-diagram-embeds/05-RESEARCH.md
@.planning/phases/05-document-diagram-embeds/05-01-SUMMARY.md

# Key files to reference:
@src/pages/App/Chat/MessageComposer.tsx
@src/pages/App/Chat/MessageRenderer.tsx
@src/pages/App/Chat/TaskMentionChip.tsx
@src/pages/App/Chat/CustomInlineContent/TaskMention.tsx
@src/pages/App/Project/CustomInlineContent/ProjectReference.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add projectReference to MessageComposer schema and combined # autocomplete</name>
  <files>
    src/pages/App/Chat/MessageComposer.tsx
  </files>
  <action>
Extend MessageComposer to support project references alongside existing task mentions.

**1. Import the ProjectReference inline content spec:**
- Import `ProjectReference` from `../Project/CustomInlineContent/ProjectReference`
  - OR create a simpler chat-specific version. Since the ProjectReference from Plan 01 uses useNavigate/useParams which work in any React Router context, reuse it directly.

**2. Add ProjectReference to the schema:**
```typescript
const schema = BlockNoteSchema.create({
  blockSpecs: { ...remainingBlockSpecs },
  inlineContentSpecs: {
    ...defaultInlineContentSpecs,
    taskMention: TaskMention,
    projectReference: ProjectReference,
  },
});
```

**3. Extend the # SuggestionMenuController to include projects:**
The existing `#` getItems only returns task mentions. Extend it to ALSO return projects.

```typescript
<SuggestionMenuController
  triggerCharacter={"#"}
  getItems={async (query) => {
    const items: Array<{title: string; onItemClick: () => void; icon: React.ReactNode; group: string; key: string}> = [];

    // Task mentions (existing logic)
    const tasksToSearch = linkedProject ? projectTasks : myTasks;
    if (tasksToSearch) {
      tasksToSearch
        .filter((task) => task.title.toLowerCase().includes(query.toLowerCase()))
        .slice(0, 7)
        .forEach((task) => {
          items.push({
            title: task.title,
            onItemClick: () => {
              editor.insertInlineContent([
                { type: "taskMention", props: { taskId: task._id, taskTitle: task.title } },
                " ",
              ]);
            },
            icon: <div className={cn("h-3 w-3 rounded-full", task.status?.color || "bg-gray-500")} />,
            group: linkedProject ? "Project tasks" : "My tasks",
            key: task._id,
          });
        });
    }

    // Project references (NEW)
    if (projects) {
      projects
        .filter((p) => p.name.toLowerCase().includes(query.toLowerCase()))
        .slice(0, 5)
        .forEach((p) => {
          items.push({
            title: p.name,
            onItemClick: () => {
              editor.insertInlineContent([
                { type: "projectReference", props: { projectId: p._id } },
                " ",
              ]);
            },
            icon: <FolderKanban className="h-4 w-4" />,
            group: "Projects",
            key: `proj-${p._id}`,
          });
        });
    }

    return items;
  }}
/>
```

**4. Add FolderKanban import:** from `lucide-react`

**5. Adjust task results limit:** Reduce task results from 10 to 7 so combined list stays reasonable (7 tasks + 5 projects = 12 max items).

**Note:** The `projects` query is already available in MessageComposer (used for linkedProject detection). No new queries needed.
  </action>
  <verify>
1. `npm run lint` passes with zero warnings
2. Open a chat channel and type `#` — should see both task mentions AND project references in grouped autocomplete
3. Select a project — should insert a project reference chip in the editor
4. Select a task — should still insert task mention (existing behavior preserved)
  </verify>
  <done>
MessageComposer schema includes `projectReference` inline content type. The `#` autocomplete shows both task mentions (grouped by project/my tasks) and project references (grouped as "Projects"). Existing task mention behavior is fully preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProjectReferenceChip and update MessageRenderer</name>
  <files>
    src/pages/App/Chat/ProjectReferenceChip.tsx
    src/pages/App/Chat/MessageRenderer.tsx
  </files>
  <action>
**ProjectReferenceChip.tsx** — Create a live rendering component for project references in sent messages (parallel to TaskMentionChip.tsx):

```typescript
import { useQuery } from "convex/react";
import { useNavigate, useParams } from "react-router-dom";
import { cn } from "@/lib/utils";
import { api } from "../../../../convex/_generated/api";
import { Id } from "../../../../convex/_generated/dataModel";

type ProjectReferenceChipProps = {
  projectId: string;
};

export function ProjectReferenceChip({ projectId }: ProjectReferenceChipProps) {
  const project = useQuery(api.projects.get, {
    projectId: projectId as Id<"projects">,
  });
  const navigate = useNavigate();
  const { workspaceId } = useParams();

  // Inaccessible or deleted
  if (!project) {
    return (
      <span className="inline-flex items-center gap-1 px-1.5 py-0.5
                       rounded-full bg-background/60 text-muted-foreground
                       text-sm align-middle">
        #inaccessible-project
      </span>
    );
  }

  const handleClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    void navigate(`/workspaces/${workspaceId}/projects/${project._id}`);
  };

  return (
    <button
      onClick={handleClick}
      className="inline-flex items-center gap-1.5 px-2 py-0.5
                 rounded-full bg-background/60 hover:bg-background/80
                 transition-colors cursor-pointer text-sm font-medium align-middle"
    >
      <span className={cn("h-2 w-2 rounded-full shrink-0", project.color)} />
      <span className="max-w-[200px] truncate">{project.name}</span>
    </button>
  );
}
```

Follow the exact same pattern as TaskMentionChip.tsx — live query for fresh data, useNavigate for click handler, deleted state handling.

**MessageRenderer.tsx** — Add `projectReference` support:

1. Add type for project reference inline content:
```typescript
type ProjectReferenceContent = {
  type: "projectReference";
  props: { projectId: string };
};
```

2. Update `InlineContent` union type:
```typescript
type InlineContent = TextContent | LinkContent | TaskMentionContent | ProjectReferenceContent;
```

3. Add case in `InlineRenderer`:
```typescript
case "projectReference":
  return <ProjectReferenceChip projectId={content.props.projectId} />;
```

4. Add import: `import { ProjectReferenceChip } from "./ProjectReferenceChip";`
  </action>
  <verify>
1. `npm run lint` passes with zero warnings
2. Send a message containing a project reference via `#` autocomplete
3. The sent message should render the project reference as a colored chip with project dot and name
4. Click the chip — should navigate to the project page
5. Existing task mention chips still render correctly in messages
  </verify>
  <done>
ProjectReferenceChip renders live project data with color dot, name, and click-to-navigate. MessageRenderer handles both `taskMention` and `projectReference` inline content types. Project references in sent messages show as interactive chips.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. MessageComposer schema includes both `taskMention` and `projectReference`
3. `#` autocomplete in chat shows both tasks and projects in separate groups
4. Sent messages with project references render as colored chips
5. Clicking project chip navigates to project page
6. Existing task mention behavior is fully preserved
7. Deleted/inaccessible projects show greyed-out chip
</verification>

<success_criteria>
- `#` autocomplete in chat combines task mentions and project references
- Project references render as colored chips in sent messages via ProjectReferenceChip
- Click on project chip navigates to project page
- Existing task mention autocomplete and rendering still works
- MessageRenderer handles both inline content types
- Inaccessible projects degrade gracefully with grey chip
</success_criteria>

<output>
After completion, create `.planning/phases/05-document-diagram-embeds/05-03-SUMMARY.md`
</output>
