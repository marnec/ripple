---
phase: 08-emoji-reactions-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/pages/App/Chat/MessageReactions.tsx
  - src/pages/App/Chat/MessageReactionPicker.tsx
  - src/pages/App/Chat/MessageReactionPill.tsx
  - src/pages/App/Chat/Message.tsx
autonomous: true

must_haves:
  truths:
    - "User can click emoji picker button on any message to open picker and select a reaction"
    - "Reactions display as aggregated pills below message showing native emoji and count"
    - "User can click an existing reaction pill to toggle their own reaction on/off"
    - "Pill is visually highlighted (blue background/border) when current user has reacted"
    - "Hovering a reaction pill shows tooltip listing user names who reacted"
    - "Multiple different emoji reactions display correctly on the same message"
    - "Reactions update in real-time across connected clients via Convex reactivity"
  artifacts:
    - path: "src/pages/App/Chat/MessageReactions.tsx"
      provides: "Container component for reaction pills + picker below message"
      min_lines: 20
    - path: "src/pages/App/Chat/MessageReactionPicker.tsx"
      provides: "Emoji picker popover with lazy-loaded emoji-picker-react"
      min_lines: 25
    - path: "src/pages/App/Chat/MessageReactionPill.tsx"
      provides: "Individual reaction pill button with tooltip"
      min_lines: 20
    - path: "src/pages/App/Chat/Message.tsx"
      provides: "Message component with MessageReactions integrated below bubble"
      contains: "MessageReactions"
  key_links:
    - from: "src/pages/App/Chat/MessageReactions.tsx"
      to: "convex/messageReactions.ts"
      via: "useQuery(api.messageReactions.listForMessage)"
      pattern: "useQuery.*messageReactions"
    - from: "src/pages/App/Chat/MessageReactionPicker.tsx"
      to: "convex/messageReactions.ts"
      via: "useMutation(api.messageReactions.toggle)"
      pattern: "useMutation.*messageReactions"
    - from: "src/pages/App/Chat/MessageReactionPill.tsx"
      to: "convex/messageReactions.ts"
      via: "useMutation(api.messageReactions.toggle)"
      pattern: "useMutation.*messageReactions"
    - from: "src/pages/App/Chat/Message.tsx"
      to: "src/pages/App/Chat/MessageReactions.tsx"
      via: "Component render below message bubble"
      pattern: "<MessageReactions"
---

<objective>
Build the complete frontend for emoji reactions: install emoji-picker-react, create reaction pill components with tooltips, integrate into Message.tsx, and wire up Convex reactive queries for real-time updates.

Purpose: Give users a visual, interactive way to react to messages with emoji — completing the full Slack-style reactions experience.
Output: Working reaction UI on every message with picker, pills, toggle, and tooltips.
</objective>

<execution_context>
@/home/lambda/.claude/get-shit-done/workflows/execute-plan.md
@/home/lambda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-emoji-reactions-foundation/08-RESEARCH.md
@.planning/phases/08-emoji-reactions-foundation/08-01-SUMMARY.md
@src/pages/App/Chat/Message.tsx
@src/pages/App/Chat/Chat.tsx
@convex/messageReactions.ts
@convex/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install emoji-picker-react and create reaction UI components</name>
  <files>
    src/pages/App/Chat/MessageReactionPicker.tsx
    src/pages/App/Chat/MessageReactionPill.tsx
    src/pages/App/Chat/MessageReactions.tsx
  </files>
  <action>
**Step 1: Install emoji-picker-react**
```bash
npm install emoji-picker-react
```

**Step 2: Create MessageReactionPicker.tsx**

Emoji picker inside a Radix Popover. Key implementation details:
- Import `EmojiPicker` via `React.lazy(() => import('emoji-picker-react'))` for code splitting
- Import `EmojiClickData` type from `emoji-picker-react` for the callback
- Use shadcn `Popover`/`PopoverTrigger`/`PopoverContent` from `@/components/ui/popover`
- Trigger button: ghost variant, small size, shows a smile icon (use `SmilePlus` from lucide-react)
- On emoji click: call `useMutation(api.messageReactions.toggle)` with `{ messageId, emoji: emojiData.unified, emojiNative: emojiData.emoji }`
- Close popover after selection
- Wrap `EmojiPicker` in `<Suspense fallback={<div className="w-[350px] h-[400px] flex items-center justify-center"><Loader2 className="animate-spin" /></div>}>`
- Pass `lazyLoadEmojis={true}`, `width={350}`, `height={400}`, `searchPlaceholder="Search emoji..."` to EmojiPicker
- Props: `{ messageId: Id<"messages"> }`

**Step 3: Create MessageReactionPill.tsx**

Individual reaction button with tooltip. Key implementation details:
- Props: `{ messageId: Id<"messages">, emoji: string, emojiNative: string, count: number, userIds: Id<"users">[], currentUserReacted: boolean, userMap: Record<Id<"users">, { name?: string; email?: string }> }`
- The `userMap` is passed from parent (batch-fetched) to avoid N+1 queries
- On click: call `useMutation(api.messageReactions.toggle)` with `{ messageId, emoji, emojiNative }`
- Styling: `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-sm border hover:bg-accent transition-colors cursor-pointer`
- When `currentUserReacted` is true: add `bg-blue-50 border-blue-300 dark:bg-blue-950 dark:border-blue-700` classes
- Content: `<span>{emojiNative}</span><span className="text-xs text-muted-foreground">{count}</span>`
- Wrap in shadcn `Tooltip`/`TooltipTrigger`/`TooltipContent` from `@/components/ui/tooltip`
- Tooltip content: show comma-separated names from userMap for each userId. Use `user.name ?? user.email ?? "Unknown"` pattern
- Use `cn()` from `@/lib/utils` for conditional class names

**Step 4: Create MessageReactions.tsx**

Container component that fetches and displays all reaction pills for a message. Key implementation details:
- Props: `{ messageId: Id<"messages"> }`
- Use `useQuery(api.messageReactions.listForMessage, { messageId })` to get aggregated reactions
- Use `useQuery(api.users.getByIds, { ids: allUserIds })` where `allUserIds` is the unique union of all `userIds` arrays from reactions — this batch-fetches all user data in a single query
- If reactions is undefined (loading) or empty array, only render the picker button (no pills)
- Render: `flex flex-wrap items-center gap-1 mt-1` container with:
  - Map over reactions → `<MessageReactionPill>` for each, passing `userMap` from the batch query
  - `<MessageReactionPicker>` at the end (always visible, allows adding new reactions)
- Wrap the entire component in `<TooltipProvider>` from shadcn so tooltips work for all pills
- The picker button should be small and subtle (ghost button, muted icon) to not overwhelm the message UI

Import Convex API:
```typescript
import { api } from "../../../../convex/_generated/api";
import { Id } from "../../../../convex/_generated/dataModel";
```
  </action>
  <verify>Run `npm run lint` — should pass with 0 warnings. Verify all three files exist and have correct imports.</verify>
  <done>Three new components created: MessageReactionPicker (lazy emoji picker in popover), MessageReactionPill (emoji+count button with tooltip), MessageReactions (container that fetches data and renders pills).</done>
</task>

<task type="auto">
  <name>Task 2: Integrate MessageReactions into Message.tsx</name>
  <files>src/pages/App/Chat/Message.tsx</files>
  <action>
Modify `Message.tsx` to render `<MessageReactions>` below each message bubble.

**Changes to Message.tsx:**

1. Import `MessageReactions` from `./MessageReactions`

2. Add `<MessageReactions messageId={message._id} />` inside the `<li>` element, AFTER the `<ContextMenuTrigger>` block (after the message bubble div), but still inside the `<li>`. This places reactions below the message bubble.

3. The placement should be:
```tsx
<li ref={messageRef} className={cn(...)}>
  <div className={cn("flex items-center gap-3", ...)}>
    {/* time + author header */}
  </div>
  <ContextMenuTrigger>
    <div className={cn("rounded-xl bg-muted px-3 py-2 transition-all", ...)}>
      <MessageRenderer blocks={blocks} />
    </div>
  </ContextMenuTrigger>
  <MessageReactions messageId={message._id} />
</li>
```

4. The reactions container should align with the message direction:
- If `userIsAuthor` (sent by current user): reactions align to the right (self-end)
- If not author: reactions align to the left (self-start)
- Pass no extra alignment props — the parent `<li>` already handles alignment with `items-end self-end` or `items-start self-start`, and the `flex flex-col` on the `<li>` will make children follow the same alignment.

No other files need modification. The Convex reactive queries in MessageReactions will automatically provide real-time updates to all connected clients.
  </action>
  <verify>
1. `npm run lint` passes with 0 warnings
2. `npm run build` succeeds
3. Verify Message.tsx imports MessageReactions and renders it below the message bubble
  </verify>
  <done>Every message in the chat displays a reactions area below the bubble. Users can open the emoji picker, select emoji, see pills with counts, click pills to toggle reactions, and hover pills to see who reacted. Reactions update in real-time via Convex subscriptions.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with 0 warnings
2. `npm run build` succeeds (no TypeScript errors)
3. emoji-picker-react is in package.json dependencies
4. MessageReactions.tsx uses useQuery for reactive data
5. MessageReactionPicker.tsx uses React.lazy for code splitting
6. MessageReactionPill.tsx shows tooltip with user names on hover
7. Message.tsx renders MessageReactions below the bubble
8. All six success criteria from the phase are addressed:
   - REACT-01: Emoji picker on any message ✓
   - REACT-02: Aggregated pills with emoji + count ✓
   - REACT-03: Click pill to toggle reaction ✓
   - REACT-04: Hover tooltip with user names ✓
   - REACT-05: Multiple emoji per message ✓
   - REACT-06: Real-time via Convex reactivity ✓
</verification>

<success_criteria>
- Emoji picker opens in popover, lazy-loaded for performance
- Reaction pills show native emoji character and count
- Current user's reactions are visually highlighted
- Clicking a pill toggles the reaction (add/remove)
- Hovering shows tooltip with user names
- Multiple emoji types display correctly per message
- Real-time: another user's reaction appears without refresh
</success_criteria>

<output>
After completion, create `.planning/phases/08-emoji-reactions-foundation/08-02-SUMMARY.md`
</output>
