# Requirements Archive: v0.11 Architectural Risk Mitigation

**Archived:** 2026-02-14
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Ripple v0.11 Architectural Risk Mitigation

**Defined:** 2026-02-12
**Core Value:** Seamless integration between all workspace features — users, documents, diagrams, and tasks can reference and embed each other, creating a connected workspace rather than isolated tools.

## v0.11 Requirements

### Persistence

- [ ] **PERSIST-01**: When the last user disconnects from a document, diagram, or task, the full Yjs state is flushed to Convex as a binary snapshot
- [ ] **PERSIST-02**: When a user opens a resource and PartyKit has no existing state, the system hydrates the Yjs document from the Convex snapshot
- [ ] **PERSIST-03**: User can recover document content from Convex backup if PartyKit state is lost (no data loss on server restart)

### Auth & Reconnection

- [ ] **AUTH-01**: When a WebSocket connection drops, the collaboration provider automatically reconnects with a fresh token without requiring page reload
- [ ] **AUTH-02**: PartyKit re-validates user membership against Convex periodically and terminates connections for users who no longer have access

### Operational Resilience

- [ ] **OPS-01**: When PartyKit is unavailable, editor components gracefully degrade to read-only mode rendering the last Convex snapshot
- [ ] **OPS-02**: Shared TypeScript type definitions exist for collaboration protocol between PartyKit server and frontend clients

## Previous Milestone Requirements (v0.10 — Complete)

### WebSocket Infrastructure

- [x] **INFRA-01**: PartyKit server deployed on Cloudflare with room-per-document isolation
- [x] **INFRA-02**: PartyKit authentication integrated with Convex user identity
- [x] **INFRA-03**: Yjs document state persisted via PartyKit snapshot mode (durable across restarts)
- [x] **INFRA-04**: Snapshot compaction prevents unbounded Yjs update history growth

### Document Cursors

- [x] **DCUR-01**: User can see other users' cursor positions in real-time in BlockNote documents
- [x] **DCUR-02**: User can see other users' text selection ranges highlighted with user color
- [x] **DCUR-03**: Each user's cursor displays a colored label with their display name
- [x] **DCUR-04**: Cursor updates feel instantaneous (sub-100ms latency target)

### Document Collaboration Migration

- [x] **DCOL-01**: BlockNote documents sync content via Yjs CRDTs (replacing ProseMirror Sync)
- [x] **DCOL-02**: Existing documents migrated from ProseMirror JSON to Yjs format
- [x] **DCOL-03**: Custom BlockNote inline content types (diagrams, documents, users, projects) work with Yjs sync
- [x] **DCOL-04**: Document content persists in Yjs binary format with Convex backup

### Diagram Multiplayer

- [x] **DIAG-01**: User can see other users' pointer positions in real-time in Excalidraw diagrams
- [x] **DIAG-02**: Each user's pointer displays a colored label with their display name
- [x] **DIAG-03**: Excalidraw element changes sync in real-time between users
- [x] **DIAG-04**: Existing diagrams remain compatible with new multiplayer infrastructure

### User Awareness

- [x] **AWARE-01**: User can see a list of active users currently in the same document
- [x] **AWARE-02**: User can see a list of active users currently in the same diagram
- [x] **AWARE-03**: User colors are consistent per user across all documents and diagrams

## Future Requirements

### v0.12+

- **DCUR-05**: Smooth cursor interpolation between position updates (perfect-cursors library)
- **DCUR-06**: Idle cursor dimming after 30 seconds of inactivity
- **DIAG-05**: Viewport following — click user avatar to jump to their viewport
- **DIAG-06**: Selection highlights showing what other users have selected
- **DCOL-05**: Offline editing support with automatic sync on reconnect
- **AWARE-04**: Cross-feature presence — see who's editing which document from workspace sidebar

## Out of Scope

| Feature | Reason |
|---------|--------|
| Periodic flush during editing | User chose snapshot-only on disconnect; periodic flush adds write load without proportional benefit |
| Active push revocation (Convex → PartyKit) | PartyKit pull-based re-validation is simpler and sufficient; push requires event infrastructure |
| Version history / audit trail | Snapshot backup is for recovery, not versioning; defer to dedicated history feature |
| Sync health monitoring dashboard | Ops visibility is valuable but not critical for risk mitigation; defer to ops milestone |
| Protocol versioning with migration | Shared types cover the type safety need; formal versioning is premature |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| OPS-02 | Phase 14 | Pending |
| PERSIST-01 | Phase 15 | Pending |
| PERSIST-02 | Phase 15 | Pending |
| PERSIST-03 | Phase 15 | Pending |
| AUTH-01 | Phase 16 | Pending |
| AUTH-02 | Phase 16 | Pending |
| OPS-01 | Phase 17 | Pending |

**Coverage:**
- v0.11 requirements: 7 total
- Mapped to phases: 7/7
- Unmapped: 0

---
*Requirements defined: 2026-02-12*
*Last updated: 2026-02-12 after roadmap creation*
